<!DOCTYPE html>
<html>
    <head>
        <title>RouterOS : Spanning Tree Protocol</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">RouterOS</a></span>
                            </li>
                                                    <li>
                                <span><a href="RouterOS_328059.html">RouterOS</a></span>
                            </li>
                                                    <li>
                                <span><a href="Bridging-and-Switching_328068.html">Bridging and Switching</a></span>
                            </li>
                                                    <li>
                                <span><a href="Bridging-and-Switching-Case-Studies_119144611.html">Bridging and Switching Case Studies</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            RouterOS : Spanning Tree Protocol
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
    
        
    
        
        
            Created by <span class='author'> Guntis G.</span>, last updated by <span class='editor'> Edgars P.</span> on Feb 25, 2025
    
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <p><style type='text/css'>/*<![CDATA[*/
div.rbtoc1747742025744 {padding: 0px;}
div.rbtoc1747742025744 ul {margin-left: 0px;}
div.rbtoc1747742025744 li {margin-left: 0px;padding-left: 0px;}

/*]]>*/</style><div class='toc-macro rbtoc1747742025744'>
<ul class='toc-indentation'>
<li><a href='#SpanningTreeProtocol-Summary'>Summary</a></li>
<li><a href='#SpanningTreeProtocol-Monitoring'>Monitoring</a></li>
<li><a href='#SpanningTreeProtocol-STPandRSTP'>STP and RSTP</a>
<ul class='toc-indentation'>
<li><a href='#SpanningTreeProtocol-Defaultvalues'>Default values</a></li>
<li><a href='#SpanningTreeProtocol-Electionprocess'>Election process</a></li>
<li><a href='#SpanningTreeProtocol-Examples'>Examples</a>
<ul class='toc-indentation'>
<li><a href='#SpanningTreeProtocol-Rootpathcostexample'>Root path cost example</a></li>
<li><a href='#SpanningTreeProtocol-STPexample'>STP example</a></li>
</ul>
</li>
</ul>
</li>
<li><a href='#SpanningTreeProtocol-MultipleSpanningTreeProtocol'>Multiple Spanning Tree Protocol</a>
<ul class='toc-indentation'>
<li><a href='#SpanningTreeProtocol-MSTPRegions'>MSTP Regions</a></li>
<li><a href='#SpanningTreeProtocol-Electionprocess.1'>Election process</a></li>
<li><a href='#SpanningTreeProtocol-MSTInstance'>MST Instance</a></li>
<li><a href='#SpanningTreeProtocol-MSTOverride'>MST Override</a></li>
<li><a href='#SpanningTreeProtocol-Monitoring.1'>Monitoring</a></li>
<li><a href='#SpanningTreeProtocol-MSTPexample'>MSTP example</a></li>
</ul>
</li>
</ul>
</div></p><h1 id="SpanningTreeProtocol-Summary">Summary</h1><hr/><p>The purpose of the spanning tree protocol is to provide the ability to create loop-free Layer 2 topologies while having redundant links. While connecting multiple bridges or just cross-connecting bridge ports, it's possible to create network loops that can severely impact the stability of the network. Spanning tree protocol aims to resolve this problem by introducing the concept of the root bridge, all bridges in the same Layer 2 domain will exchange information about the shortest path to the root bridge. Afterward, each bridge will negotiate which ports to use to reach the root bridge. This information exchange is done with the help of Bridge Protocol Data Units (BPDUs). STP will disable certain ports for each bridge to avoid loops, while still ensuring that all bridges can communicate with each other. For an in-depth description of protocol please refer to IEEE 802.1D.</p><p>As a best practice, it<span style="color:var(--ds-text,#333333);"><span> </span>is always recommended to manually set up each bridge's priority, port priority, and port path cost to ensure proper Layer2 functionality at all times. Leaving STP related values to defaults is acceptable for a network that consists of 1 to 2 bridges running with (R/M)STP enabled, but it is highly recommended to manually set these values for larger networks. Since STP elects a root bridge and root ports by checking STP related values from bridges over the network, then leaving STP settings to automatic may elect an undesired root bridge and root ports and in case of a hardware failure can result in an inaccessible network.</span></p><div role="region" aria-label="Info" class="confluence-information-macro  confluence-information-macro-information" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-info-filled confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p><span style="color:var(--ds-text,#333333);">RouterOS bridge does not work with PVST and its variants. The PVST BPDUs (with a MAC destination 01</span><span style="color:var(--ds-text,#333333);">:00:</span><span style="color:var(--ds-text,#333333);">0C</span><span style="color:var(--ds-text,#333333);">:CC:</span><span style="color:var(--ds-text,#333333);">CC:CD) are treated by RouterOS bridges as typical multicast packets. In simpler terms, they undergo RouterOS bridge/switch forwarding logic and may get tagged or untagged. </span></p></div></div><h1 id="SpanningTreeProtocol-Monitoring"><span style="color:var(--ds-text,#333333);">Monitoring</span></h1><hr/><p>You can check the STP status of a bridge by using the <code>/interface bridge monitor</code>  command, for example:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">interface/bridge/monitor bridge1
                    state: enabled                         
      current-mac-address: 74:4D:28:6F:31:10               
                bridge-id: 0x8000.74:4D:28:6F:31:10        
              root-bridge: no                              
           root-bridge-id: 0.74:4D:28:11:70:6B             
  regional-root-bridge-id: 0.74:4D:28:11:70:6B             
           root-path-cost: 0                               
                root-port: combo1                          
               port-count: 2                               
    designated-port-count: 0                               
        mst-config-digest: 4e22fbb9ede77faa45ec995c4ffa8085
             fast-forward: no                              
         multicast-router: yes                             
             igmp-querier: none                            
              mld-querier: none                            
        declared-vlan-ids: 1                               
      registered-vlan-ids: 1      </pre>
</div></div><p>Note that the root bridge doesn't have any root ports, only designated ports.</p><p><span style="color:var(--ds-text,#333333);">You can check the STP status of a bridge port by using the<span> </span></span><span style="color:var(--ds-icon-success,#22a06b);"><code>/interface bridge port monitor</code></span><span style="color:var(--ds-text,#333333);"><span> </span>command, for example:</span></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge port monitor [find interface=sfp-sfpplus2]
                  interface: combo1             
                     status: in-bridge          
                    port-id: 0x80.1             
                       role: root-port          
                  edge-port: no                 
        edge-port-discovery: yes                
        point-to-point-port: yes                
               external-fdb: no                 
               sending-rstp: yes                
                   learning: yes                
                 forwarding: yes                
           actual-path-cost: 2000               
    internal-root-path-cost: 2000               
       designated-bridge-id: 0.74:4D:28:11:70:6B
   designated-internal-cost: 0                  
         designated-port-id: 0x80.1             
  designated-remaining-hops: 20                 
                 bpdu-tx-rx: 3/7791             
        discard-transitions: 0                  
        forward-transitions: 1                  
                   tc-tx-rx: 2/2                
           topology-changes: 1                  
       last-topology-change: 4h19m43s           
           multicast-router: no                 
           hw-offload-group: switch1            
          declared-vlan-ids: 1                  
                             100                
        registered-vlan-ids: 1                  
                             100                
                             200-203     </pre>
</div></div><p>Note that<span> </span><span style="color:var(--ds-icon-success,#22a06b);"><code>root-bridge-id</code></span><span> </span>consists of the bridge priority and the bridge's MAC address, for non-root bridges the root bridge will be shown as<span> </span><span style="color:var(--ds-icon-success,#22a06b);"><code>designated-bridge</code></span>.</p><div role="region" aria-label="Note" class="confluence-information-macro  confluence-information-macro-note" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p>When using bridges that are set to use 802.1Q as EtherType, they will send out BPDUs to 01:80:C2:00:00:00, which are used by MSTP, RSTP, and STP. When using 802.1ad as bridge VLAN protocol, the BPDUs are not compatible with 802.1Q bridges and they are sent to 01:80:C2:00:00:08. (R/M)STP will not function properly if there are different bridge VLAN protocols across the Layer2 network.</p></div></div><h1 id="SpanningTreeProtocol-STPandRSTP">STP and RSTP</h1><hr/><p>STP and Rapid STP are used widely across many networks, but almost all networks have switched over to using only RSTP because of its benefits. STP is a very old protocol and has a convergence time (the time needed to fully learn network topology changes and to continue properly forwarding traffic) of up to 50 seconds. RSTP has a lot of smaller convergence time, a few seconds or even a few milliseconds. It is recommended to use RSTP instead of STP since it is a lot faster and is also backward compatible with STP. One of the reasons why RSTP is faster is because of reduced possible port states, below is a list of possible STP port states:</p><ul><li><strong>Forwarding</strong><span> </span>- port participates in traffic forwarding and is learning MAC addresses, and is receiving BPDUs.</li><li><strong>Listening</strong><span> </span>- port does not participate in traffic forwarding and is not learning MAC addresses, is receiving BPDUs.</li><li><strong>Learning</strong><span> </span>- port does not participate in traffic forwarding but is learning MAC addresses.</li><li><strong>Blocking</strong><span> </span>- port is blocked since it is causing loops but is receiving BPDUs.</li><li><strong>Disabled</strong><span> </span>- port is disabled or inactive.</li></ul><p>In RSTP the disabled, listening, and blocking port states are replaced with just one state called the<span> </span><strong>Discarding</strong><span> </span>state:</p><ul><li><strong>Forwarding</strong><span> </span>- port participates in traffic forwarding and is learning MAC addresses, is receiving BPDUs (forwarding=yes).</li><li><strong>Learning</strong><span> </span>- port does not participate in traffic forwarding but is learning MAC addresses (learning=yes).</li><li><strong>Discarding</strong><span> </span>- port does not participate in traffic forwarding and is not learning MAC addresses, is receiving BPDUs (forwarding=no).</li></ul><p>In STP ports are primarily categorized by states (e.g., Forwarding, Listening, Learning, Blocking, Disabled). Port behavior is determined dynamically based on the spanning tree algorithm but without explicitly assigning roles. The logic of forwarding or blocking traffic is derived from the calculation of Root Bridge, Root Ports, and Designated Ports, but these are considered part of the spanning tree topology rather than formalized port roles. <span style="color:var(--ds-text-accent-purple-bolder,#352c63);">RSTP explicitly defined port roles and introduces the concept of backup paths, which are explicitly represented through the Alternate Port and Backup Port roles. These roles did not exist in STP because STP treated blocked ports generically, without distinguishing their function as potential backups.</span></p><p>Here is a breakdown of the port roles for RSTP protocols: </p><ul><li data-uuid="2178aa3c-f555-4cb2-877b-7bc9f1248d45"><strong>Root Port</strong> - port that is facing towards the root bridge and has the best (lowest cost) path to the root bridge. Only one root port is elected per bridge (except the root bridge itself). </li><li data-uuid="d2cd3261-7067-4c81-bb02-54c470eb7b81"><strong>Designated Port</strong> - port that is facing away from the root bridge and forwards traffic away from the root bridge to downstream devices. </li><li data-uuid="f92eed48-9c4d-407d-bc99-839829d57eaa"><p><strong>Alternate Port</strong> - port that is facing towards the root bridge, but is not going to forward traffic. Port provides a backup path to the root bridge if the current root port fails.</p></li><li data-uuid="dc461db3-befc-4827-8460-f620dac96a26"><p><strong>Backup Port </strong>- port that is facing away from the root bridge, but is going to forward traffic. Port that serves as a backup for a designated port on the same segment.</p></li><li data-uuid="4750e13f-5d45-4ccd-b288-46af272780d0"><p><strong>Disabled Port</strong> - disabled or inactive port.</p></li></ul><p>In STP connectivity between bridges is determined by sending and receiving BPDUs between neighbor bridges. Designated ports are sending BPDUs to root ports. If a BPDU is not received 3 times the<span> </span><strong>HelloTime</strong><span> </span>in a row, then the connection is considered as unavailable and network topology convergence will commence. IT is possible to reduce STP convergence time in certain scenarios by reducing the<span> </span><span style="color:var(--ds-icon-success,#22a06b);"><code>forward-delay</code></span><span> </span>timer, which is responsible for how long can the port be in the learning/listening state.</p><p>In RouterOS, it is possible to specify which bridge ports are edge ports. Edge ports are ports that are not supposed to receive any BPDUs, this is beneficial since this allows STP to skip the learning and the listening state and directly go to the forwarding state. This feature is sometimes called<span> </span><strong>PortFast</strong>· You can leave this parameter to the default value, which is<span> </span><strong>auto</strong>, but you can also manually specify it, you can set a port as an edge port manually for ports that should not have any more bridges behind it, usually these are access ports.</p><p>Additionally, bridge port <span style="color:var(--ds-icon-success,#22a06b);"><code>point-to-point</code></span> , <span style="color:var(--ds-text,#333333);">specifies if a bridge port is connected to a bridge using a point-to-point link for faster convergence in case of failure. By setting this property to<span> </span></span><span style="color:var(--ds-icon-success,#22a06b);"><code>yes</code></span><span style="color:var(--ds-text,#333333);">, you are forcing the link to be a point-to-point link, which will skip the checking mechanism, which detects and waits for BPDUs from other devices from this single link, by setting this property to<span> </span></span><span style="color:var(--ds-icon-success,#22a06b);"><code>no</code></span><span style="color:var(--ds-text,#333333);">, you are implying that a link can receive BPDUs from multiple devices. By setting the property to<span> </span></span><span style="color:var(--ds-icon-success,#22a06b);"><code>yes</code></span><span style="color:var(--ds-text,#333333);">, you are significantly improving (R/M)STP convergence time. In general, you should only set this property to<span> </span></span><span style="color:var(--ds-icon-success,#22a06b);"><code>no</code></span><span style="color:var(--ds-text,#333333);"><span> , </span>if it is possible that another device can be connected between a link, this is mostly relevant to Wireless mediums and Ethernet hubs. If the Ethernet link is full-duplex,<span> </span></span><span style="color:var(--ds-icon-success,#22a06b);"><code>auto</code></span><span style="color:var(--ds-text,#333333);"><span> </span>enables point-to-point functionality. This property has no effect when<span> </span></span><code><span style="color:var(--ds-icon-success,#22a06b);">protocol-mode</span></code><span style="color:var(--ds-text,#333333);"><span> </span>is set to<span> </span></span><span style="color:var(--ds-icon-success,#22a06b);"><code>none</code></span><span style="color:var(--ds-text,#333333);">.</span></p><h2 id="SpanningTreeProtocol-Defaultvalues">Default values</h2><p>When creating a bridge or adding a port to the bridge the following are the default values that are assigned by RouterOS:</p><ul><li>Default bridge priority:<span> </span><strong>32768</strong><span> </span>/<span> </span><strong>0x8000</strong></li><li>Default bridge port path cost:<span> <strong>based on interface speed</strong></span></li><li>Default bridge port priority:<span> </span><strong>0x80</strong></li><li>BPDU message age increment:<span> </span><strong>1</strong></li><li>HelloTime:<span> </span><strong>2</strong></li><li>Default max message age:<span> </span><strong>20</strong></li></ul><p style="text-align: left;"><span>The bridge interface setting <code><span style="color:var(--ds-icon-success,#22a06b);">port-cost-mode</span></code><strong style="text-align: left;"> </strong>changes the port <code><span style="color:var(--ds-icon-success,#22a06b);">path-cost</span></code> and <code><span style="color:var(--ds-icon-success,#22a06b);">internal-path-cost</span></code> mode for bridged ports, utilizing automatic values based on interface speed. This setting does not impact bridged ports with manually configured </span><span style="color:var(--ds-icon-success,#22a06b);"><code>path-cost</code></span><span>  or </span><code><span style="color:var(--ds-icon-success,#22a06b);">internal-path-cost</span></code><span> properties. Below are examples illustrating the path-costs corresponding to specific data rates (with proportionate calculations for intermediate rates):</span></p><div class="table-wrap"><table class="wrapped confluenceTable" data-mce-resize="false"><colgroup class=""><col class=""/><col class=""/><col class=""/></colgroup><tbody class=""><tr class=""><th class="confluenceTh">Data rate</th><th class="confluenceTh">Long</th><th class="confluenceTh">Short</th></tr><tr class=""><td class="confluenceTd">10 Mbps</td><td class="confluenceTd">2,000,000</td><td class="confluenceTd">100</td></tr><tr class=""><td class="confluenceTd">100 Mbps</td><td class="confluenceTd">200,000</td><td class="confluenceTd">19</td></tr><tr class=""><td class="confluenceTd">1 Gbps</td><td class="confluenceTd">20,000</td><td class="confluenceTd">4</td></tr><tr class=""><td class="confluenceTd">10 Gbps</td><td class="confluenceTd">2,000</td><td class="confluenceTd">2</td></tr><tr><td class="confluenceTd">25 Gbps</td><td class="confluenceTd">800</td><td class="confluenceTd">1</td></tr><tr><td class="confluenceTd">40 Gbps</td><td class="confluenceTd">500</td><td class="confluenceTd">1</td></tr><tr><td class="confluenceTd">50 Gbps </td><td class="confluenceTd">400</td><td class="confluenceTd">1</td></tr><tr class=""><td class="confluenceTd">100 Gbps</td><td class="confluenceTd">200</td><td class="confluenceTd">1</td></tr></tbody></table></div><p>For bonded interfaces, the highest <code><span style="color:var(--ds-icon-success,#22a06b);">path-cost</span></code> among all bonded member ports is applied, this value remains unaffected by the total link speed of the bonding. For virtual interfaces (<span style="color:var(--ds-text,#333333);">such as</span><span> </span>VLAN, EoIP, VXLAN), as well as wifi, wireless, and 60GHz interfaces, a <span style="color:var(--ds-icon-success,#22a06b);"><code>path-cost</code></span> of 20,000 is assigned for long mode, and 10 for short mode. For dynamically bridged interfaces (e.g. wifi, wireless, PPP, VPLS), the <code><span style="color:var(--ds-icon-success,#22a06b);">path-cost</span></code> defaults to 20,000 for long mode and 10 for short mode. However, this can be manually overridden by the service that dynamically adds interfaces to bridge, for instance, by using the CAPsMAN<span> </span><code><span style="color:var(--ds-icon-success,#22a06b);">datapath.bridge-cost</span></code><span> </span>setting. RouterOS versions prior to 7.13 does not change port path cost based on the link speed, for 10M, 100M, 1000M, and 10000M link speeds the default path cost value when a port is added to a bridge was always<span> </span><strong>10</strong>.</p><p>The age of a BPDU is determined by how many bridges have the BPDU passed times the message age since RouterOS uses<span> </span><strong>1</strong><span> </span>as the message age increment, then the BPDU packet can pass as many bridges as specified in the<span> </span><code>max-message-age</code><span> </span>parameter. By default this value is set to<span> </span><strong>20</strong>, this means that after the 20th bridge the BPDU packet will be discarded and the next bridge will become a root bridge, note that if<span> </span><code><span style="color:var(--ds-icon-success,#22a06b);">max-message-age</span>=20 </code>is set, then it is hard to predict which ports will be the designated port on the 21st bridge and may result in traffic not being able to be forwarded properly.</p><div role="region" aria-label="Note" class="confluence-information-macro  confluence-information-macro-note" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p><span style="color:var(--ds-text,#333333);">In case bridge filter rules are used, make sure you allow packets with DST-MAC address<span> </span></span><strong>01:80:C2:00:00:00</strong><span style="color:var(--ds-text,#333333);"><span> </span>since these packets carry BPDUs that are crucial for STP to work properly.</span></p></div></div><h2 id="SpanningTreeProtocol-Electionprocess">Election process</h2><p>To properly configure STP in your network you need to understand the election process and which parameters are involved in which order. In RouterOS, the root bridge will be elected based on the smallest priority and the smallest MAC address in this particular order:</p><ol><li>Bridge priority (lowest)</li><li>Bridge MAC address (lowest)</li></ol><p>In RouterOS root ports are elected based on the lowest Root port path cost, lowest bridge identifier, and lowest bridge port ID in this particular order:</p><ol><li>Root port path cost (lowest)</li><li>Bridge identifier (lowest)</li><li>Bridge port ID (lowest)</li></ol><p>First, when the device considers which of its ports to elect as the root port, it will check the<span> </span><strong>root path cost</strong><span> </span>seen by its ports. If the root path cost is the same for two or more ports then the<span> </span><strong>Bridge identifier</strong><span> </span>of the<span> </span><strong>upstream</strong><span> </span>device will be checked and the port connected to the lowest bridge identifier will become the root port. If the same bridge identifier is seen on two or more ports, then<span> the </span><strong>Bridge port ID</strong><span> </span>of<span> the </span><strong>upstream</strong><span> </span>device will be checked.</p><p>Explanation of attributes:</p><p>Root path cost, all bridges have a Root Path Cost. The root bridge has a root path cost of 0. For all other Bridges, it is the sum of the Port Path Costs on the least-cost path to the Root Bridge. You can modify the local port path cost under &quot;<code><span style="color:var(--ds-icon-success,#22a06b);">/interface bridge port</span></code>&quot;.</p><p>The bridge identifier is a combination of &quot;bridge priority&quot; and &quot;bridge MAC&quot;, configurable under &quot;<code><span style="color:var(--ds-icon-success,#22a06b);">/interface bridge</span></code>&quot;</p><p>Bridge port ID is a combination of &quot;unique ID&quot; and &quot;bridge port priority&quot;, the unique ID is automatically assigned to the bridge port upon adding it to the bridge, it cannot be edited. It can be seen in WinBox under the &quot;Bridge Port&quot; &quot;Port Number&quot; column, or with &quot;<code><span style="color:var(--ds-icon-success,#22a06b);">/interface bridge port monitor</span></code>&quot;, as &quot;<code><span style="color:var(--ds-icon-success,#22a06b);">port-number</span></code>&quot;.</p><div role="region" aria-label="Note" class="confluence-information-macro  confluence-information-macro-note" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p><span style="color:var(--ds-text,#333333);">Make sure you are using path cost and priority on the right ports. For example, setting path cost on ports that are in a root bridge has no effect, only port priority affects them. Root path cost affects ports that are facing towards the root bridge and port priority affects ports that are facing away from the root bridge. And bridge identifier doesn’t impact the device's own root port election, instead, it affects the root port election for downstream devices.</span></p></div></div><div role="region" aria-label="Warning" class="confluence-information-macro  confluence-information-macro-warning" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-error confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p><span style="color:var(--ds-text,#333333);">In RouterOS it is possible to set any value for bridge priority between 0 and 65535, the IEEE 802.1W standard states that the bridge priority must be in steps of 4096. This can cause incompatibility issues between devices that do not support such values. To avoid incompatibility issues, it is recommended to use only these priorities: 0, 4096, 8192, 12288, 16384, 20480, 24576, 28672, 32768, 36864, 40960, 45056, 49152, 53248, 57344, 61440.</span></p></div></div><h2 id="SpanningTreeProtocol-Examples">Examples</h2><h3 id="SpanningTreeProtocol-Rootpathcostexample">Root path cost example</h3><p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" draggable="false" src="attachments/21725254/22773768.png" data-image-src="attachments/21725254/22773768.png" data-unresolved-comment-count="0" data-linked-resource-id="22773768" data-linked-resource-version="3" data-linked-resource-type="attachment" data-linked-resource-default-alias="RootPath.png" data-base-url="https://help.mikrotik.com/docs" data-linked-resource-content-type="image/png" data-linked-resource-container-id="21725254" data-linked-resource-container-version="24" tabindex="0" alt=""></span></p><p>This example outlines how the root path cost works. SW1 will be the root bridge, due to it having the lowest priority of 0x1000, as the root bridge. Each bridge will calculate the path cost to the root bridge. When calculating root path cost bridges take into account the configured path cost on their ports + root path cost advertised by neighboring bridges. </p><p><strong>SW1</strong>: due to it being the root bridge, it advertises a root path cost of 0 to its neighbors, even though it has a configured path cost of 10. </p><p><strong>SW2: </strong><strong> ether1</strong>. has a root path cost of 0 + 25=<strong>25</strong>. On the<strong> ether2</strong> path cost will be 10+10+10+0=<strong>30</strong></p><p><strong>SW3: </strong> <strong>ether2</strong>, has a root path cost of 0 + 10=<strong>10</strong>. On the <strong>ether4</strong> path cost will be 10+5+25+0=<strong>40</strong></p><p><strong>SW4: </strong> <strong>ether1</strong>, has a root path cost of 0+25+5=<strong>30</strong>. On <strong>ether4</strong> path cost will be 10+10+0=<strong>20</strong></p><p>The Port with the lowest path cost will be elected as the root port. Every bridge in STP topology needs a path to the root bridge, after the best path has been found, the redundant path will be blocked, in this case, the path between SW2 and SW4.</p><div role="region" aria-label="Note" class="confluence-information-macro  confluence-information-macro-note" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p>You can configure path cost on the root bridge, but it will only be taken into account when the bridge loses its root status. </p></div></div><h3 id="SpanningTreeProtocol-STPexample"><span style="font-size: 16.0px;font-weight: bold;letter-spacing: -0.006em;">STP example</span></h3><p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" draggable="false" src="attachments/21725254/22773787.png" data-image-src="attachments/21725254/22773787.png" data-unresolved-comment-count="0" data-linked-resource-id="22773787" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="STPexample1.png" data-base-url="https://help.mikrotik.com/docs" data-linked-resource-content-type="image/png" data-linked-resource-container-id="21725254" data-linked-resource-container-version="24" tabindex="0" alt=""></span></p><p>In this example, we want to ensure Layer2 redundancy for connections from ServerA to ServerB. If a port is connected to a device that is not a bridge and not running (R)STP, then this port is considered as an edge port, in this case, ServerA and ServerB are connected to an edge port. This is possible by using STP in a network. Below are configuration examples for each switch.</p><ul><li>Configuration for SW1:</li></ul><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge
add name=bridge priority=0x1000
/interface bridge port
add bridge=bridge interface=ether1 priority=0x60
add bridge=bridge interface=ether2 priority=0x50
add bridge=bridge interface=ether3 priority=0x40
add bridge=bridge interface=ether4 priority=0x30
add bridge=bridge interface=ether5</pre>
</div></div><ul><li>Configuration for SW2:</li></ul><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge
add name=bridge priority=0x2000
/interface bridge port
add bridge=bridge interface=ether1
add bridge=bridge interface=ether2
add bridge=bridge interface=ether3</pre>
</div></div><ul><li>Configuration for SW3:</li></ul><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge
add name=bridge priority=0x3000
/interface bridge port
add bridge=bridge interface=ether1
add bridge=bridge interface=ether2
add bridge=bridge interface=ether3</pre>
</div></div><ul><li>Configuration for SW4:</li></ul><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge
add name=bridge priority=0x4000
/interface bridge port
add bridge=bridge interface=ether1
add bridge=bridge interface=ether2 path-cost=20
add bridge=bridge interface=ether3</pre>
</div></div><p>In this example,<span> </span><strong>SW1</strong><span> </span>is the root bridge since it has the lowest bridge priority.<span> </span><strong>SW2</strong><span> </span>and<span> </span><strong>SW3</strong><span> </span>have ether1,ether2 connected to the root bridge, and ether3 is connected to<span> </span><strong>SW4</strong>. When all switches are working properly, the traffic will be flowing from ServerA through SW1_ether2, through SW2, and through SW4 to ServerB. In the case of<span> </span><strong>SW1</strong><span> </span>failure, the<span> </span><strong>SW2</strong><span> </span>becomes the root bridge because of the next lowest priority, indicated by the dotted line in the diagram. Below is a list of ports and their role for each switch:</p><ul><li><strong>root-port</strong><span> </span>- SW2_ether2, SW3_ether2, SW4_ether1</li><li><strong>alternate-port</strong><span> </span>- SW2_ether1, SW3_ether1, SW4_ether2</li><li><strong>designated-port</strong><span> </span>- SW1_ether1, SW1_ether2, SW1_ether3, SW1_ether4, SW1_ether5, SW2_ether3, SW2_ether3, SW4_ether3</li></ul><div role="region" aria-label="Note" class="confluence-information-macro  confluence-information-macro-note" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p><strong>Note:</strong><span style="color:var(--ds-text,#333333);"><span> </span>By the 802.1Q recommendations, you should use bridge priorities in steps of 4096. To set a recommended priority it is more convenient to use hexadecimal notation, for example, 0 is 0x0000, 4096 is 0x1000, 8192 is 0x2000, and so on (0..F).</span></p></div></div><h1 class="auto-cursor-target" id="SpanningTreeProtocol-MultipleSpanningTreeProtocol">Multiple Spanning Tree Protocol</h1><hr/><p>Multiple Spanning Tree Protocol (MSTP) is used on a bridge interface to ensure loop-free topology across multiple VLANs, MSTP can also provide Layer2 redundancy and can be used as a load balancing technique for VLANs since it has the ability to have different paths across different VLANs. MSTP is operating very similarly to (R)STP and many concepts from (R)STP can be applied to MSTP and it is highly recommended to understand the principles behind (R)STP before using MSTP, but there are some differences that must be taken into account when designing an MSTP enabled network.</p><p>In case (R)STP is used, the BPDUs are sent across all physical interfaces in a bridge to determine loops and stop ports from being able to forward traffic if it causes a loop. In case there is a loop inside a certain VLAN, (R)STP might not be able to detect it. Some STP variants solve this problem by running an STP instance on every single VLAN (PVST), but this has been proven to be inefficient and some STP variants solve this problem by running a single STP instance across all VLANs (CST), but it lacks the possibility to do load balancing for each VLAN or VLAN group. MSTP tends to solve both problems by using MST instances that can define a group of VLANs (VLAN mapping) that can be used for load balancing and redundancy, this means that each VLAN group can have a different root bridge and a different path. Note that it is beneficial to group multiple VLANs in a single instance to reduce the amount of CPU cycles for each network topology change.</p><div role="region" aria-label="Warning" class="confluence-information-macro  confluence-information-macro-warning" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-error confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p><span style="color:var(--ds-text,#333333);"><span> </span>In RouterOS with MSTP enabled the bridge priority is the CIST's root bridge priority, as stated in the IEEE 802.1Q standard the bridge priority must be in steps of 4096, the 12 lowest bits are ignored. These are valid bridge priorities: 0, 4096, 8192, 12288, 16384, 20480, 24576, 28672, 32768, 36864, 40960, 45056, 49152, 53248, 57344, 61440. When setting an invalid bridge priority, RouterOS will warn you about it and trunk the value to a valid value, but will save the original value in the configuration since invalid bridge priority values can still be used in (R)STP between devices running RouterOS, though it is recommended to use valid a bridge priority instead.</span></p></div></div><h2 id="SpanningTreeProtocol-MSTPRegions">MSTP Regions</h2><p>MSTP works in groups called regions, for each region there will be a regional root bridge, and between regions, there will be a root bridge elected. MSTP will use an Internal Spanning Tree (IST) to build the network topology inside a region and a Common Spanning Tree (CST) outside a region to build the network topology between multiple regions, MSTP combines these two protocols into Common and Internal Spanning Tree (CIST), which holds information about topology inside a region and between regions. From CST's perspective, a region will seemingly be as a single virtual bridge, because of this MSTP is considered very scalable for large networks. For bridges to be in the same region, their configuration must match, BPDUs will not include VLAN mappings since they can be large, rather a computed hash is being transmitted. If a bridge receives a BPDU through a port and the configuration does not match, then MSTP will consider that port as a boundary port and that it can be used to reach other regions. Below is a list of parameters that need to match for MSTP to consider a BPDU from the same region:</p><ul><li>Region name</li><li>Region revision</li><li>VLAN mappings to MST Instance IDs (computed hash)</li></ul><p>It is possible to create MSTP enabled network without regions, though to be able to do load balancing per VLAN group it is required for a bridge to receive a BPDU from a bridge that is connected to it with the same parameters mentioned above. In RouterOS the default region name is empty and the region revision is 0, which are valid values, but you must make sure that they match to get multiple bridges in a single MSTP region. A region cannot exist if its bridges are scattered over the network, these bridges must be connected at least in one way, in which they can send and receive BPDUs without leaving the region, for example, if a bridge with different region related parameters is between two bridges that have the same region related parameters, then there will exist at least 3 different MSTP regions.</p><p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" draggable="false" src="attachments/21725254/22773789.png" data-image-src="attachments/21725254/22773789.png" data-unresolved-comment-count="0" data-linked-resource-id="22773789" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="MSTPtopology.png" data-base-url="https://help.mikrotik.com/docs" data-linked-resource-content-type="image/png" data-linked-resource-container-id="21725254" data-linked-resource-container-version="24" tabindex="0" alt=""></span></p><p>The downside of running every single bridge in a single MSTP region is the excess CPU cycles. In comparison, PVST(+) creates a Spanning Tree Instance for each VLAN ID that exists on the network, since there will be very limited paths that can exist in a network, then this approach creates a lot of overhead and unnecessary CPU cycles, this also means that this approach does not scale very well and can overload switches with not very powerful CPUs. MSTP solves this problem by dividing the network into MSTP regions, where each bridge inside this region will exchange and process information about VLANs that exist inside the same region, but will run a single instance of Spanning Tree Protocol in the background to maintain the network topology between regions. This approach has been proven to be much more effective and much more scalable, this means that regions should be used for larger networks to reduce CPU cycles.</p><p>In regions, you can define MST Instances, which are used to configure load balancing per VLAN group and to elect the regional root bridge. It is worth mentioning that in each region there exists a pre-defined MST Instance, in most documentations, this is called as<span> </span><strong>MSTI0</strong>· This MST Instance is considered as the default MST Instance, there are certain parameters that apply to this special MST Instance. When traffic passes through an MSTP enabled bridge, MSTP will look for an MST Instance that has a matching VLAN mapping, but if a VLAN mapping does not exist for a certain VLAN ID, then traffic will fall under<span> </span><strong>MSTI0</strong>.</p><div role="region" aria-label="Note" class="confluence-information-macro  confluence-information-macro-note" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p><span style="color:var(--ds-text,#333333);">Since MSTP requires VLAN filtering on the bridge interface to be enabled, then make sure that you have allowed all required VLAN IDs in<span> </span></span><code>/interface bridge vlan</code><span style="color:var(--ds-text,#333333);">, otherwise, the traffic will not be forwarded and it might seem as if MSTP is misconfigured, although this is a VLAN filtering misconfiguration.</span></p></div></div><h2 id="SpanningTreeProtocol-Electionprocess.1">Election process</h2><p><span style="color:var(--ds-text,#333333);">The election process in MSTP can be divided into two sections, intra-region and inter-region. For MSTP to work properly there will always need to be a regional root, that is the root bridge inside a region, and a CIST root, that is the root bridge between regions. A regional root is the root bridge inside a region, regional root bridge will be needed to properly set up load balancing for VLAN groups inside a region. CIST root will be used to configure which ports will be alternate/backup ports (inactive) and which ports will be root ports (active).</span></p><div role="region" aria-label="Note" class="confluence-information-macro  confluence-information-macro-note" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p><span style="color:var(--ds-text,#333333);">Between regions, there is no load balancing per VLAN group, root port election process, and port blocking between MSTP regions is done the same way as in (R)STP. If CIST has blocked a port that is inside an MSTP region to prevent traffic loops between MSTP regions, then this port can still be active for IST to do load balancing per VLAN group inside an MSTP region.</span></p></div></div><ul><li>The following parameters are involved in electing a regional root bridge or root ports inside a MSTP region:</li></ul><div class="table-wrap"><table class="wrapped confluenceTable" style="margin-left: 7.46875px;"><colgroup><col/><col/></colgroup><tbody><tr><th class="confluenceTh">Property</th><th class="confluenceTh">Description</th></tr><tr><td class="confluenceTd"><strong>priority</strong><span> </span>(<em>integer: 0..65535 decimal format or 0x0000-0xffff hex format</em>; Default:<span> </span><strong>32768 / 0x8000</strong>)</td><td class="confluenceTd">/interface bridge msti, MST Instance priority, used to elect a regional root inside an MSTP region.</td></tr><tr><td class="confluenceTd"><strong>internal-path-cost</strong><span> </span>(<em>integer: 1..200000000</em>; Default: )</td><td class="confluenceTd">/interface bridge port, path cost to the regional root for unknown VLAN IDs (MSTI0), used on a root port inside an MSTP region.</td></tr><tr><td class="confluenceTd"><strong>priority</strong><span> </span>(<em>integer: 0..240</em>; Default:<span> </span><strong>128</strong>)</td><td class="confluenceTd">/interface bridge port mst-override, MST port priority for a defined MST Instance, used on a bridge port on the regional root bridge.</td></tr><tr><td class="confluenceTd"><strong>internal-path-cost</strong><span> </span>(<em>integer: 1..200000000</em>; Default: )</td><td class="confluenceTd">/interface bridge port mst-override, MST port path cost for a defined MST Instance, used on a non-root bridge port inside an MSTP region.</td></tr></tbody></table></div><ul><li>The following parameters are involved in electing a CIST root bridge or CIST root ports:</li></ul><div class="table-wrap"><table class="wrapped confluenceTable" style="margin-left: 7.46875px;"><colgroup><col/><col/></colgroup><tbody><tr><th class="confluenceTh">Property</th><th class="confluenceTh">Description</th></tr><tr><td class="confluenceTd"><strong>priority</strong><span> </span>(<em>integer: 0..65535 decimal format or 0x0000-0xffff hex format</em>; Default:<span> </span><strong>32768 / 0x8000</strong>)</td><td class="confluenceTd">/interface bridge, CIST bridge priority, used to elect a CIST root bridge.</td></tr><tr><td class="confluenceTd"><strong>priority</strong><span> </span>(<em>integer: 0..240</em>; Default:<span> </span><strong>128</strong>)</td><td class="confluenceTd">/interface bridge port, CIST port priority, used on a CIST root bridge to elect CIST root ports.</td></tr><tr><td class="confluenceTd"><strong>path-cost</strong><span> </span>(<em>integer: 1..200000000</em>; Default: )</td><td class="confluenceTd">/interface bridge port, CIST port path cost, used on a CIST non-root bridge port to elect CIST root ports.</td></tr></tbody></table></div><div role="region" aria-label="Note" class="confluence-information-macro  confluence-information-macro-note" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p><span style="color:var(--ds-text,#333333);"><span> </span>The sequence of parameters in which MSTP checks to elect root bridge/ports is the same as in (R)STP, you can read more about it in the<span> </span></span>(R)STP Election Process<span> </span><span style="color:var(--ds-text,#333333);">section.</span></p></div></div><h2 class="auto-cursor-target" id="SpanningTreeProtocol-MSTInstance">MST Instance</h2><p><strong>Sub-menu:</strong><span> </span><code>/interface bridge msti</code></p><p>This section is used to group multiple VLAN IDs into a single instance to create a different root bridge for each VLAN group inside an MSTP region.</p><div class="table-wrap"><table class="wrapped confluenceTable" style="margin-left: 7.46875px;"><colgroup><col/><col/></colgroup><tbody><tr><th class="confluenceTh">Property</th><th class="confluenceTh">Description</th></tr><tr><td class="confluenceTd"><strong>bridge</strong><span> </span>(<em>text</em>; Default: )</td><td class="confluenceTd">Bridge to which assigns an MST instance.</td></tr><tr><td class="confluenceTd"><strong>identifier</strong><span> </span>(<em>integer: 1..31</em>; Default: )</td><td class="confluenceTd">MST instance identifier.</td></tr><tr><td class="confluenceTd"><strong>priority</strong><span> </span>(<em>integer: 0..65535 decimal format or 0x0000-0xffff hex format</em>; Default:<span> </span><strong>32768 / 0x8000</strong>)</td><td class="confluenceTd">MST instance priority, is used to determine the root bridge for a group of VLANs in an MSTP region.</td></tr><tr><td class="confluenceTd"><strong>vlan-mapping</strong><span> </span>(<em>integer: 1..4094</em>; Default: )</td><td class="confluenceTd">The list of VLAN IDs to assign to MST instance. This setting accepts the VLAN ID range, as well as comma, separated values. E.g.<span> </span><code><span style="color:var(--ds-icon-success,#22a06b);">vlan-mapping</span>=100-115,120,122,128-130</code></td></tr></tbody></table></div><h2 id="SpanningTreeProtocol-MSTOverride">MST Override</h2><p><strong>Sub-menu:</strong><span> </span><code>/interface bridge port mst-override</code></p><p>This section is used to select the desired path for each VLAN mapping inside an MSTP region.</p><div class="table-wrap"><table class="wrapped confluenceTable" style="margin-left: 7.46875px;"><colgroup><col/><col/></colgroup><tbody><tr><th class="confluenceTh">Property</th><th class="confluenceTh">Description</th></tr><tr><td class="confluenceTd"><strong>disabled</strong><span> </span>(<em>yes | no</em>; Default:<span> </span><strong>no</strong>)</td><td class="confluenceTd">Whether the entry is disabled.</td></tr><tr><td class="confluenceTd"><strong>internal-path-cost</strong><span> </span>(<em>integer: 1..200000000</em>; Default: )</td><td class="confluenceTd">Path cost for an MST instance's VLAN mapping, used on VLANs that are facing towards the root bridge to manipulate path selection, lower path cost is preferred.</td></tr><tr><td class="confluenceTd"><strong>identifier</strong><span> </span>(<em>integer: 1..31</em>; Default: )</td><td class="confluenceTd">MST instance identifier.</td></tr><tr><td class="confluenceTd"><strong>priority</strong><span> </span>(<em>integer: 0..240</em>; Default:<span> </span><strong>128</strong>)</td><td class="confluenceTd">The priority of an MST instance's VLAN, used on VLANs that are facing away from the root bridge to manipulate path selection, lower priority is preferred.</td></tr><tr><td class="confluenceTd"><strong>interface</strong><span> </span>(<em>name</em>; Default: )</td><td class="confluenceTd">Name of the port on which use configured MST instance's VLAN mappings and defined path cost and priority.</td></tr></tbody></table></div><h2 id="SpanningTreeProtocol-Monitoring.1">Monitoring</h2><p>Similarly to (R)STP, it is also possible to monitor MSTP status. By monitoring the bridge interface itself it is possible to see the current CIST root bridge and the current regional root bridge for MSTI0, it is also possible to see the computed hash of MST Instance identifiers and VLAN mappings, this is useful when making sure that certain bridges are in the same MSTP region. Below you can find an example of monitoring an MSTP bridge:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge monitor bridge
                    state: enabled
      current-mac-address: 6C:3B:6B:7B:F0:AA
                bridge-id: 0x8000.6C:3B:6B:7B:F0:AA 
              root-bridge: no
           root-bridge-id: 0x1000.64:D1:54:24:23:72
  regional-root-bridge-id: 0x4000.6C:3B:6B:7B:F0:AA
           root-path-cost: 10
                root-port: ether4
               port-count: 5
    designated-port-count: 3
        mst-config-digest: 74edbeefdbf82cf63a70cf60e43a56f3
             fast-forward: no                              
         multicast-router: yes                             
             igmp-querier: none                            
              mld-querier: none                            
        declared-vlan-ids: 1                               
      registered-vlan-ids: 1</pre>
</div></div><p>In MSTP it is possible to monitor the MST Instance, this is useful to determine the current regional root bridge for a certain MST Instance and VLAN group, below you can find an example to monitor an MST Instance:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge msti monitor 1
                    state: enabled
               identifier: 2
      current-mac-address: 6C:3B:6B:7B:F0:AA
                bridge-id: 0x8000.6C:3B:6B:7B:F0:AA
              root-bridge: no
           root-bridge-id: 0.00:00:00:00:00:00
  regional-root-bridge-id: 0x1002.6C:3B:6B:7B:F9:08
           root-path-cost: 0
                root-port: ether2
               port-count: 5
    designated-port-count: 1</pre>
</div></div><p>It is also possible to monitor a certain MST Override entry, this is useful to determine the port role for a certain MST Instance when configuring root ports and alternate/backup ports in an MSTP region, below you can find an example to monitor an MST Override entry:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge port mst-override monitor 1
                      port: ether3
                    status: active
                identifier: 2
                   port-id: 0x80.1     
                      role: alternate-port
                  learning: no
                forwarding: no
   internal-root-path-cost: 15
         designated-bridge: 0x1002.6C:3B:6B:7B:F9:08
  designated-internal-cost: 0
        designated-port-id: 0x80.1  
 designated-remaining-hops: 20                      
                tx-rx-bpdu: 3/7991                  
       discard-transitions: 0                       
       forward-transitions: 1                       
                  tx-rx-tc: 2/2                     
          topology-changes: 1                       </pre>
</div></div><h2 class="auto-cursor-target" id="SpanningTreeProtocol-MSTPexample">MSTP example</h2><p><span style="color:var(--ds-text,#333333);">Let's say that we need to design topology and configure MSTP in a way that VLAN 10,20 will be forwarded in one path, but VLAN 30,40 will be forwarded in a different path, while all other VLAN IDs will be forwarded in one of those paths. This can easily be done by setting up MST Instances and assigning port path costs, below you can find a network topology that needs to do load balancing per VLAN group with 3 separate regions as an example:</span></p><p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" draggable="false" src="attachments/21725254/22773794.png" data-image-src="attachments/21725254/22773794.png" data-unresolved-comment-count="0" data-linked-resource-id="22773794" data-linked-resource-version="3" data-linked-resource-type="attachment" data-linked-resource-default-alias="MSTPexample.png" data-base-url="https://help.mikrotik.com/docs" data-linked-resource-content-type="image/png" data-linked-resource-container-id="21725254" data-linked-resource-container-version="24" tabindex="0" alt=""></span></p><p>The topology of an MSTP-enabled network with load balancing per VLAN group</p><p>Start by adding each interface to a bridge, initially, you should create a (R)STP bridge without VLAN filtering enabled, this is to prevent losing access to the CPU. Each device in this example is named by the region that it is in (Rx) and a device number (_x). For larger networks configuring MSTP can be confusing because of the number of links and devices, we recommend using<span> </span>The Dude<span> </span>to monitor and design a network topology.</p><ul><li>Use the following commands on<span> </span><strong>R1_1</strong>,<span> </span><strong>R1_3</strong>,<span> </span><strong>R2_1</strong>,<span> </span><strong>R2_3</strong>,<span> </span><strong>R3_1</strong>,<span> </span><strong>R3_3</strong>:</li></ul><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge
add name=bridge protocol-mode=rstp vlan-filtering=no
/interface bridge port
add bridge=bridge interface=ether1
add bridge=bridge interface=ether2
add bridge=bridge interface=ether3
add bridge=bridge interface=ether4</pre>
</div></div><ul><li><span style="color:var(--ds-text,#333333);">Use the following commands on<span> </span></span><strong style="text-align: left;">R1_2</strong><span style="color:var(--ds-text,#333333);">,<span> </span></span><strong style="text-align: left;">R2_2</strong><span style="color:var(--ds-text,#333333);">,<span> </span></span><strong style="text-align: left;">R3_2</strong><span style="color:var(--ds-text,#333333);">:</span></li></ul><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge
add name=bridge protocol-mode=rstp vlan-filtering=no
/interface bridge port
add bridge=bridge interface=ether1
add bridge=bridge interface=ether2</pre>
</div></div><ul><li>Make sure you allow the required VLAN IDs on these devices, here we will consider that each device will receive tagged traffic that needs to be load balanced per VLAN group, use these commands on<span> </span><strong>R1_1</strong>,<span> </span><strong>R1_3</strong>,<span> </span><strong>R2_1</strong>,<span> </span><strong>R2_3</strong>,<span> </span><strong>R3_1</strong>,<span> </span><strong>R3_3</strong>:</li></ul><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge vlan
add bridge=bridge tagged=ether1,ether2,ether3,ether4 vlan-ids=10,20,30,40</pre>
</div></div><ul><li>Use the following commands on<span> </span><strong>R1_2</strong>,<span> </span><strong>R2_2</strong>,<span> </span><strong>R3_2</strong>:</li></ul><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge vlan
add bridge=bridge tagged=ether1,ether2 vlan-ids=10,20,30,40</pre>
</div></div><div role="region" aria-label="Note" class="confluence-information-macro  confluence-information-macro-note" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p><span style="color:var(--ds-text,#333333);"><span> </span>Make sure you add all the needed VLAN IDs and ports to the bridge VLAN table, otherwise, your device will not forward all required VLANs, and/or you will lose access to the device.</span></p></div></div><p>We need to assign a region name for each bridge that we want to be in a single MSTP region, you can also specify the region revision, but it is optional, though they need to match. In this example, if all bridges will have the same region name, then they will all be in a single MSTP bridge. In this case, we want to separate a group of 3 bridges in a different MSTP region to do load balancing per VLAN group and to create diversity and scalability.</p><ul><li>Set the appropriate region name (and region revision) for each bridge, and use the following commands on each device (<strong>change the region name!</strong>):</li></ul><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge
set bridge region-name=Rx region-revision=1</pre>
</div></div><p>After we have created 3 different MSTP regions, we need to decide which device is going to be a regional root for each VLAN group. For consistency, we are going to set the first device (_1) in each region as the regional root for VLAN 10,20 and the third device (_3) in each region as the regional root for VLAN 30,40. This can be done by creating an MST Instance for each VLAN group and assigning a bridge priority to it. The MST Instance identifier is only relevant inside an MSTP region, outside an MSTP region these identifiers can be different and mapped to a different VLAN group.</p><ul><li>Use the following commands on<span> </span><strong>R1_1</strong>,<span> </span><strong>R2_1</strong>,<span> </span><strong>R3_1</strong>:</li></ul><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge msti
add bridge=bridge identifier=1 priority=0x1000 vlan-mapping=10,20
add bridge=bridge identifier=2 priority=0x3000 vlan-mapping=30,40</pre>
</div></div><ul><li>Use the following commands on<span> </span><strong>R1_3</strong>,<span> </span><strong>R2_3</strong>,<span> </span><strong>R3_3</strong>:</li></ul><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge msti
add bridge=bridge identifier=1 priority=0x3000 vlan-mapping=10,20
add bridge=bridge identifier=2 priority=0x1000 vlan-mapping=30,40</pre>
</div></div><ul><li>Use the following commands on<span> </span><strong>R1_2</strong>,<span> </span><strong>R2_2</strong>,<span> </span><strong>R3_2</strong>:</li></ul><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge msti
add bridge=bridge identifier=1 priority=0x2000 vlan-mapping=10,20
add bridge=bridge identifier=2 priority=0x2000 vlan-mapping=30,40</pre>
</div></div><p>Now we need to override the port <code><span style="color:var(--ds-icon-success,#22a06b);">path-cost </span></code>and/or port priority for each MST Instance. This can be done by adding an MST-Override entry for each port and each MST Instance. To achieve that for a certain MST Instance the traffic flow path is different, we simply need to make sure that the port path cost and/or priority is larger. We can either increase the port path cost or decrease the port path cost to ports that are facing toward the regional root bridge. It doesn't matter if you increase or decrease all values, it is important that in the end, one port's path cost is larger than the other's.</p><ul><li>Use the following commands on<span> </span><strong>R1_1</strong>,<span> </span><strong>R2_1</strong>,<span> </span><strong>R3_1</strong>:</li></ul><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge port mst-override
add identifier=2 interface=ether1 internal-path-cost=5
add identifier=2 interface=ether2 internal-path-cost=15</pre>
</div></div><ul><li>Use the following commands on<span> </span><strong>R1_2</strong>,<span> </span><strong>R2_2</strong>,<span> </span><strong>R3_2</strong>:</li></ul><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge port mst-override
add identifier=1 interface=ether1 internal-path-cost=5
add identifier=2 interface=ether2 internal-path-cost=9</pre>
</div></div><ul><li>Use the following commands on<span> </span><strong>R1_3</strong>,<span> </span><strong>R2_3</strong>,<span> </span><strong>R3_3</strong>:</li></ul><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge port mst-override
add identifier=1 interface=ether2 internal-path-cost=5
add identifier=1 interface=ether3 internal-path-cost=9</pre>
</div></div><p>In this case for VLAN 10,20 to reach the third device from the first device, it would choose between ether1 and ether2, one port will be blocked and set as an alternate port, and ether1 will have path cost as<span> </span><code>5+9=14</code><span> </span>and ether2 will have path cost as<span> </span><code>10</code>, ether2 will be elected as the root port for MSTI1 on the third device. In case for VLAN 30,40 to reach the first device from the third device, ether1 will have path cost as<span> </span><code>5+9=14</code><span> </span>and ether2 will have path cost as<span> </span><code>15</code>, ether1 will be elected as the root port for MSTI2 on the third device.</p><p>Now we can configure the root ports for<span> </span><strong>MSTI0</strong>, which will fall under all VLANs that are not assigned to a specific MST Instance, like in our example VLAN 10,20, and VLAN 30,40. To configure this special MST Instance, you will need to specify<span> </span><span style="color:var(--ds-icon-success,#22a06b);"><code>internal-path-cost</code></span><span> </span>to a bridge port. This value is only relevant to MSTP regions, it does not have any effect outside an MSTP region. In this example will choose that all unknown VLANs will be forwarded over the same path as VLAN 30,40, we will simply increase the path cost on one of the ports.</p><ul><li>Use the following commands on<span> </span><strong>R1_3</strong>,<span> </span><strong>R2_3</strong>,<span> </span><strong>R3_3</strong>:</li></ul><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge port
set [find where interface=ether3] internal-path-cost=25</pre>
</div></div><p>At this point, a single region MSTP can be considered as configured, and in general, MSTP is fully functional. It is highly recommended to configure the CIST part, but for testing purposes, it can be left with the default values. Before doing any tests, you need to enable MSTP on all bridges.</p><ul><li>Use the following commands on<span> </span><strong>all</strong><span> </span>devices:</li></ul><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge
set bridge protocol-mode=mstp vlan-filtering=yes</pre>
</div></div><p>When MSTP regions have been configured, you can check if they are properly configured by forwarding traffic, for example, send tagged traffic from the first device to the third device and change the VLAN ID for the tagged traffic to observe different paths based on VLAN ID. When this is working as expected, then you can continue to configure CIST related parameters to elect a CIST root bridge and CIST root ports. For consistency we will choose the first device in the first region to be the CIST root bridge and to ensure consistency in case of failure we can set a higher priority to all other bridges.</p><ul><li>Use the following commands on<span> </span><strong>R1_1:</strong></li></ul><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge
set bridge priority=0x1000</pre>
</div></div><ul><li>Use the following commands on<span> </span><strong>R1_2</strong>:</li></ul><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge
set bridge priority=0x2000</pre>
</div></div><ul><li>...</li></ul><ul><li>Use the following commands on<span> </span><strong>R3_3</strong>:</li></ul><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge
set bridge priority=0x9000</pre>
</div></div><p>We also need to elect a root port on each bridge, for simplicity we will choose the port that is closest to<span> </span><strong>Ŗ1_1</strong><span> </span>as the root port and has the least hops. At this point, the procedure to elect root ports is the same as the procedure in (R)STP.</p><ul><li>Use the following commands on<span> </span><strong>R3_3:</strong></li></ul><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge port
set [find where interface=ether2] path-cost=30
set [find where interface=ether3] path-cost=40
set [find where interface=ether4] path-cost=20</pre>
</div></div><ul><li><p class="auto-cursor-target">Use the following commands on<span> </span><strong>R1_3</strong><span> </span>and<span> </span><strong>R2_3:</strong></p></li></ul><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge port
set [find where interface=ether2] path-cost=20
set [find where interface=ether3] path-cost=30</pre>
</div></div><ul><li>Use the following commands on<span> </span><strong>R1_2</strong>:</li></ul><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge port
set [find where interface=ether1] path-cost=30</pre>
</div></div><p><br/></p>
                    </div>

                                                            <div class="pageSection group">
                        <div class="pageSectionHeader">
                            <h2 id="attachments" class="pageSectionTitle">Attachments:</h2>
                        </div>

                        <div class="greybox" align="left">
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/21725254/21725302.png">STPexample.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/21725254/22773776.png">RootPath.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/21725254/22773779.png">RootPath.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/21725254/22773768.png">RootPath.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/21725254/22773787.png">STPexample1.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/21725254/22773789.png">MSTPtopology.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/21725254/22773795.png">MSTPexample.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/21725254/22773796.png">MSTPexample.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/21725254/22773794.png">MSTPexample.png</a> (image/png)
                                <br/>
                                                    </div>
                    </div>
                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on May 20, 2025 14:53</p>
                    <div id="footer-logo"><a href="https://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
