<!DOCTYPE html>
<html>
    <head>
        <title>RouterOS : Bridge VLAN Table</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">RouterOS</a></span>
                            </li>
                                                    <li>
                                <span><a href="RouterOS_328059.html">RouterOS</a></span>
                            </li>
                                                    <li>
                                <span><a href="Bridging-and-Switching_328068.html">Bridging and Switching</a></span>
                            </li>
                                                    <li>
                                <span><a href="Bridging-and-Switching-Case-Studies_119144611.html">Bridging and Switching Case Studies</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            RouterOS : Bridge VLAN Table
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
    
        
    
        
        
            Created by <span class='author'> Edgars P.</span>, last updated by <span class='editor'> Guntis G.</span> on Apr 05, 2024
    
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <p><span class="mw-headline"><style type='text/css'>/*<![CDATA[*/
div.rbtoc1747742024899 {padding: 0px;}
div.rbtoc1747742024899 ul {margin-left: 0px;}
div.rbtoc1747742024899 li {margin-left: 0px;padding-left: 0px;}

/*]]>*/</style><div class='toc-macro rbtoc1747742024899'>
<ul class='toc-indentation'>
<li><a href='#BridgeVLANTable-Summary'>Summary</a></li>
<li><a href='#BridgeVLANTable-Background'>Background</a></li>
<li><a href='#BridgeVLANTable-Trunk/Accessportsetup'>Trunk/Access port setup</a></li>
<li><a href='#BridgeVLANTable-VLANTunnellingsetup'>VLAN Tunnelling setup</a>
<ul class='toc-indentation'>
<li><a href='#BridgeVLANTable-TagStacking'>Tag Stacking</a></li>
</ul>
</li>
</ul>
</div></span></p><h1 id="BridgeVLANTable-Summary"><span class="mw-headline">Summary</span></h1><hr/><p>It is possible to use a bridge to filter out VLANs in your network. To achieve this, you should use the<span> </span><a href="https://help.mikrotik.com/docs/display/ROS/Bridging+and+Switching#BridgingandSwitching-BridgeVLANFiltering" rel="nofollow">Bridge VLAN Filtering</a><span> </span>feature. This feature should be used instead of many known VLAN misconfigurations that are most likely causing you either performance issues or connectivity issues, you can read about one of the most popular misconfigurations in the<span> </span><a href="https://help.mikrotik.com/docs/display/ROS/Layer2+misconfiguration#Layer2misconfiguration-VLANinabridgewithaphysicalinterface" rel="nofollow">VLAN in a bridge with a physical interface</a><span> </span>section. The most important part of the bridge VLAN filtering feature is the bridge VLAN table, which specifies which VLANs are allowed on each port, but configuring it might get quite complex if you are trying to make a more advanced setup, for generic setups you should be able to configure your device using the<span> </span><a href="https://help.mikrotik.com/docs/display/ROS/Bridging+and+Switching#BridgingandSwitching-VLANExample-TrunkandAccessPorts" rel="nofollow">Trunk and Access ports</a><span> </span>example, but the purpose of this guide is to provide in-depth explanation and point out some of the behavior characteristics when using bridge VLAN Filtering.</p><h1 id="BridgeVLANTable-Background"><span class="mw-headline">Background</span></h1><hr/><p>Before explaining bridge VLAN filtering in-depth, you should understand a few basic concepts that are involved in bridge VLAN filtering.</p><ul><li><strong>Tagged/Untagged</strong><span> </span>- Under<span> </span><span style="color:var(--ds-background-accent-green-bolder,#1f845a);"><code>/interface bridge vlan</code></span><span> menu, </span>you can specify an entry that contains<span> </span>tagged<span> </span>and<span> </span>untagged<span> </span>ports. In general, tagged ports should be your trunk ports and untagged ports should be your access ports. By specifying a tagged port the bridge will always set a VLAN tag for packets that are being sent out through this port (egress). By specifying an untagged port the bridge will always remove the VLAN tag from egress packets.</li><li><strong>VLAN-ids</strong><span> </span>- Under<span> </span><span style="color:var(--ds-background-accent-green-bolder,#1f845a);"><code>/interface bridge vlan</code></span><span> menu, </span>you can specify an entry in which certain VLANs are allowed on specific ports. The VLAN ID is checked on egress ports. If the packet contains a VLAN ID that does not exist in the bridge VLAN table for the egress port, then the packet is dropped before it gets sent out.</li><li><strong>PVID</strong><span> </span>- The Port VLAN ID is used for access ports to tag all ingress traffic with a specific VLAN ID. A dynamic entry is added in the bridge VLAN table for every PVID used, the port is automatically added as an untagged port.</li><li><strong>Ingress filtering</strong><span> </span>- By default, VLANs that don't exist in the bridge VLAN table are dropped before they are sent out (egress), but this property allows you to drop the packets when they are received (ingress).</li><li><strong>Management access</strong><span> </span>- The bridge is supposed to simply forward packets between bridge ports and it would seem to other devices that there is simply a wire between them. With bridge VLAN filtering you can limit which packets are allowed to access the device that has the bridge configured, the most common practice is to allow access to the device only by using a very specific VLAN ID, but there are other ways you can grant access to the device. Management access is a great way to add another layer of security when accessing the device through a bridge port, this type of access is sometimes called the management port. For devices that support <a href="https://help.mikrotik.com/docs/display/ROS/Bridging+and+Switching#BridgingandSwitching-BridgeHardwareOffloading" rel="nofollow">VLAN Filtering with hardware offloading</a>, It is also related to the CPU port of a bridge.</li><li><strong>CPU port</strong><span> </span>- Every device with a switch chip has a special purpose port called CPU port and it is used to communicate with the device's CPU. For devices that support VLAN filtering with hardware offloading, this port is the bridge interface itself. This port is mostly used to create management access but can be used for other purposes, for example, to route traffic between VLANs, to mark packets, and to apply queues.</li><li><strong>frame-type</strong><span> </span>- You can filter out packets whether they have a VLAN tag or not, this is useful to add an extra layer of security for your bridge ports.</li><li><strong>EtherType</strong><span> </span>- By default, a VLAN aware bridge will filter VLANs by checking the C-TAG (0x8100), all other VLAN tags are considered as untagged packets (without a VLAN tag). The selected EtherType will be used for VLAN filtering and VLAN tagging/untagging.</li><li><strong>VLAN Tunnelling</strong><span> </span>- If the EtherType of the packet does not match with the EtherType configured for the bridge, then ingress packets are considered as untagged packets, this behavior gives a possibility to encapsulate VLANs into another, different VLAN. This also gives a possibility to divert specific traffic through different devices in your network.</li><li><strong>Tag stacking</strong><span> </span>- If a packet has a VLAN tag that matches the EtherType, then the packet is considered as a tagged packet, but you can force another VLAN tag regardless of the packet's content. By setting<span> </span><span style="color:var(--ds-background-accent-green-bolder,#1f845a);"><code>tag-stacking=yes</code></span><span> </span>on a bridge port, you will add another VLAN tag with the<span> </span>PVID<span> </span>value on top of any other tag for all ingress packets.</li></ul><h1 id="BridgeVLANTable-Trunk/Accessportsetup"><span class="mw-headline">Trunk/Access port setup</span></h1><hr/><p>Below you can find a very common diagram for a very typical type of setup that consists of a trunk port and multiple access ports:</p><p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" draggable="false" src="attachments/28606465/28606467.png" data-image-src="attachments/28606465/28606467.png" data-unresolved-comment-count="0" data-linked-resource-id="28606467" data-linked-resource-version="2" data-linked-resource-type="attachment" data-linked-resource-default-alias="Trunk_access_setup.png" data-base-url="https://help.mikrotik.com/docs" data-linked-resource-content-type="image/png" data-linked-resource-container-id="28606465" data-linked-resource-container-version="15" tabindex="0" alt=""></span></p><p>This setup is very common since it gives the possibility to divide your network into multiple segments while using a single switch and maybe a single router, such a requirement is very common for companies that want to separate multiple departments. With VLANs you can use different DHCP Servers, which can give out an IP address from a different subnet based on the VLAN ID, which makes creating Firewall rules and QoS a lot easier.</p><p>In such a setup you would connect some generic devices like Desktop PCs to<span> </span><strong>ether2</strong><span> </span>and<span> </span><strong>ether3</strong>, these can be considered as workstations and they generally only use untagged traffic (it is possible to force a VLAN tag for all traffic that is sent out a generic workstation, though it is not very common). To isolate some workstations from other workstations you must add a VLAN tag to all packets that enter<span> </span><strong>ether2</strong><span> </span>or<span> </span><strong>ether3</strong>, but to decide what VLAN ID should the packet get, you need to use a concept called<span> </span><strong>Port-based VLANs</strong>. In this concept, packets get a VLAN tag with a VLAN ID based on the bridge port to which the device is connected. For example, in this setup the device on<span> </span><strong>ether2</strong><span> </span>will get a VLAN tag with<span> </span><strong>VLAN20</strong><span> </span>and the device on<span> </span><strong>ether3</strong><span> </span>will get a VLAN tag with<span> </span><strong>VLAN30</strong>, this concept is very scalable as long as you have enough bridge ports. This should give you the understanding that traffic between the bridge and devices behind<span> </span><strong>ether2/ether3</strong><span> </span>is untagged (since there is no VLAN tag, hence the name).</p><p>When we have determined our untagged ports, we can now determine our tagged ports. Tagged ports are going to be the trunk ports (the port, that carries multiple VLANs) and usually, this port is connected to a router or another switch/bridge, you can have multiple trunk ports as well. Tagged ports are always carrying packets with a VLAN tag (hence the name) and you must<span> </span><strong>ALWAYS</strong><span> </span>specify the tagged ports for each VLAN ID you want this port to forward. It is possible that a port is a tagged port for one VLAN ID and the same port is an untagged port for a different VLAN ID, but this is for a different type of setup (Hybrid port setup).</p><p>A special note must be added for the<span> </span>PVID<span> </span>property. This property should be used on access ports, but it can be used for trunk ports as well (in Hybrid port setup). By using the<span> </span>PVID<span> </span>property you are adding a new VLAN tag with a VLAN ID that is specified in the<span> </span>PVID<span> </span>to all<span> </span><strong>UNTAGGED</strong><span> </span>packets that are received on that specific bridge port. The<span> </span>PVID<span> </span>does not have any effect on tagged packets, this means that, for example, if a packet with a VLAN tag of<span> </span><strong>VLAN40</strong><span> </span>is received on<span> </span><strong>ether2</strong><span> </span>that has<span> </span><code>PVID=20</code>, then the VLAN tag is<span> </span><strong>NOT</strong><span> </span>changed and forwarding will depend on the entries from the bridge VLAN table.</p><p>To configure the trunk/access port setup, you need to first create a bridge:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge
add name=bridge1</pre>
</div></div><div role="region" aria-label="Warning" class="confluence-information-macro  confluence-information-macro-warning" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-error confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p>Don't enable VLAN filtering yet as you might get locked out from the device because of the lack of management access, which is configured at the end.</p></div></div><p>Add the bridge ports and specify<span> </span>PVID<span> </span>for each access port:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge port
add bridge=bridge1 interface=ether1
add bridge=bridge1 interface=ether2 pvid=20
add bridge=bridge1 interface=ether3 pvid=30</pre>
</div></div><div role="region" aria-label="Note" class="confluence-information-macro  confluence-information-macro-note" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p>PVID<span> </span>has no effect until VLAN filtering is enabled.</p></div></div><p>Add appropriate entries in the bridge VLAN table:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge vlan
add bridge=bridge1 tagged=ether1 untagged=ether2 vlan-ids=20
add bridge=bridge1 tagged=ether1 untagged=ether3 vlan-ids=30</pre>
</div></div><p>You might think that you could simplify this entry with a single entry, similar to this:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge vlan
add bridge=bridge1 tagged=ether1 untagged=ether2,ether3 vlan-ids=20,30</pre>
</div></div><p>Do<span> </span><strong>NOT</strong><span> </span>use multiple VLAN IDs on access ports. This will unintentionally allow both<span> </span><strong>VLAN20</strong><span> </span>and<span> </span><strong>VLAN30</strong><span> </span>on both access ports. In the example above,<span> </span><strong>ether3</strong><span> </span>is supposed to set a VLAN tag for all ingress packets to use<span> </span><strong>VLAN30</strong><span> </span>(since<span> </span><span style="color:var(--ds-background-accent-green-bolder,#1f845a);"><code>PVID=30</code></span>), but this does not limit the allowed VLANs on this port when VLANs are being sent out through this port. The bridge VLAN table is responsible for deciding whether a VLAN is allowed to be sent through a specific port or not. The entry above specifies that both<span> </span><strong>VLAN20</strong><span> </span>and<span> </span><strong>VLAN30</strong><span> </span>are allowed to be sent out through<span> </span><strong>ether2</strong><span> </span>and<span> </span><strong>ether3</strong><span> </span>and on top of that the entry specifies that packets should be sent out without a VLAN tag (packets are sent out as untagged packets). As a result, you may create a packet leak from VLANs to ports that are not even supposed to receive such traffic, see the image below.</p><p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" draggable="false" src="attachments/28606465/28606470.png" data-image-src="attachments/28606465/28606470.png" data-unresolved-comment-count="0" data-linked-resource-id="28606470" data-linked-resource-version="2" data-linked-resource-type="attachment" data-linked-resource-default-alias="Trunk_access_setup_bad.png" data-base-url="https://help.mikrotik.com/docs" data-linked-resource-content-type="image/png" data-linked-resource-container-id="28606465" data-linked-resource-container-version="15" tabindex="0" alt=""></span></p><p style="text-align: center;">A misconfigured VLAN table allows VLAN20 to be sent through ether3, it will also allow VLAN30 through ether2</p><div role="region" aria-label="Warning" class="confluence-information-macro  confluence-information-macro-warning" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-error confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p>Don't use more than one VLAN ID specified in a bridge VLAN table entry for access ports, you should only specify multiple VLAN IDs for trunk ports.</p></div></div><p class="auto-cursor-target"><span style="letter-spacing: 0.0px;">It is not necessary to add a bridge port as an untagged port, because each bridge port is added as an untagged port dynamically with a VLAN ID that is specified in the </span>PVID <span style="letter-spacing: 0.0px;">property. This is because of a feature that automatically will add an appropriate entry in the bridge VLAN table for convenience and performance reasons, this feature does have some caveats that you must be aware of. All ports that have the same </span>PVID <span style="letter-spacing: 0.0px;">will be added to a single entry for the appropriate VLAN ID as untagged ports, but note that the </span><strong style="letter-spacing: 0.0px;">Bridge interface </strong>also<span style="letter-spacing: 0.0px;"> has a VLAN ID.</span></p><p>For testing purposes, we are going to enable VLAN filtering, but note that it might make you lose access to the device since it does not have management access configured yet (we will configure it later). It is always recommended to configure VLAN filtering while using a serial console, though you can also configure a device through a port, that is not added to a bridge. Make sure you are using a serial console or connected through a different port (that is not in a bridge) and enable VLAN filtering:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge set bridge1 vlan-filtering=yes</pre>
</div></div><p><br/></p><div role="region" aria-label="Note" class="confluence-information-macro  confluence-information-macro-note" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p>You might not lose access to the device as soon as you enable VLAN filtering, but you might get disconnected since the bridge must reset itself in order for VLAN filtering to take any effect, which will force you to reconnect (this is mostly relevant when using MAC-telnet). There is a chance you might be able to access your device using untagged traffic, this scenario is described below.</p></div></div><p>If you have enabled VLAN filtering now and printed out the current VLAN table, you would see such a table:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: text; gutter: false">[admin@MikroTik] &gt; /interface bridge vlan print
Flags: X - disabled, D - dynamic 
 #   BRIDGE                     VLAN-IDS  CURRENT-TAGGED       CURRENT-UNTAGGED
 0   bridge1                    20        ether1               ether2
 1   bridge1                    30        ether1               ether3
 2 D bridge1                    1                              bridge1
                                                               ether1</pre>
</div></div><p>There is a dynamic entry added for<span> </span><strong>VLAN1</strong><span> </span>since<span> </span><span style="color:var(--ds-background-accent-green-bolder,#1f845a);"><code>PVID=1</code></span><span> </span>is set by default to all bridge ports (including our trunk port,<span> </span><strong>ether1</strong>), but you should also notice that<span> the </span><strong>bridge1</strong><span> </span>interface (the CPU port) is also added dynamically. You should be aware that <strong>bridge1</strong> is also a bridge port and therefore might get added to the bridge VLAN table dynamically. There is a chance that you might unintentionally allow access to the device because of this feature. For example, if you have followed this guide and left<span> </span><strong>PVID=1</strong><span> </span>set for the trunk port (<strong>ether1</strong>) and did not change the<span> </span>PVID<span> </span>for the CPU port (<strong>bridge1</strong>) as well, then access through<span> </span><strong>ether1</strong><span> </span>to the device using untagged traffic is allowed, this is also visible when you print out the bridge VLAN table. This scenario is illustrated in the image below:</p><p style="text-align: center;"><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" draggable="false" src="attachments/28606465/28606471.png" data-image-src="attachments/28606465/28606471.png" data-unresolved-comment-count="0" data-linked-resource-id="28606471" data-linked-resource-version="2" data-linked-resource-type="attachment" data-linked-resource-default-alias="Trunk_access_setup_unintentional_mgmt.png" data-base-url="https://help.mikrotik.com/docs" data-linked-resource-content-type="image/png" data-linked-resource-container-id="28606465" data-linked-resource-container-version="15" tabindex="0" alt=""></span></p><p style="text-align: center;">Unintentionally allowed management access using untagged traffic through the trunk port</p><div role="region" aria-label="Warning" class="confluence-information-macro  confluence-information-macro-warning" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-error confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p>Always check the bridge VLAN table if you have not unintentionally allowed certain VLANs or untagged traffic to specific ports, especially the CPU port (bridge).</p></div></div><p>There is a simple way to prevent the bridge (CPU port) from being added as an untagged port, you can simply set the<span> </span>PVID<span> </span>on the trunk port to be different than the bridge's<span> </span>PVID<span> </span>(or change the bridge's<span> </span>PVID), but there is another option, which is more intuitive and recommended. Since you are expecting that the trunk port is only supposed to receive tagged traffic (in this example, it should only receive<span> </span><strong>VLAN20/VLAN30</strong>), but no untagged traffic, then you can use<span> </span>ingress-filtering<span> </span>along with<span> </span>frame-type<span> </span>to filter out unwanted packets, but to fully understand the behavior of ingress filtering, we must first understand the details of management access.</p><p>Management access is used to create a way to access a device through a bridge that has VLAN filtering enabled. You could simply allow untagged access and doing that is fairly simple. Let us say you wanted the workstation behind<span> </span><strong>ether3</strong><span> </span>to be able to access the device, we assumed before that the workstation is a generic computer that will not use tagged packets and therefore will only send out untagged packets, this means that we should add the CPU port (<strong>bridge1</strong>) as an untagged interface to the bridge VLAN table, to do so, simply use the same PVID value for the <strong>bridge1</strong><span> </span>and<span> </span><strong>ether3 </strong>ports and set both ports<span> </span>as untagged members for the VLAN ID. In this case, you are going to connect from<span> </span><strong>ether3</strong><span> </span>that has<span> </span><span style="color:var(--ds-background-accent-green-bolder,#1f845a);"><code>PVID=30</code></span>, so you change the configuration accordingly:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge set [find name=bridge1] pvid=30
/interface bridge vlan set [find vlan-ids=30] untagged=bridge1,ether3</pre>
</div></div><div role="region" aria-label="Note" class="confluence-information-macro  confluence-information-macro-note" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p>You can use the feature that dynamically adds untagged ports with the same<span> </span>PVID<span> </span>value, you can simply change the<span> </span>PVID<span> </span>to match between<span> </span><strong>ether3</strong><span> </span>and<span> </span><strong>bridge1</strong>.</p></div></div><p>Allowing access to the device using untagged traffic is not considered a good security practice, a much better way is to allow access to the device using a very specific VLAN sometimes called the management VLAN, in our case, this is going to be<span> </span><strong>VLAN99</strong>. This adds a significant layer of security since an attacker must guess the VLAN ID that is being used for management purposes and then guess the login credentials, on top of this you can even add another layer of security by allowing access to the device using only certain IP addresses. The purpose of this guide is to provide an in-depth explanation, for that reason, we are adding a level of complexity to our setup to understand some possible caveats that you must take into account. We are going to allow access from an access port using tagged traffic (illustrated in the image below). To allow access to the device using<span> </span><strong>VLAN99</strong><span> </span>from<span> </span><strong>ether3</strong>, we must add a proper entry in the bridge VLAN table. Additionally, a network device connected to ether3 must support VLAN tagging.</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge vlan
add bridge=bridge1 tagged=bridge1,ether3 vlan-ids=99</pre>
</div></div><p style="margin-left: 20.0px;"><br/><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" draggable="false" src="attachments/28606465/28606473.png" data-image-src="attachments/28606465/28606473.png" data-unresolved-comment-count="0" data-linked-resource-id="28606473" data-linked-resource-version="2" data-linked-resource-type="attachment" data-linked-resource-default-alias="Trunk_access_setup_mgmt_access.png" data-base-url="https://help.mikrotik.com/docs" data-linked-resource-content-type="image/png" data-linked-resource-container-id="28606465" data-linked-resource-container-version="15" tabindex="0" alt=""></span></p><p style="text-align: center;">Management access using tagged traffic through an access port (which makes it a hybrid port)</p><div role="region" aria-label="Note" class="confluence-information-macro  confluence-information-macro-note" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p>If PVID for ether1 and bridge1 matches (by default, it does match with 1), then access to the device is allowed using untagged traffic from ether1 because of the feature that dynamically adds untagged ports to the bridge VLAN table.</p></div></div><p class="auto-cursor-target"><span style="letter-spacing: 0.0px;">But you might notice that access using </span><strong style="letter-spacing: 0.0px;">VLAN99 </strong><span style="letter-spacing: 0.0px;">does not work at this point, this is because you need a VLAN interface that listens for tagged traffic, you can simply create this interface for the appropriate VLAN ID and you can set an IP address for the interface as well:</span></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface vlan
add interface=bridge1 name=VLAN99 vlan-id=99
/ip address
add address=192.168.99.2/24 interface=VLAN99</pre>
</div></div><div role="region" aria-label="Note" class="confluence-information-macro  confluence-information-macro-note" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p>Our access port (<strong>ether3</strong>) at this point expects tagged and untagged traffic at the same time, such a port is called a<span> </span><strong>hybrid port</strong>.</p></div></div><p class="auto-cursor-target"><span style="letter-spacing: 0.0px;">At this point, we can benefit from using </span><span style="color:var(--ds-background-accent-green-bolder,#1f845a);"><code>ingress-filtering</code></span> <span style="letter-spacing: 0.0px;">and </span><code><span style="color:var(--ds-background-accent-green-bolder,#1f845a);">frame-type</span></code><span style="letter-spacing: 0.0px;">. First, we are going to focus on </span><code><span style="color:var(--ds-background-accent-green-bolder,#1f845a);">frame-type</span></code><span style="letter-spacing: 0.0px;">, which limits the allowed packet types (tagged, untagged, both), but for </span><code><span style="color:var(--ds-background-accent-green-bolder,#1f845a);">frame-type</span></code> <span style="letter-spacing: 0.0px;">to work properly, </span><span style="color:var(--ds-background-accent-green-bolder,#1f845a);"><code>ingress-filtering</code></span> <span style="letter-spacing: 0.0px;">must be enabled, otherwise it will not have any effect. In our example, where we wanted to allow access from </span><strong style="letter-spacing: 0.0px;">ether3 </strong><span style="letter-spacing: 0.0px;">using tagged traffic (</span><strong style="letter-spacing: 0.0px;">VLAN99</strong><span style="letter-spacing: 0.0px;">) and at the same time allow a generic workstation to access the network, we can conclude that this port needs to allow tagged and untagged packets, but </span><strong style="letter-spacing: 0.0px;">ether1 </strong><span style="letter-spacing: 0.0px;">and </span><strong style="letter-spacing: 0.0px;">ether2 </strong><span style="letter-spacing: 0.0px;">are supposed to receive only specific types of packets, for this reasons we can enhance our network's security. Since </span><strong style="letter-spacing: 0.0px;">ether1 </strong><span style="letter-spacing: 0.0px;">is our trunk port, it is only supposed to carry tagged packets, but </span><strong style="letter-spacing: 0.0px;">ether2 </strong><span style="letter-spacing: 0.0px;">is our access port so it should not carry any tagged packets, based on these conclusions we can drop invalid packets:</span></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge port
set [find where interface=ether1] ingress-filtering=yes frame-types=admit-only-vlan-tagged
set [find where interface=ether2] ingress-filtering=yes frame-types=admit-only-untagged-and-priority-tagged</pre>
</div></div><p>Let's say that you forgot to enable<span> </span>ingress-filtering<span> </span>and change the<span> </span>frame-type<span> </span>property on<span> </span><strong>ether1</strong>, this would unintentionally add access to the device through<span> </span><strong>ether1</strong><span> </span>using untagged traffic since<span> </span>PVID<span> </span>matches for<span> </span><strong>bridge1</strong><span> </span>and<span> </span><strong>ether1</strong>, but you are expecting only tagged traffic to be able to access the device. It is possible to drop all untagged packets that are destined for the<span> </span><strong>CPU port</strong>:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge
set bridge1 frame-types=admit-only-vlan-tagged ingress-filtering=yes</pre>
</div></div><p>This does not only drop untagged packets, but disables the feature that dynamically adds untagged ports to the bridge VLAN table. If you print out the current bridge VLAN table you will notice that<span> </span><strong>bridge1</strong><span> </span>is not dynamically added as an untagged port:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: text; gutter: false">[admin@MikroTik] &gt; /interface bridge vlan print 
Flags: X - disabled, D - dynamic 
 #   BRIDGE       VLAN-IDS  CURRENT-TAGGED        CURRENT-UNTAGGED
 0   bridge1      20        ether1
 1   bridge1      30        ether1                ether3
 2 D bridge1      1                               ether1
 3   bridge1      99        bridge1
                            ether3  </pre>
</div></div><div role="region" aria-label="Note" class="confluence-information-macro  confluence-information-macro-note" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p>When<span> </span><span style="color:var(--ds-background-accent-green-bolder,#1f845a);"><code>frame-type=admit-only-vlan-tagged</code></span><span> </span>is used on a port, then the port is not dynamically added as an untagged port for the<span> </span>PVID.</p></div></div><p>While<span> </span><code><span style="color:var(--ds-background-accent-green-bolder,#1f845a);">frame-type</span></code><span> </span>can be used to drop a certain type of packet, the<span> </span><code><span style="color:var(--ds-background-accent-green-bolder,#1f845a);">ingress-filtering</span></code><span> </span>can be used to filter out packets before they can be sent out. To fully understand the need for ingress filtering, consider the following scenario:<span> </span><strong>VLAN99</strong><span> </span>is allowed on<span> </span><strong>ether3</strong><span> </span>and<span> </span><strong>bridge1</strong>, but you can still send<span> </span><strong>VLAN99</strong><span> </span>traffic from<span> </span><strong>ether1</strong><span> </span>to<span> </span><strong>ether3</strong>, this is because the bridge VLAN table checks if a port is allowed to carry a certain VLAN only on egress ports. In our case,<span> </span><strong>ether3</strong><span> </span>is allowed to carry<span> </span><strong>VLAN99</strong><span> </span>and for this reason, it is forwarded. To prevent this you<span> </span><strong>MUST</strong><span> </span>use<span> </span>ingress-filtering. With ingress filtering, ingress packets are also checked, in our case, the bridge VLAN table does not contain an entry that<span> </span><strong>VLAN99</strong><span> </span>is allowed on<span> </span><strong>ether1</strong><span> </span>and therefore will be dropped immediately. Of course, in our scenario without ingress filtering connection cannot be established since<span> </span><strong>VLAN99</strong><span> </span>can be forwarded only from<span> </span><strong>ether1</strong> to <strong>ether3</strong>, but not from<span> </span><strong>ether3</strong> to <strong>ether1</strong>, though there are still possible attacks that can be used in such a misconfiguration (for example, ARP poisoning). The packet dropping behavior is illustrated in the image below:</p><p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" draggable="false" src="attachments/28606465/28606474.png" data-image-src="attachments/28606465/28606474.png" data-unresolved-comment-count="0" data-linked-resource-id="28606474" data-linked-resource-version="2" data-linked-resource-type="attachment" data-linked-resource-default-alias="Trunk_access_setup_ingress.png" data-base-url="https://help.mikrotik.com/docs" data-linked-resource-content-type="image/png" data-linked-resource-container-id="28606465" data-linked-resource-container-version="15" tabindex="0" alt=""></span></p><p style="text-align: center;">Trunk/access port setup with and without ingress filtering. Ingress filtering can prevent unwanted traffic from being forwarded. Note that ether1 is not allowed to carry VLAN99 in the bridge VLAN table.</p><div role="region" aria-label="Warning" class="confluence-information-macro  confluence-information-macro-warning" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-error confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p>Always try to use <code><span style="color:var(--ds-background-accent-green-bolder,#1f845a);">ingress-filtering</span></code> wherever it is possible, it adds a significant layer of security.</p></div></div><p class="auto-cursor-target"><span style="letter-spacing: 0.0px;">The </span>ingress-filtering <span style="letter-spacing: 0.0px;">can be used on the </span><strong style="letter-spacing: 0.0px;">CPU port </strong><span style="letter-spacing: 0.0px;">(bridge) as well, this can be used to prevent some possible attack vectors and limit the allowed VLANs that can access the CPU. It is better to drop a packet on an ingress port, rather than on an egress port, this reduces the CPU load, which is quite crucial when you are using hardware offloading with bridge VLAN filtering.</span></p><div role="region" aria-label="Note" class="confluence-information-macro  confluence-information-macro-note" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p>The<span> </span><code><span style="color:var(--ds-background-accent-green-bolder,#1f845a);">ingress-filtering</span></code><span> </span>property only affects ingress traffic, but<span> </span><code><span style="color:var(--ds-background-accent-green-bolder,#1f845a);">frame-type</span></code><span> </span>affects both egress and ingress traffic.</p></div></div><p class="auto-cursor-target"><span style="letter-spacing: 0.0px;">Even though you can limit the allowed VLANs and packet types on a port, it is never a good security practice to allow access to a device through access ports since an attacker could sniff packets and extract the management VLAN's ID, you should only allow access to the device from the trunk port (</span><strong style="letter-spacing: 0.0px;">ether1</strong><span style="letter-spacing: 0.0px;">) since trunk ports usually have better physical security, you should remove the previous entry and allow access to the device through the port that is connected to your router (illustrated in the image below):</span></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge vlan
add bridge=bridge1 tagged=bridge1,ether1 vlan-ids=99</pre>
</div></div><p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" draggable="false" src="attachments/28606465/28606476.png" data-image-src="attachments/28606465/28606476.png" data-unresolved-comment-count="0" data-linked-resource-id="28606476" data-linked-resource-version="3" data-linked-resource-type="attachment" data-linked-resource-default-alias="Basic_vlan_switching.png" data-base-url="https://help.mikrotik.com/docs" data-linked-resource-content-type="image/png" data-linked-resource-container-id="28606465" data-linked-resource-container-version="15" tabindex="0" alt=""></span></p><h1 id="BridgeVLANTable-VLANTunnellingsetup"><span class="mw-headline">VLAN Tunnelling setup</span></h1><hr/><p>In some cases, you might want to forward already tagged traffic through certain switches. This is a quite common setup for backbone infrastructures since it provides a possibility to encapsulate traffic from, for example, your edge routers and seamlessly forward it over your backbone to another edge router. Below you can find an example of a VLAN tunneling topology:</p><p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" draggable="false" src="attachments/28606465/28606477.png" data-image-src="attachments/28606465/28606477.png" data-unresolved-comment-count="0" data-linked-resource-id="28606477" data-linked-resource-version="2" data-linked-resource-type="attachment" data-linked-resource-default-alias="Provider_bridge.png" data-base-url="https://help.mikrotik.com/docs" data-linked-resource-content-type="image/png" data-linked-resource-container-id="28606465" data-linked-resource-container-version="15" tabindex="0" alt=""></span></p><p style="text-align: center;">Provider bridge topology</p><p style="text-align: left;">SVID stands for Service VID, indicating the tag type along with the VID.</p><div role="region" aria-label="Note" class="confluence-information-macro  confluence-information-macro-note" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon" ></span><div class="confluence-information-macro-body">To fully understand how to configure VLAN tunneling properly, you should first read the<span> </span>Trunk/Access port setup<span> </span>section before proceeding any further.</div></div><p>There are two possible ways to achieve this, one is the standardized IEEE 802.1ad way, and the other way is using<span> </span><strong>Tag stacking</strong>, we will first review the standardized way since the same principles apply to both ways and only a couple of parameters must be changed to use the other method. The way VLAN tunneling works is that the bridge checks if the outer VLAN tag is using the same VLAN tag as specified as<span> </span>ether-type. If the VLAN tag matches, the packet is considered as a tagged packet, otherwise, it is considered as an untagged packet.</p><div role="region" aria-label="Note" class="confluence-information-macro  confluence-information-macro-note" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p>The bridge checks only the outer tag (closest to the MAC address), any other tag is ignored anywhere in a bridge configuration. The bridge is not aware of the packet contents, even though there might be another VLAN tag, only the first VLAN tag is checked.</p></div></div><p>The<span> </span>ether-type<span> </span>property allows you to select the following EtherTypes for the VLAN tag:</p><ul><li>0x88a8 - IEEE 802.1ad, Service Tag</li><li>0x8100 - IEEE 802.1Q, Customer VLAN (regular VLAN tag)</li><li>0x9100 - Unofficial tag type (rarely used)</li></ul><p>To properly configure bridge VLAN filtering, you must understand how the bridge distinguishes between tagged and untagged packets. As mentioned before, the bridge will check if EtherType matches with the outer VLAN tag in the packet. For example, consider the following packet:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: text; gutter: false">FFFFFFFFFFFF 6C3B6B7C413E 8100 6063 9999
----------------------------------------
DST-MAC = FFFFFFFFFFFF
SRC-MAC = 6C3B6B7C413E
Outer EtherType = 8100 (IEEE 802.1Q VLAN tag)
VLAN priority = 6
VLAN ID = 99 (HEX = 63)
Inner EtherType = 9999</pre>
</div></div><p>Let us assume that we have set<span> </span><strong><code>ether-type=0x88a8</code></strong>, in this case, the packet above will be considered untagged since the bridge is looking for a different VLAN tag. Lets now consider the following packet:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: text; gutter: false">FFFFFFFFFFFF 6C3B6B7C413E 88A8 6063 8100 5062 9999
----------------------------------------
DST-MAC = FFFFFFFFFFFF
SRC-MAC = 6C3B6B7C413E
Outer EtherType = 88A8 (IEEE 802.1ad VLAN tag)
VLAN priority = 6
VLAN ID = 99 (HEX = 63)
Inner EtherType 1 = 8100 (IEEE 802.1Q VLAN tag)
VLAN priority = 5
VLAN ID = 98 (HEX = 62)
Innter EtherType 2 = 9999</pre>
</div></div><p>This time let us assume that we have set<span> </span><strong><code>ether-type=0x8100</code></strong>, in this case, the packet above is considered as untagged as well since the outer tag is using an IEEE 802.1ad VLAN tag. The same principles apply to other VLAN related functions, for example, the<span> </span><code><span style="color:var(--ds-background-accent-green-bolder,#1f845a);">PVID</span></code><span> </span>property will add a new VLAN tag on access ports and the VLAN tag will be using the EtherType specified in<span> </span>ether-type.</p><p>Both<span> </span><strong>SW1</strong><span> </span>and<span> </span><strong>SW2</strong><span> </span>are using the same configuration:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge
add name=bridge1 vlan-filtering=yes ether-type=0x88a8
/interface bridge port
add interface=ether1 bridge=bridge1 pvid=200
add interface=ether2 bridge=bridge1 pvid=300
add interface=ether3 bridge=bridge1
/interface bridge vlan
add bridge=bridge1 tagged=ether3 untagged=ether1 vlan-ids=200
add bridge=bridge1 tagged=ether3 untagged=ether2 vlan-ids=300</pre>
</div></div><p>In this example, we are assuming that all routers are passing traffic that is using a regular/customer VLAN tag. Such traffic on switches will be considered as untagged traffic based on the principle described above. Switches will encapsulate this traffic using a Service VLAN tag (the outer 802.1ad tag) and traffic between <strong>SW1</strong><span> </span>and<span> </span><strong>SW2</strong><span> </span>will be considered as tagged. Before traffic reaches its destination, the switches will decapsulate the outer tag and forward the original 802.1Q tagged frame. See a packet example below:</p><p style="text-align: center;"><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" draggable="false" src="attachments/28606465/28606478.png" data-image-src="attachments/28606465/28606478.png" data-unresolved-comment-count="0" data-linked-resource-id="28606478" data-linked-resource-version="3" data-linked-resource-type="attachment" data-linked-resource-default-alias="Service_VLAN_8021ad.png" data-base-url="https://help.mikrotik.com/docs" data-linked-resource-content-type="image/png" data-linked-resource-container-id="28606465" data-linked-resource-container-version="15" tabindex="0" alt=""></span>A packet example before and after 802.1ad VLAN encapsulation </p><div role="region" aria-label="Note" class="confluence-information-macro  confluence-information-macro-note" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p>All principles that apply to the regular trunk/access port setup using IEEE 802.1Q also apply to VLAN tunneling setups, make sure you are limiting VLANs and packet type properly using the bridge VLAN table and ingress filtering.</p></div></div><p>In case you want to create management access from, let's say,<span> </span><strong>ether3</strong><span> </span>to the device and want to use<span> </span><strong>VLAN99</strong>, then you would use such commands:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge vlan
add bridge=bridge1 tagged=bridge1,ether3 vlan-ids=99
/interface vlan
add interface=bridge1 name=VLAN99 use-service-tag=yes vlan-id=99
/ip address
add address=192.168.99.2/24 interface=VLAN99</pre>
</div></div><p>As you may notice, the only difference is that the VLAN interface is using<span> </span><span style="color:var(--ds-background-accent-green-bolder,#1f845a);"><code>use-service-tag=yes</code></span>, this sets the VLAN interface to listen to IEEE 802.1ad VLAN tags. This will require you to use the IEEE 802.1ad VLAN tag to access the device using the management VLAN - you will not be able to connect to the device using a regular VLAN tag while bridge VLAN filtering is enabled. The<span> </span>ether-type<span> </span>is set globally and will affect all bridge VLAN filtering functions.</p><div role="region" aria-label="Warning" class="confluence-information-macro  confluence-information-macro-warning" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-error confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p>Devices with switch chip Marvell-98DX3257 (e.g. CRS354 series) do not support VLAN filtering on 1Gbps Ethernet interfaces for other VLAN types (<span style="color:var(--ds-background-accent-green-bolder,#1f845a);"><code>0x88a8</code></span><span> </span>and<span> </span><span style="color:var(--ds-background-accent-green-bolder,#1f845a);"><code>0x9100</code></span>).</p></div></div><h2 id="BridgeVLANTable-TagStacking"><span class="mw-headline">Tag Stacking</span></h2><p>In the<span> </span>VLAN Tunnelling setup,<span> </span>we were adding a new VLAN tag that was different from the VLAN tag, but it is possible to add a new VLAN tag regardless of the packet contents. The difference between the regular VLAN tunneling setup is that the bridge does not check if the packet is tagged or untagged, it assumes that all packets that are received on a specific port are all untagged packets and will add a new VLAN tag regardless of whether a VLAN tag is present or not, this is called<span> </span><strong>Tag Stacking</strong><span> </span>since it &quot;stacks&quot; VLAN tags on top of the previous tag, regardless of the VLAN tag type. This is a very common setup for networks that do not support the IEEE 802.1ad standard, but still want to encapsulate VLAN traffic into a new VLAN.</p><p>The VLAN tag that is going to be added depends on<span> </span><code><span style="color:var(--ds-background-accent-green-bolder,#1f845a);">ether-type</span></code><span> </span>and<span> </span><code><span style="color:var(--ds-background-accent-green-bolder,#1f845a);">PVID</span></code>. For example, if you have<span> </span><span style="color:var(--ds-background-accent-green-bolder,#1f845a);"><code>ether-type=0x8100</code></span><span> </span>and<span> </span><span style="color:var(--ds-background-accent-green-bolder,#1f845a);"><code>PVID=200</code></span><span> </span>on a port, then the bridge will add a new IEEE 802.1Q VLAN tag right on top of any other tag (if such are present). The same VLAN filtering principles still apply, you have to determine which ports are going to be your trunk ports and mark them as tagged ports, determine your access ports, and add them as untagged ports.</p><p>To explain how VLAN tagging and untagging works with tag stacking, let us use the same network topology as before:</p><p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" draggable="false" src="attachments/28606465/62390283.png" data-image-src="attachments/28606465/62390283.png" data-unresolved-comment-count="0" data-linked-resource-id="62390283" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="Basic_vlan_switching2.png" data-base-url="https://help.mikrotik.com/docs" data-linked-resource-content-type="image/png" data-linked-resource-container-id="28606465" data-linked-resource-container-version="15" tabindex="0" alt=""></span></p><p>What we want to achieve is that regardless of what is being received on<span> </span><strong>ether2</strong><span> </span>and<span> </span><strong>ether3</strong>, a new VLAN tag will be added to encapsulate the traffic that is coming from those ports. <code><span style="color:var(--ds-background-accent-green-bolder,#1f845a);">Tag-stacking</span></code> forces a new VLAN tag, so we can use this property to achieve our desired setup. We are going to be using the same configuration as in the<span> </span>Trunk/Access port setup, but with <code><span style="color:var(--ds-background-accent-green-bolder,#1f845a);">tag-stacking</span></code> enabled on the access ports:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge
add name=bridge1 vlan-filtering=yes ether-type=0x8100
/interface bridge port
add bridge=bridge1 interface=ether1
add bridge=bridge1 interface=ether2 tag-stacking=yes pvid=20
add bridge=bridge1 interface=ether3 tag-stacking=yes pvid=30
/interface bridge vlan
add bridge=bridge1 tagged=ether1 untagged=ether2 vlan-ids=20
add bridge=bridge1 tagged=ether1 untagged=ether3 vlan-ids=30</pre>
</div></div><div role="region" aria-label="Note" class="confluence-information-macro  confluence-information-macro-note" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p>The added VLAN tag will use the specified<span> </span><code><span style="color:var(--ds-background-accent-green-bolder,#1f845a);">ether-type</span></code>. The selected EtherType will also be used for VLAN filtering. Only the outer tag is checked, but with tag-stacking in place, the tag checking is skipped and assumes that a new tag must be added either way.</p></div></div><p>Let us assume that the devices behind<span> </span><strong>ether2</strong><span> </span>and<span> </span><strong>ether3</strong><span> </span>are sending tagged<span> </span><strong>VLAN40</strong><span> </span>traffic. With this configuration,<span> </span><strong>ALL</strong><span> </span>packets will get encapsulated with a new VLAN tag, but you must make sure that you have added the VLAN ID from the outer tag to the bridge VLAN table. The<span> </span><strong>VLAN40</strong><span> </span>is not added to the bridge VLAN table since it is the inner tag and it is not checked, we are only concerned about the outer tag, which is either<span> </span><strong>VLAN20</strong><span> </span>or<span> </span><strong>VLAN30</strong><span> </span>depending on the port.</p><p>Similar to other setups, the bridge VLAN table is going to be used to determine if the VLAN tag needs to be removed or not. For example,<span> </span><strong>ether1</strong><span> </span>receives tagged<span> </span><strong>VLAN20</strong><span> </span>packets, the bridge checks that<span> </span><strong>ether2</strong><span> </span>is allowed to carry<span> </span><strong>VLAN20</strong><span> </span>so it is about to send it out through<span> </span><strong>ether2</strong>, but it also checks the bridge VLAN table whether the VLAN tag should be removed and since<span> </span><strong>ether2</strong><span> </span>is marked as an untagged port, then the bridge will forward these packets from<span> </span><strong>ether1</strong><span> </span>to<span> </span><strong>ether2</strong><span> </span>without the<span> </span><strong>VLAN20</strong><span> </span>VLAN tag.</p><p>From the access port perspective, the same principles as in the<span> </span>Trunk/Access port setup<span> </span>apply. All packets that are received on<span> </span><strong>ether2</strong><span> </span>will get a new VLAN tag with the VLAN ID that is specified in<span> </span>PVID, in this case, a new VLAN tag will be added with<span> </span><strong>VLAN20</strong><span> </span>and this VLAN will be subjected to VLAN filtering. See a packet example below:</p><p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" draggable="false" src="attachments/28606465/28606483.png" data-image-src="attachments/28606465/28606483.png" data-unresolved-comment-count="0" data-linked-resource-id="28606483" data-linked-resource-version="2" data-linked-resource-type="attachment" data-linked-resource-default-alias="Tag_stacking.png" data-base-url="https://help.mikrotik.com/docs" data-linked-resource-content-type="image/png" data-linked-resource-container-id="28606465" data-linked-resource-container-version="15" tabindex="0" alt=""></span></p><p style="text-align: center;">A packet example before and after tag stacking</p>
                    </div>

                                                            <div class="pageSection group">
                        <div class="pageSectionHeader">
                            <h2 id="attachments" class="pageSectionTitle">Attachments:</h2>
                        </div>

                        <div class="greybox" align="left">
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/28606465/62390277.png">Trunk_access_setup.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/28606465/62390278.png">Trunk_access_setup_bad.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/28606465/62390280.png">Trunk_access_setup_unintentional_mgmt.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/28606465/62390279.png">Trunk_access_setup_mgmt_access.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/28606465/62390281.png">Trunk_access_setup_ingress.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/28606465/28606482.png">Basic_vlan_switching.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/28606465/62390284.png">Provider_bridge.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/28606465/28606479.png">Service_VLAN_8021ad.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/28606465/28606481.png">Service_VLAN_8021ad.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/28606465/28606478.png">Service_VLAN_8021ad.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/28606465/62390282.png">Basic_vlan_switching.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/28606465/28606484.png">Tag_stacking.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/28606465/28606483.png">Tag_stacking.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/28606465/28606467.png">Trunk_access_setup.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/28606465/28606470.png">Trunk_access_setup_bad.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/28606465/28606473.png">Trunk_access_setup_mgmt_access.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/28606465/28606471.png">Trunk_access_setup_unintentional_mgmt.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/28606465/28606474.png">Trunk_access_setup_ingress.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/28606465/28606476.png">Basic_vlan_switching.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/28606465/62390283.png">Basic_vlan_switching2.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/28606465/28606477.png">Provider_bridge.png</a> (image/png)
                                <br/>
                                                    </div>
                    </div>
                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on May 20, 2025 14:53</p>
                    <div id="footer-logo"><a href="https://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
