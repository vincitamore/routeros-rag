<!DOCTYPE html>
<html>
    <head>
        <title>RouterOS : Virtual Routing and Forwarding - VRF</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">RouterOS</a></span>
                            </li>
                                                    <li>
                                <span><a href="RouterOS_328059.html">RouterOS</a></span>
                            </li>
                                                    <li>
                                <span><a href="Routing_328222.html">Routing</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            RouterOS : Virtual Routing and Forwarding - VRF
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
    
        
    
        
        
            Created by <span class='author'> MƒÅris B.</span>, last updated on May 15, 2025
    
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <p><span class="mw-headline"><style type='text/css'>/*<![CDATA[*/
div.rbtoc1747742031346 {padding: 0px;}
div.rbtoc1747742031346 ul {margin-left: 0px;}
div.rbtoc1747742031346 li {margin-left: 0px;padding-left: 0px;}

/*]]>*/</style><div class='toc-macro rbtoc1747742031346'>
<ul class='toc-indentation'>
<li><a href='#VirtualRoutingandForwardingVRF-Description'>Description</a></li>
<li><a href='#VirtualRoutingandForwardingVRF-Configuration'>Configuration</a></li>
<li><a href='#VirtualRoutingandForwardingVRF-Supportedfeatures'>Supported features</a></li>
<li><a href='#VirtualRoutingandForwardingVRF-VRFinterfacesinfirewall'>VRF interfaces in firewall</a></li>
<li><a href='#VirtualRoutingandForwardingVRF-Examples'>Examples</a>
<ul class='toc-indentation'>
<li><a href='#VirtualRoutingandForwardingVRF-SimpleVRF-Litesetup'>Simple VRF-Lite setup</a></li>
<li><a href='#VirtualRoutingandForwardingVRF-Staticinter-VRFroutes'>Static inter-VRF routes</a></li>
<li><a href='#VirtualRoutingandForwardingVRF-StaticVRF-LiteConnectedrouteleaking'>Static VRF-Lite Connected route leaking</a></li>
<li><a href='#VirtualRoutingandForwardingVRF-DynamicVrf-Literouteleaking'>Dynamic Vrf-Lite route leaking</a></li>
<li><a href='#VirtualRoutingandForwardingVRF-DynamicVrf-Literouteleaking(oldworkaround)'>Dynamic Vrf-Lite route leaking (old workaround)</a></li>
<li><a href='#VirtualRoutingandForwardingVRF-ThesimplestMPLSVPNsetup'>The simplest MPLS VPN setup</a>
<ul class='toc-indentation'>
<li><a href='#VirtualRoutingandForwardingVRF-CE1Router'>CE1 Router</a></li>
<li><a href='#VirtualRoutingandForwardingVRF-CE2Router'>CE2 Router</a></li>
<li><a href='#VirtualRoutingandForwardingVRF-PE1Router'>PE1 Router</a></li>
<li><a href='#VirtualRoutingandForwardingVRF-PE2Router(Cisco)'>PE2 Router (Cisco)</a></li>
</ul>
</li>
<li><a href='#VirtualRoutingandForwardingVRF-Amorecomplicatedsetup(changesonly)'>A more complicated setup (changes only)</a>
<ul class='toc-indentation'>
<li><a href='#VirtualRoutingandForwardingVRF-CE1Router,cust-one'>CE1 Router, cust-one</a></li>
<li><a href='#VirtualRoutingandForwardingVRF-CE2Router,cust-one'>CE2 Router, cust-one</a></li>
<li><a href='#VirtualRoutingandForwardingVRF-PE1Router.1'>PE1 Router</a></li>
</ul>
</li>
<li><a href='#VirtualRoutingandForwardingVRF-Variation:replacetheCiscowithanotherMT'>Variation: replace the Cisco with another MT</a>
<ul class='toc-indentation'>
<li><a href='#VirtualRoutingandForwardingVRF-PE2Mikrotikconfig'>PE2 Mikrotik config</a></li>
</ul>
</li>
<li><a href='#VirtualRoutingandForwardingVRF-UniqueRDper-sitevsuniqueRDper-customer'>Unique RD per-site vs unique RD per-customer</a></li>
</ul>
</li>
<li><a href='#VirtualRoutingandForwardingVRF-References'>References</a></li>
</ul>
</div></span></p><h1 id="VirtualRoutingandForwardingVRF-Description"><span class="mw-headline">Description</span></h1><p>RouterOS allows to create multiple Virtual Routing and Forwarding instances on a single router. This is useful for BGP-based MPLS VPNs. Unlike BGP VPLS, which is OSI Layer 2 technology, BGP VRF VPNs work in Layer 3 and as such exchange IP prefixes between routers. VRFs solve the problem of overlapping IP prefixes and provide the required privacy (via separated routing for different VPNs).</p><p>It is possible to set up vrf-lite setups or use multi-protocol BGP with VPNv4 address family to distribute routes from VRF routing tables - not only to other routers, but also to different routing tables in the router itself.</p><h1 id="VirtualRoutingandForwardingVRF-Configuration">Configuration</h1><p>VRF table is created in<span> </span><strong><span style="color:var(--ds-text-accent-blue,#0055cc);"><code>/ip vrf</code></span></strong> menu. After the VRF config is created routing table mapping is added (a dynamic table with the same name is created). Each active VRF will always have a mapped routing table.</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">[admin@arm-bgp] /ip/vrf&gt; print 
Flags: X - disabled; * - builtin 
 0  * name=&quot;main&quot; interfaces=all  

[admin@arm-bgp] /routing/table&gt; print 
Flags: D - dynamic; X - disabled, I - invalid; U - used 
 0 D   name=&quot;main&quot; fib 

</pre>
</div></div><p>Note that the order of the added VRFs is significant. To properly match which interface will belong to the VRF care must be taken to place VRFs in the correct order (matching is done starting from the top entry, just like firewall rules).</p><div role="region" aria-label="Warning" class="confluence-information-macro  confluence-information-macro-warning" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-error confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p>Since each VRF has mapped routing table, count of max unique VRFs is limited to 1024.</p></div></div><p><br/></p><p>Let's look at the following example:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">[admin@arm-bgp] /ip/vrf&gt; print 
Flags: X - disabled; * - builtin 
 0  * name=&quot;main&quot; interfaces=all 
 1    name=&quot;myVrf&quot; interfaces=lo_vrf  </pre>
</div></div><p>Since the first entry is matching all the interfaces, the second VRF will not have any interfaces added. To fix the problem order of the entries must be changed.</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">[admin@arm-bgp] /ip/vrf&gt; move 1 0
[admin@arm-bgp] /ip/vrf&gt; print 
Flags: X - disabled; * - builtin 
 0    name=&quot;myVrf&quot; interfaces=lo_vrf  
 1  * name=&quot;main&quot; interfaces=all   </pre>
</div></div><p>Connected routes from the interfaces assigned to the VRF will be installed in the right routing table automatically.</p><div role="region" aria-label="Note" class="confluence-information-macro  confluence-information-macro-note" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p>When the interface is assigned to the VRF as well as connected routes it does not mean that RouterOS services will magically know which VRF to use just by specifying the IP address in the configuration. Each service needs VRF support to be added and explicit configuration. Whether the service has VRF support and has VRF configuration options refer to appropriate service documentation.</p></div></div><p>For example, let's make an SSH service to listen for connections on the interfaces belonging to the VRF:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">[admin@arm-bgp] /ip/service&gt; set ssh vrf=myVrf 
[admin@arm-bgp] /ip/service&gt; print 
Flags: X, I - INVALID
Columns: NAME, PORT, CERTIFICATE, VRF
#   NAME     PORT  CERTIFICATE  VRF     
0   telnet     23               main    
1   ftp        21                       
2   www        80               main    
3   ssh        22               myVrf
4 X www-ssl   443  none         main    
5   api      8728               main    
6   winbox   8291               main    
7   api-ssl  8729  none         main  </pre>
</div></div><p>Adding routes to the VRF is as simple as specifying the routing-table parameter when adding the route and specifying in which routing table to resolve the gateway by specifying <span style="color:var(--ds-background-accent-orange-bolder,#c25100);">@name</span> after the gateway IP:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/ip route add dst-address=192.168.1.0/24 gateway=172.16.1.1@myVrf routing-table=myVrf</pre>
</div></div><p>Traffic leaking between VRFs is possible if the gateway is explicitly set to be resolved in another VRF, for example:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false"># add route in the myVrf, but resolve the gateway in the main table
/ip route add dst-address=192.168.1.0/24 gateway=172.16.1.1@main routing-table=myVrf

# add route in the main table, but resolve the gateway in the myVrf
/ip route add dst-address=192.168.1.0/24 gateway=172.16.1.1@myVrf</pre>
</div></div><div role="region" aria-label="Note" class="confluence-information-macro  confluence-information-macro-note" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p>If the gateway configuration does not have an explicitly configured table to be resolved in, then it is considered, that gateway should be resolved in the &quot;main&quot; table.</p></div></div><h1 id="VirtualRoutingandForwardingVRF-Supportedfeatures">Supported features</h1><p>Different services can be placed in specific VRF on which the service is listening for incoming or creating outgoing connections. By default, all services are using the <span style="color:var(--ds-text-accent-magenta,#943d73);"><code>main</code></span> table, but it can be changed with a separate <span style="color:var(--ds-icon-success,#22a06b);"><code>vrf</code></span> parameter or by specifying the VRF name separated by &quot;@&quot; at the end of the IP address.</p><p>Below is the list of supported services.</p><div class="table-wrap"><table class="relative-table wrapped confluenceTable" style="width: 32.8849%;"><colgroup><col style="width: 17.2739%;"/><col style="width: 14.8364%;"/><col style="width: 67.8764%;"/></colgroup><thead><tr><th style="text-align: left;" class="confluenceTh"><p>Feature</p></th><th style="text-align: left;" class="confluenceTh"><p>Support</p></th><th style="text-align: left;" class="confluenceTh"><p>Comment</p></th></tr></thead><tbody><tr><td style="text-align: left;" class="confluenceTd"><strong><a href="https://help.mikrotik.com/docs/display/ROS/BGP" rel="nofollow">BGP</a></strong></td><td class="highlight-#e3fcef confluenceTd" data-highlight-colour="#e3fcef" style="text-align: center;" title="Background color : Light green 35%">+</td><td style="text-align: left;" class="confluenceTd"><div class="content-wrapper"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/routing bgp template
add name=bgp-template1 vrf=vrf1
/routing bgp vpls
add name=bgp-vpls1 site-id=10 vrf=vrf1
/routing bgp vpn
add label-allocation-policy=per-vrf vrf=vrf1</pre>
</div></div></div></td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong><a href="https://help.mikrotik.com/docs/display/ROS/E-mail" rel="nofollow">E-mail</a></strong></td><td class="highlight-#e3fcef confluenceTd" data-highlight-colour="#e3fcef" style="text-align: center;">+</td><td style="text-align: left;" class="confluenceTd"><div class="content-wrapper"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/tool e-mail
set address=192.168.88.1 vrf=vrf1</pre>
</div></div></div></td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong><a href="https://help.mikrotik.com/docs/display/ROS/Services" rel="nofollow">IP Services</a></strong></td><td class="highlight-#e3fcef confluenceTd" data-highlight-colour="#e3fcef" style="text-align: center;">+</td><td style="text-align: left;" class="confluenceTd"><div class="content-wrapper"><p class="auto-cursor-target">VRF is supported for <code>telnet</code>, <code>www</code>, <code>ssh</code>, <code>www-ssl</code>, <code>api</code>, <code>winbox</code>, <code>api-ssl</code> services. The <code>ftp</code> service does not support changing the VRF.</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/ip service
set telnet vrf=vrf1</pre>
</div></div></div></td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong><a href="https://help.mikrotik.com/docs/display/ROS/L2TP" rel="nofollow">L2TP Client</a></strong></td><td class="highlight-#e3fcef confluenceTd" data-highlight-colour="#e3fcef" style="text-align: center;" title="Background color : Light green 35%">+</td><td style="text-align: left;" class="confluenceTd"><div class="content-wrapper"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface l2tp-client
add connect-to=192.168.88.1@vrf1 name=l2tp-out1 user=l2tp-client </pre>
</div></div></div></td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong><a href="https://help.mikrotik.com/docs/display/ROS/Mpls+Overview" rel="nofollow">MPLS</a></strong></td><td class="highlight-#e3fcef confluenceTd" data-highlight-colour="#e3fcef" style="text-align: center;" title="Background color : Light green 35%">+</td><td style="text-align: left;" class="confluenceTd"><div class="content-wrapper"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/mpls ldp
add vrf=vrf1</pre>
</div></div></div></td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong><a href="https://help.mikrotik.com/docs/display/ROS/Netwatch" rel="nofollow">Netwatch</a></strong></td><td class="highlight-#e3fcef confluenceTd" data-highlight-colour="#e3fcef" style="text-align: left;" title="Background color : Light green 35%"><p style="text-align: center;" title="">+</p></td><td style="text-align: left;" class="confluenceTd"><div class="content-wrapper"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/tool netwatch
add host=192.168.88.1@vrf1</pre>
</div></div></div></td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong><a href="https://help.mikrotik.com/docs/pages/viewpage.action?pageId=40992869" rel="nofollow">NTP</a></strong></td><td class="highlight-#e3fcef confluenceTd" data-highlight-colour="#e3fcef" style="text-align: left;" title="Background color : Light green 35%"><p style="text-align: center;" title="">+</p></td><td style="text-align: left;" class="confluenceTd"><div class="content-wrapper"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/system ntp client
set vrf=vrf1
/system ntp server
set vrf=vrf1</pre>
</div></div></div></td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong><a href="https://help.mikrotik.com/docs/display/ROS/OSPF" rel="nofollow">OSPF</a></strong></td><td class="highlight-#e3fcef confluenceTd" data-highlight-colour="#e3fcef" style="text-align: left;"><p style="text-align: center;" title="">+</p></td><td style="text-align: left;" class="confluenceTd"><div class="content-wrapper"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/routing ospf instance
add disabled=no name=ospf-instance-1 vrf=vrf1</pre>
</div></div></div></td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong><a href="https://help.mikrotik.com/docs/display/ROS/Ping" rel="nofollow">ping</a></strong></td><td class="highlight-#e3fcef confluenceTd" data-highlight-colour="#e3fcef" style="text-align: left;"><p style="text-align: center;" title="">+</p></td><td style="text-align: left;" class="confluenceTd"><div class="content-wrapper"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/ping 192.168.88.1 vrf=vrf1</pre>
</div></div></div></td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong><a href="https://help.mikrotik.com/docs/display/ROS/RADIUS" rel="nofollow">RADIUS</a></strong></td><td class="highlight-#e3fcef confluenceTd" data-highlight-colour="#e3fcef" style="text-align: left;"><p style="text-align: center;" title="">+</p></td><td style="text-align: left;" class="confluenceTd"><div class="content-wrapper"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/radius add address=192.168.88.1@vrf1
/radius incoming set vrf=vrf1</pre>
</div></div></div></td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong><a href="https://help.mikrotik.com/docs/display/ROS/RIP" rel="nofollow">RIP</a></strong></td><td class="highlight-#e3fcef confluenceTd" data-highlight-colour="#e3fcef" style="text-align: left;" title="Background color : Light green 35%"><p style="text-align: center;" title="">+</p></td><td style="text-align: left;" class="confluenceTd"><div class="content-wrapper"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/routing rip instance
add name=rip-instance-1 vrf=vrf1</pre>
</div></div></div></td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong><a href="https://help.mikrotik.com/docs/display/ROS/RPKI" rel="nofollow">RPKI</a></strong></td><td class="highlight-#e3fcef confluenceTd" data-highlight-colour="#e3fcef" style="text-align: left;" title="Background color : Light green 35%"><p style="text-align: center;" title="">+</p></td><td style="text-align: left;" class="confluenceTd"><div class="content-wrapper"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/routing rpki
add vrf=vrf1</pre>
</div></div></div></td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong><a href="https://help.mikrotik.com/docs/display/ROS/SNMP" rel="nofollow">SNMP</a></strong></td><td class="highlight-#e3fcef confluenceTd" data-highlight-colour="#e3fcef" style="text-align: left;"><p style="text-align: center;" title="">+</p></td><td style="text-align: left;" class="confluenceTd"><div class="content-wrapper"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/snmp
set vrf=vrf1</pre>
</div></div></div></td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong><a href="https://help.mikrotik.com/docs/display/ROS/EoIP" rel="nofollow">EoIP</a></strong></td><td class="highlight-#e3fcef confluenceTd" data-highlight-colour="#e3fcef" style="text-align: left;" title="Background color : Light green 35%"><p style="text-align: center;" title="">+</p></td><td style="text-align: left;" class="confluenceTd"><div class="content-wrapper"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface eoip
add remote-address=192.168.1.1@vrf1</pre>
</div></div></div></td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong><a href="https://help.mikrotik.com/docs/display/ROS/IPIP" rel="nofollow">IPIP</a></strong></td><td class="highlight-#e3fcef confluenceTd" data-highlight-colour="#e3fcef" style="text-align: left;" title="Background color : Light green 35%"><p style="text-align: center;" title="">+</p></td><td style="text-align: left;" class="confluenceTd"><div class="content-wrapper"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface ipip 
add remote-address=192.168.1.1@vrf1</pre>
</div></div></div></td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong><a href="https://help.mikrotik.com/docs/display/ROS/GRE" rel="nofollow">GRE</a></strong></td><td class="highlight-#e3fcef confluenceTd" data-highlight-colour="#e3fcef" style="text-align: left;" title="Background color : Light green 35%"><p style="text-align: center;" title="">+</p></td><td style="text-align: left;" class="confluenceTd"><div class="content-wrapper"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface gre 
add remote-address=192.168.1.1@vrf1</pre>
</div></div></div></td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong><a href="https://help.mikrotik.com/docs/display/ROS/SSTP#SSTP-SSTPClient" rel="nofollow">SSTP-client</a></strong></td><td class="highlight-#e3fcef confluenceTd" data-highlight-colour="#e3fcef" style="text-align: left;" title="Background color : Light green 35%"><p style="text-align: center;" title="">+</p></td><td style="text-align: left;" class="confluenceTd"><div class="content-wrapper"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface sstp-client 
add connect-to=192.168.1.1@vrf1</pre>
</div></div></div></td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong><a href="https://help.mikrotik.com/docs/display/ROS/OpenVPN#OpenVPN-OVPNClient" rel="nofollow">OVPN-client</a></strong></td><td class="highlight-#e3fcef confluenceTd" data-highlight-colour="#e3fcef" style="text-align: left;" title="Background color : Light green 35%"><p style="text-align: center;" title="">+</p></td><td style="text-align: left;" class="confluenceTd"><div class="content-wrapper"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface ovpn-client
add connect-to=192.168.1.1@vrf1</pre>
</div></div></div></td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong><span style="color:var(--ds-text,#172b4d);">L2TP-ether</span></strong></td><td class="highlight-#e3fcef confluenceTd" data-highlight-colour="#e3fcef" style="text-align: left;" title="Background color : Light green 35%"><p style="text-align: center;" title="">+</p></td><td style="text-align: left;" class="confluenceTd"><div class="content-wrapper"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface l2tp-ether
add connect-to=192.168.2.2@vrf</pre>
</div></div></div></td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong><span style="color:var(--ds-text,#172b4d);"><a href="https://help.mikrotik.com/docs/display/ROS/VXLAN" rel="nofollow">VXLAN</a></span></strong></td><td class="highlight-#e3fcef confluenceTd" data-highlight-colour="#e3fcef" style="text-align: left;" title="Background color : Light green 35%"><p style="text-align: center;" title="">+</p></td><td style="text-align: left;" class="confluenceTd"><div class="content-wrapper"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface vxlan
add vni=10 vrf=vrf1</pre>
</div></div></div></td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong><span style="color:var(--ds-text,#172b4d);"><a href="https://help.mikrotik.com/docs/display/ROS/Fetch" rel="nofollow">Fetch</a></span></strong></td><td class="highlight-#e3fcef confluenceTd" data-highlight-colour="#e3fcef" style="text-align: left;" title="Background color : Light green 35%"><p style="text-align: center;" title="">+</p></td><td style="text-align: left;" class="confluenceTd"><div class="content-wrapper"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/tool/fetch
address=10.155.28.236@vrf1 mode=ftp src-path=my_file.pcap user=admin password=&quot;&quot;</pre>
</div></div></div></td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong><span style="color:var(--ds-text,#172b4d);"><a href="DNS_37748767.html">DNS</a></span></strong></td><td class="highlight-#ffe380 confluenceTd" data-highlight-colour="#ffe380" style="text-align: left;"><p style="text-align: center;" title="">+</p><p style="text-align: center;" title=""><span style="color:var(--ds-text,#172b4d);">Starting from RouterOS v7.15</span></p></td><td style="text-align: left;" class="confluenceTd"><div class="content-wrapper"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/ip dns set vrf=vrf1</pre>
</div></div></div></td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong><span style="color:var(--ds-text,#172b4d);"><a href="DHCP_24805500.html">DHCP-Relay</a></span></strong></td><td class="highlight-#ffe380 confluenceTd" data-highlight-colour="#ffe380" style="text-align: left;"><p style="text-align: center;" title="">+</p><p style="text-align: center;" title=""><span style="color:var(--ds-text,#172b4d);">Starting from RouterOS v7.15</span></p></td><td style="text-align: left;" class="confluenceTd"><div class="content-wrapper"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/ip dhcp-relay set dhcp-server-vrf=vrf1</pre>
</div></div><em>If dhcp-client is in vrf - special parameter in¬†</em><em>&quot;ip dhcp-relay&quot; configuration is not needed</em></div></td></tr></tbody></table></div><h1 style="text-decoration: none;text-align: left;" id="VirtualRoutingandForwardingVRF-VRFinterfacesinfirewall">VRF interfaces in firewall</h1><div role="region" aria-label="Warning" class="confluence-information-macro  confluence-information-macro-warning" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-error confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p>Before RouterOS version 7.14, firewall filter rules with the property in/out-interface would apply to interfaces within a VRF instance. Starting from RouterOS version 7.14, these rules no longer target individual interfaces within a VRF, but rather the VRF interface as a whole.</p></div></div><p style="text-align: left;"><br/></p><p style="text-align: left;">Started from version 7.14 when interfaces are added in VRF - virtual VRF interface is created automatically. If it is needed to match traffic which belongs to VRF interface, VRF virtual interface should be used in firewall filters, for example:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/ip vrf add interfaces=ether5 name=vrf5
/ip firewall filter add chain=input in-interface=vrf5 action=accept</pre>
</div></div><p style="text-align: left;">If there are several interfaces in one VRF but it is needed to match only one of these interfaces - marks should be used. For example:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/ip vrf add interface=ether15,ether16 vrf=vrf1516
/ip firewall mangle
add action=mark-connection chain=prerouting connection-state=new in-interface=ether15 new-connection-mark=input_allow passthrough=yes 
/ip firewall filter
add action=accept chain=input connection-mark=input_allow</pre>
</div></div><h1 id="VirtualRoutingandForwardingVRF-Examples"><span class="mw-headline">Examples</span></h1><h2 id="VirtualRoutingandForwardingVRF-SimpleVRF-Litesetup"><span class="mw-headline">Simple VRF-Lite setup</span></h2><p><span class="mw-headline">Let's consider a setup where we need two customer VRFs that require access to the internet:<br/></span></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/ip address
add address=172.16.1.2/24 interface=public
add address=192.168.1.1/24 interface=ether1
add address=192.168.2.1/24 interface=ether2

/ip route
add gateway=172.16.1.1

# add VRF configuration
/ip vrf
add name=cust_a interface=ether1 place-before 0
add name=cust_b interface=ether2 place-before 0

# add vrf routes
/ip route
add gateway=172.16.1.1@main routing-table=cust_a
add gateway=172.16.1.1@main routing-table=cust_b

# masquerade local source
/ip firewall nat add chain=srcnat out-interface=public action=masquerade</pre>
</div></div><p>It might be necessary to ensure that packets coming in the &quot;public&quot; interface can actually reach the correct VRF.¬†<br/>This can be solved by marking new connections originated by the VRF customers and steering the traffic by routing marks of incoming packets on the &quot;public&quot; interface.</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false"># mark new customer connections
/ip firewall mangle 
add action=mark-connection chain=prerouting connection-state=new new-connection-mark=\
    cust_a_conn src-address=192.168.1.0/24 passthrough=no
add action=mark-connection chain=prerouting connection-state=new new-connection-mark=\
    cust_b_conn src-address=192.168.2.0/24 passthrough=no 

# mark routing
/ip firewall mangle  
add action=mark-routing chain=prerouting connection-mark=cust_a_conn \
    in-interface=public new-routing-mark=cust_a
add action=mark-routing chain=prerouting connection-mark=cust_b_conn \
    in-interface=public new-routing-mark=cust_b</pre>
</div></div><h2 style="text-decoration: none;text-align: left;" id="VirtualRoutingandForwardingVRF-Staticinter-VRFroutes"><span>Static inter-VRF routes</span></h2><p style="text-align: left;">In general, it is recommended that all routes between VRF should be exchanged using BGP local import and export functionality. If that is not enough, static routes can be used to achieve this so-called route leaking.</p><p style="text-align: left;">There are two ways to install a route that has a gateway in a different routing table than the route itself.</p><p style="text-align: left;">The first way is to explicitly specify the routing table in the gateway field when adding a route. This is only possible when leaking a route and gateway from the &quot;main&quot; routing table to a different routing table (VRF). Example:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false"># add route to 5.5.5.0/24 in &#39;vrf1&#39; routing table with gateway in the main routing table 
add dst-address=5.5.5.0/24 gateway=10.3.0.1@main routing-table=vrf1</pre>
</div></div><p style="text-align: left;"><br/></p><p style="text-align: left;">The second way is to explicitly specify the interface in the gateway field. The interface specified can belong to a VRF instance. Example:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false"># add route to 5.5.5.0/24 in the main routing table with gateway at &#39;ether2&#39; VRF interface 
add dst-address=5.5.5.0/24 gateway=10.3.0.1%ether2 routing-table=main 
# add route to 5.5.5.0/24 in the main routing table with &#39;ptp-link-1&#39; VRF interface as gateway 
add dst-address=5.5.5.0/24 gateway=ptp-link-1 routing-table=main</pre>
</div></div><p style="text-align: left;"><br/></p><p style="text-align: left;">As can be observed, there are two variations possible - to specify gateway as<span>¬†</span><em>ip_address%interface</em><span>¬†</span>or to simply specify<span>¬†an¬†</span><em>interface</em>. The first should be used for broadcast interfaces in most cases. The second should be used for point-to-point interfaces, and also for broadcast interfaces, if the route is a connected route in some VRF. For example, if you have an address<span>¬†</span><code>1.2.3.4/24</code><span>¬†</span>on interface<span>¬†</span><em>ether2</em><span>¬†</span>that is put in a VRF, there will be a connected route to<span>¬†</span><code>1.2.3.0/24</code><span>¬†</span>in that VRF's routing table. It is acceptable to add a static route<span>¬†</span><code>1.2.3.0/24</code><span>¬†</span>in a different routing table with an interface-only gateway, even though<span>¬†</span><em>ether2</em><span>¬†</span>is a broadcast interface:</p><p style="text-align: left;"><span>¬†</span></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">add dst-address=1.2.3.0/24 gateway=ether2 routing-table=main
</pre>
</div></div><h2 id="VirtualRoutingandForwardingVRF-StaticVRF-LiteConnectedrouteleaking"><span>Static VRF-Lite Connected route leaking</span></h2><p>Sometimes it is necessary to access directly connected resources from another vrf. In our example setup we have two connected networks each in its own VRF. And we want to allow client1 to be able to access client2.</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: text; gutter: false">                   +-----------------+
                   |+-vrf1-+ +-vrf2-+|
client1(*.2)-------||ip *.1| |ip *.1||-------client2(*.2)
   (10.11.0.0/24)  |+------+ +------+|   (10.12.0.0/24)
                   +-----------------+</pre>
</div></div><p><br/></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/ip address
add address=10.11.0.1/24 interface=sfp-sfpplus1
add address=10.12.0.1/24 interface=sfp-sfpplus2

# add VRF configuration
/ip vrf
add name=vrfTest1 interface=sfp-sfpplus1 place-before 0
add name=vrfTest2 interface=sfp-sfpplus2 place-before 0
</pre>
</div></div><p>We can say that connected network is reachable on specific vrf by setting gateway &quot;interface@vrf&quot;</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false"># add vrf routes
/ip route
add dst-address=10.11.0.0/24 gateway=&quot;sfp-sfpplus1@vrfTest1&quot; routing-table=vrfTest2
add dst-address=10.12.0.0/24 gateway=&quot;sfp-sfpplus2@vrfTest2&quot; routing-table=vrfTest1
</pre>
</div></div><p>Verify routes and reachability:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: text; gutter: false">[admin@CCR2004_2XS] /ip/route&gt; print detail 
Flags: D - dynamic; X - disabled, I - inactive, A - active; 
c - connect, s - static, r - rip, b - bgp, o - ospf, i - is-is, d - dhcp, v - vpn, m - modem, y - bgp-mpls-vpn; H - hw-offloaded; + - ecmp 

   DAc   dst-address=111.11.0.0/24 routing-table=vrfTest1 gateway=sfp-sfpplus1@vrfTest1 immediate-gw=sfp-sfpplus1 distance=0 scope=10 suppress-hw-offload=no 
         local-address=111.11.0.1%sfp-sfpplus1@vrfTest1 

 1  As   dst-address=111.12.0.0/24 routing-table=vrfTest1 pref-src=&quot;&quot; gateway=vrfTest2 immediate-gw=vrfTest2 distance=1 scope=30 target-scope=10 
         suppress-hw-offload=no 

 2  As   dst-address=111.11.0.0/24 routing-table=vrfTest2 pref-src=&quot;&quot; gateway=vrfTest1 immediate-gw=vrfTest1 distance=1 scope=30 target-scope=10 
         suppress-hw-offload=no 

   DAc   dst-address=111.12.0.0/24 routing-table=vrfTest2 gateway=sfp-sfpplus2@vrfTest2 immediate-gw=sfp-sfpplus2 distance=0 scope=10 suppress-hw-offload=no 
         local-address=111.12.0.1%sfp-sfpplus2@vrfTest2 


</pre>
</div></div><p><br/></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: text; gutter: false">[admin@cl2] &gt; /ping 111.11.0.2 src-address=111.12.0.2
  SEQ HOST                                     SIZE TTL TIME       STATUS                                                                                         
    0 111.11.0.2                                 56  64 67us      
    1 111.11.0.2                                 56  64 61us      
    sent=2 received=2 packet-loss=0% min-rtt=61us avg-rtt=64u

</pre>
</div></div><p><br/></p><div role="region" aria-label="Note" class="confluence-information-macro  confluence-information-macro-note" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p>Keep in mind that trying to leak overlapping networks will not work.</p></div></div><p>But now what if we want to access routers local address located in another vrf?</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: text; gutter: false">[admin@cl2] &gt; /ping 111.11.0.1 src-address=111.12.0.2
  SEQ HOST                                     SIZE TTL TIME       STATUS                                                                                         
    0 111.11.0.1                                                   timeout                                                                                        
    1 111.11.0.1                                                   timeout                                                                                        
    sent=2 received=0 packet-loss=100% 

</pre>
</div></div><p>Approach with &quot;interface@vrf&quot; gateways works only when router is forwarding packets. To access local vrf addresses we need to route to the vrf interface.</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false"># add vrf routes
/ip route
add dst-address=10.11.0.0/24 gateway=vrfTest1@vrfTest1 routing-table=vrfTest2
add dst-address=10.12.0.0/24 gateway=vrfTest2@vrfTest2 routing-table=vrfTest1
</pre>
</div></div><p><br/></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: text; gutter: false">[admin@cl2] &gt; /ping 111.11.0.1 src-address=111.12.0.2
  SEQ HOST                                     SIZE TTL TIME       STATUS                                                                                         
    0 111.11.0.1                                 56  64 67us      
    1 111.11.0.1                                 56  64 61us      
    sent=2 received=2 packet-loss=0% min-rtt=61us avg-rtt=64u

</pre>
</div></div><p><br/></p><h2 id="VirtualRoutingandForwardingVRF-DynamicVrf-Literouteleaking"><span>Dynamic Vrf-Lite route leaking</span></h2><p><span>With large enough setups static route leaking is not sufficient. Let's¬†consider we have the same setup as in static route leaking example plus ipv6 addresses, just for demonstration.</span></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/ip address
add address=10.11.0.1/24 interface=sfp-sfpplus1
add address=10.12.0.1/24 interface=sfp-sfpplus2

# add VRF configuration
/ip vrf
add name=vrfTest1 interface=sfp-sfpplus1 place-before 0
add name=vrfTest2 interface=sfp-sfpplus2 place-before 0

/ipv6 address
add address=2001:1::1 advertise=no interface=sfp-sfpplus1
add address=2001:2::1 advertise=no interface=sfp-sfpplus2

</pre>
</div></div><p><span>We can use BGP VPN to leak local routes without actually establishing BGP session.</span></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/routing bgp vpn
add export.redistribute=connected .route-targets=1:1 import.route-targets=1:2 label-allocation-policy=per-vrf name=bgp-mpls-vpn-1 \
    route-distinguisher=1.2.3.4:1 vrf=vrfTest1
add export.redistribute=connected .route-targets=1:2 import.route-targets=1:1 label-allocation-policy=per-vrf name=bgp-mpls-vpn-2 \
    route-distinguisher=1.2.3.4:1 vrf=vrfTest2</pre>
</div></div><div role="region" aria-label="Note" class="confluence-information-macro  confluence-information-macro-note" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p>Be careful with import/export route targets, if not set up properly local vrf routes from itself will be imported.</p></div></div><p><br/></p><p><span>Now we can see that connected routes between VRFs are exchanged</span></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: text; gutter: false">[admin@CCR2004_2XS] &gt; /routing route print where dst-address in 111.0.0.0/8 &amp;&amp; afi=ip4
...
 Ac   afi=ip4 contribution=active dst-address=111.11.0.0/24 routing-table=vrfTest1 gateway=sfp-sfpplus1@vrfTest1 immediate-gw=sfp-sfpplus1 distance=0 scope=10 
       belongs-to=&quot;connected&quot; local-address=111.11.0.1%sfp-sfpplus1@vrfTest1 
       debug.fwp-ptr=0x202421E0 
 Ay   afi=ip4 contribution=best-candidate dst-address=111.12.0.0/24 routing-table=vrfTest1 label=17 gateway=vrfTest2@vrfTest2 immediate-gw=sfp-sfpplus2 
       distance=200 scope=40 target-scope=10 belongs-to=&quot;bgp-mpls-vpn-1-bgp-mpls-vpn-2-connected-export-import&quot; 
       bgp.ext-communities=rt:1:2 .atomic-aggregate=no .origin=incomplete 
       debug.fwp-ptr=0x202425A0 
¬†Ay   afi=ip4 contribution=best-candidate dst-address=111.11.0.0/24 routing-table=vrfTest2 label=16 gateway=vrfTest1@vrfTest1 immediate-gw=sfp-sfpplus1 
       distance=200 scope=40 target-scope=10 belongs-to=&quot;bgp-mpls-vpn-2-bgp-mpls-vpn-1-connected-export-import&quot; 
       bgp.ext-communities=rt:1:1 .atomic-aggregate=no .origin=incomplete 
       debug.fwp-ptr=0x202424E0 
 Ac   afi=ip4 contribution=active dst-address=111.12.0.0/24 routing-table=vrfTest2 gateway=sfp-sfpplus2@vrfTest2 immediate-gw=sfp-sfpplus2 distance=0 scope=10 
       belongs-to=&quot;connected&quot; local-address=111.12.0.1%sfp-sfpplus2@vrfTest2 
       debug.fwp-ptr=0x20242240 

</pre>
</div></div><p><span>And IPv6 too:</span></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: text; gutter: false">[admin@CCR2004_2XS] /routing/route&gt; print detail where dst-address in 2001::/8 &amp;&amp; afi=ip6
...
 Ac   afi=ip6 contribution=active dst-address=2001:1::/64 routing-table=vrfTest1 gateway=sfp-sfpplus1@vrfTest1 immediate-gw=sfp-sfpplus1 distance=0 scope=10 
       belongs-to=&quot;connected&quot; local-address=2001:1::1%sfp-sfpplus1@vrfTest1 
       debug.fwp-ptr=0x20242300 
 Ay   afi=ip6 contribution=active dst-address=2001:2::/64 routing-table=vrfTest1 label=17 gateway=vrfTest2@vrfTest2 immediate-gw=sfp-sfpplus2 distance=200 
       scope=40 target-scope=10 belongs-to=&quot;bgp-mpls-vpn-1-bgp-mpls-vpn-2-connected-export-import&quot; 
       bgp.ext-communities=rt:1:2 .atomic-aggregate=no .origin=incomplete 
       debug.fwp-ptr=0x202425A0 
 Ay   afi=ip6 contribution=active dst-address=2001:1::/64 routing-table=vrfTest2 label=16 gateway=vrfTest1@vrfTest1 immediate-gw=sfp-sfpplus1 distance=200 
       scope=40 target-scope=10 belongs-to=&quot;bgp-mpls-vpn-2-bgp-mpls-vpn-1-connected-export-import&quot; 
       bgp.ext-communities=rt:1:1 .atomic-aggregate=no .origin=incomplete 
       debug.fwp-ptr=0x202424E0 
 Ac   afi=ip6 contribution=active dst-address=2001:2::/64 routing-table=vrfTest2 gateway=sfp-sfpplus2@vrfTest2 immediate-gw=sfp-sfpplus2 distance=0 scope=10 
       belongs-to=&quot;connected&quot; local-address=2001:2::1%sfp-sfpplus2@vrfTest2 
       debug.fwp-ptr=0x20242360 

</pre>
</div></div><h2 id="VirtualRoutingandForwardingVRF-DynamicVrf-Literouteleaking(oldworkaround)"><span>Dynamic Vrf-Lite route leaking (old workaround)</span></h2><p>Before ROS v7.14 there were no mechanism to leak routes from one VRF instance to another within the same router.</p><p>As a workaround, it was possible to create a tunnel between two locally configure loopback addresses and assign each tunnel endpoint to its own VRF. Then it is possible to run either dynamic routing protocols or set up static routes to leak between both VRFs.</p><p>The downside of this approach is that tunnel must be created between each VRF where routes should be leaked (create a full mesh), which significantly complicates configuration even if there are just several VRFs, not to mention more complicated setups.</p><p>For example, to leak routes between 5 VRFs it would require¬†<span>n * ( n ‚Äì 1) / 2 connections, which will lead to the setup with 20 tunnel endpoints and 20 OSPF instances on one router.</span></p><p>Example config with two VRFs of this method:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge
add name=dummy_custC
add name=dummy_custB
add name=lo1
add name=lo2

/ip address
add address=111.255.255.1 interface=lo1 network=111.255.255.1
add address=111.255.255.2 interface=lo2 network=111.255.255.2
add address=172.16.1.0/24 interface=dummy_custC network=172.16.1.0
add address=172.16.2.0/24 interface=dummy_custB network=172.16.2.0

/interface ipip
add local-address=111.255.255.1 name=ipip-tunnel1 remote-address=111.255.255.2
add local-address=111.255.255.2 name=ipip-tunnel2 remote-address=111.255.255.1

/ip address
add address=192.168.1.1/24 interface=ipip-tunnel1 network=192.168.1.0
add address=192.168.1.2/24 interface=ipip-tunnel2 network=192.168.1.0

/ip vrf
add interfaces=ipip-tunnel1,dummy_custC name=custC
add interfaces=ipip-tunnel2,dummy_custB name=custB

/routing ospf instance
add disabled=no name=i2_custB redistribute=connected,static,copy router-id=192.168.1.1 routing-table=custB vrf=custB
add disabled=no name=i2_custC redistribute=connected router-id=192.168.1.2 routing-table=custC vrf=custC
/routing ospf area
add disabled=no instance=i2_custB name=custB_bb
add disabled=no instance=i2_custC name=custC_bb
/routing ospf interface-template
add area=custB_bb disabled=no networks=192.168.1.0/24
add area=custC_bb disabled=no networks=192.168.1.0/24

</pre>
</div></div><p>Result:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">[admin@rack1_b36_CCR1009] /routing/ospf/neighbor&gt; print 
Flags: V - virtual; D - dynamic 
 0  D instance=i2_custB area=custB_bb address=192.168.1.1 priority=128 router-id=192.168.1.2 dr=192.168.1.1 bdr=192.168.1.2 
      state=&quot;Full&quot; state-changes=6 adjacency=41m28s timeout=33s 

 1  D instance=i2_custC area=custC_bb address=192.168.1.2 priority=128 router-id=192.168.1.1 dr=192.168.1.1 bdr=192.168.1.2 
      state=&quot;Full&quot; state-changes=6 adjacency=41m28s timeout=33s 


[admin@rack1_b36_CCR1009] /ip/route&gt; print where routing-table=custB
Flags: D - DYNAMIC; A - ACTIVE; c, s, o, y - COPY
Columns: DST-ADDRESS, GATEWAY, DISTANCE
     DST-ADDRESS       GATEWAY                         DISTANCE
  DAo 172.16.1.0/24     192.168.1.1%ipip-tunnel2@custB       110
 ¬†DAc 172.16.2.0/24     dummy_custB@custB                      0
  DAc 192.168.1.0/24    ipip-tunnel2@custB                     0


[admin@rack1_b36_CCR1009] &gt; /ip route/print where routing-table=custC
Flags: D - DYNAMIC; A - ACTIVE; c, o, y - COPY
Columns: DST-ADDRESS, GATEWAY, DISTANCE
    DST-ADDRESS       GATEWAY                         DISTANCE
  DAc 172.16.1.0/24     dummy_custC@custC                      0
  DAo 172.16.2.0/24     192.168.1.2%ipip-tunnel1@custC       110 
  DAc 192.168.1.0/24    ipip-tunnel1@custC                     0

</pre>
</div></div><p><br/></p><h2 id="VirtualRoutingandForwardingVRF-ThesimplestMPLSVPNsetup"><span class="mw-headline">The simplest MPLS VPN setup</span></h2><p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" draggable="false" src="attachments/328206/40992769.png" data-image-src="attachments/328206/40992769.png" data-unresolved-comment-count="0" data-linked-resource-id="40992769" data-linked-resource-version="2" data-linked-resource-type="attachment" data-linked-resource-default-alias="L3vpn-simple.png" data-base-url="https://help.mikrotik.com/docs" data-linked-resource-content-type="image/png" data-linked-resource-container-id="328206" data-linked-resource-container-version="79" tabindex="0" alt=""></span></p><p>In this example, a rudimentary MPLS backbone (consisting of two Provider Edge (PE) routers PE1 and PE2) is created and configured to forward traffic between Customer Edge (CE) routers CE1 and CE2 routers that belong to<span>¬†</span><em>cust-one</em><span>¬†</span>VPN.</p><h3 id="VirtualRoutingandForwardingVRF-CE1Router"><span class="mw-headline">CE1 Router</span></h3><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/ip address add address=10.1.1.1/24 interface=ether1 
# use static routing 
/ip route add dst-address=10.3.3.0/24 gateway=10.1.1.2</pre>
</div></div><p style="margin-left: 20.0px;"><br/></p><h3 id="VirtualRoutingandForwardingVRF-CE2Router"><span class="mw-headline">CE2 Router</span></h3><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/ip address add address=10.3.3.4/24 interface=ether1 
/ip route add dst-address=10.1.1.0/24 gateway=10.3.3.3</pre>
</div></div><p style="margin-left: 20.0px;"><br/></p><h3 id="VirtualRoutingandForwardingVRF-PE1Router"><span class="mw-headline">PE1 Router</span></h3><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge add name=lobridge 
/ip address add address=10.1.1.2/24 interface=ether1 
/ip address add address=10.2.2.2/24 interface=ether2 
/ip address add address=10.5.5.2/32 interface=lobridge 
/ip vrf add name=cust-one interfaces=ether1 
/mpls ldp add enabled=yes transport-address=10.5.5.2 lsr-id=10.5.5.2
/mpls ldp interface add interface=ether2 
/routing bgp template set default as=65000 

/routing bgp vpn 
add vrf=cust-one \
  route-distinguisher=1.1.1.1:111 \
  import.route-targets=1.1.1.1:111 \
  import.router-id=cust-one \
  export.redistribute=connected \
 ¬†export.route-targets=1.1.1.1:111 \
  label-allocation-policy=per-vrf
/routing bgp connection 
add template=default remote.address=10.5.5.3 address-families=vpnv4 local.address=10.5.5.2

# add route to the remote BGP peer&#39;s loopback address 
/ip route add dst-address=10.5.5.3/32 gateway=10.2.2.3</pre>
</div></div><p><br/></p><p style="margin-left: 20.0px;"><br/></p><h3 id="VirtualRoutingandForwardingVRF-PE2Router(Cisco)"><span class="mw-headline">PE2 Router (Cisco)</span></h3><p style="margin-left: 20.0px;"><span style="font-size: 16.0px;font-weight: bold;letter-spacing: -0.006em;">¬†</span></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">ip vrf cust-one
rd 1.1.1.1:111
route-target export 1.1.1.1:111
route-target import 1.1.1.1:111
exit

interface Loopback0
ip address 10.5.5.3 255.255.255.255

mpls ldp router-id Loopback0 force
mpls label protocol ldp

interface FastEthernet0/0
ip address 10.2.2.3 255.255.255.0
mpls ip

interface FastEthernet1/0
ip vrf forwarding cust-one
ip address 10.3.3.3 255.255.255.0

router bgp 65000
neighbor 10.5.5.2 remote-as 65000
neighbor 10.5.5.2 update-source Loopback0
address-family vpnv4
neighbor 10.5.5.2 activate
neighbor 10.5.5.2 send-community both
exit-address-family
address-family ipv4 vrf cust-one
redistribute connected
exit-address-family

ip route 10.5.5.2 255.255.255.255 10.2.2.2

</pre>
</div></div><p style="margin-left: 20.0px;"><span style="font-size: 16.0px;font-weight: bold;letter-spacing: -0.006em;">Results</span></p><p>Check that VPNv4 route redistribution is working:</p><p style="margin-left: 20.0px;"><span style="letter-spacing: 0.0px;">¬†</span></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">[admin@PE1] /routing/route&gt; print detail where afi=&quot;vpn4&quot; 
Flags: X - disabled, F - filtered, U - unreachable, A - active; 
c - connect, s - static, r - rip, b - bgp, o - ospf, d - dhcp, v - vpn, m - modem, a - ldp-address, l - l
dp-mapping, g - slaac, y - bgp-mpls-vpn; 
H - hw-offloaded; + - ecmp, B - blackhole 
 Ab   afi=vpn4 contribution=active dst-address=111.16.0.0/24&amp;1.1.1.1:111 routing-table=main label=16 
       gateway=111.111.111.4 immediate-gw=111.13.0.2%ether9 distance=200 scope=40 target-scope=30 
       belongs-to=&quot;bgp-VPN4-111.111.111.4&quot; 
       bgp.peer-cache-id=*2C00011 .as-path=&quot;65511&quot; .ext-communities=rt:1.1.1.1:111 .local-pref=100 
       .atomic-aggregate=yes .origin=igp 
       debug.fwp-ptr=0x202427E0 

[admin@PE1] /routing/bgp/advertisements&gt; print 
 0 peer=to-pe2-1 dst=10.1.1.0/24 local-pref=100 origin=2 ext-communities=rt:1.1.1.1:111 atomic-aggregate=yes 
 ¬†</pre>
</div></div><p style="margin-left: 20.0px;"><span style="letter-spacing: 0.0px;">Check that the 10.3.3.0 is installed in IP routes, in the cust-one route table:</span></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">[admin@PE1] &gt; /ip route print where routing-table=&quot;cust-one&quot; 
Flags: D - DYNAMIC; A - ACTIVE; c, b, y - BGP-MPLS-VPN
Columns: DST-ADDRESS, GATEWAY, DISTANCE
# DST-ADDRESS     GATEWAY         DISTANCE 
0 ADC 10.1.1.0/24 ether1@cust-one        0 
1 ADb 10.3.3.0/24 10.5.5.3              20 </pre>
</div></div><p style="margin-left: 20.0px;"><br/></p><p>Let's take a closer look at IP routes in cust-one VRF. The 10.1.1.0/24 IP prefix is a connected route that belongs to an interface that was configured to belong to cust-one VRF. The 10.3.3.0/24 IP prefix was advertised via BGP as a VPNv4 route from PE2 and is imported in this VRF routing table, because our configured<span>¬†</span><strong>import-route-targets</strong><span>¬†</span>matched the BGP extended communities attribute it was advertised with.</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">[admin@PE1] /routing/route&gt; print detail where routing-table=&quot;cust-one&quot;
Flags: X - disabled, F - filtered, U - unreachable, A - active; 
c - connect, s - static, r - rip, b - bgp, o - ospf, d - dhcp, v - vpn, m - modem, a - ldp-address, l - l
dp-mapping, g - slaac, y - bgp-mpls-vpn; 
H - hw-offloaded; + - ecmp, B - blackhole 
 Ac   afi=ip4 contribution=active dst-address=10.1.1.0/24 routing-table=cust-one 
       gateway=ether1@cust-one immediate-gw=ether1 distance=0 scope=10 belongs-to=&quot;connected&quot; 
       local-address=10.1.1.2%ether1@cust-one
       debug.fwp-ptr=0x202420C0 

 Ay   afi=ip4 contribution=active dst-address=10.3.3.0/24 routing-table=cust-one label=16 
       gateway=10.5.5.3 immediate-gw=10.2.2.3%ether2 distance=20 scope=40 target-scope=30 
       belongs-to=&quot;bgp-mpls-vpn-1-bgp-VPN4-10.5.5.3-import&quot; 
       bgp.peer-cache-id=*2C00011 .ext-communities=rt:1.1.1.1:111 .local-pref=100 
       .atomic-aggregate=yes .origin=igp 
       debug.fwp-ptr=0x20242840 


[admin@PE1] /routing/route&gt; print detail where afi=&quot;vpn4&quot;                 
Flags: X - disabled, F - filtered, U - unreachable, A - active; 
c - connect, s - static, r - rip, b - bgp, o - ospf, d - dhcp, v - vpn, m - modem, a - ldp-address, l - l
dp-mapping, g - slaac, y - bgp-mpls-vpn; 
H - hw-offloaded; + - ecmp, B - blackhole 
 Ay   afi=vpn4 contribution=active dst-address=10.1.1.0/24&amp;1.1.1.1:111 routing-table=main label=19 
       gateway=ether1@cust-one immediate-gw=ether1 distance=200 scope=40 target-scope=10 
       belongs-to=&quot;bgp-mpls-vpn-1-connected-export&quot; 
       bgp.ext-communities=rt:1.1.1.1:1111 .atomic-aggregate=no .origin=incomplete 
       debug.fwp-ptr=0x202426C0 

 Ab   afi=vpn4 contribution=active dst-address=10.3.3.0/24&amp;1.1.1.1:111 routing-table=main label=16 
       gateway=10.5.5.3 immediate-gw=10.2.2.3%ether2 distance=200 scope=40 target-scope=30 
       belongs-to=&quot;bgp-VPN4-10.5.5.3&quot; 
       bgp.peer-cache-id=*2C00011 .ext-communities=rt:1.1.1.1:111 .local-pref=100 
       .atomic-aggregate=yes .origin=igp 
       debug.fwp-ptr=0x202427E0 


</pre>
</div></div><p style="margin-left: 20.0px;"><br/></p><p>The same for Cisco:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">PE2#show ip bgp vpnv4 all 
BGP table version is 5, local router ID is 10.5.5.3 
Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, 
r RIB-failure, S Stale 
Origin codes: i - IGP, e - EGP,¬†? - incomplete 
Network Next Hop Metric LocPrf Weight Path 
Route Distinguisher: 1.1.1.1:111 (default for vrf cust-one) 
*&gt;i10.1.1.0/24 10.5.5.2 100 0¬†? 
*&gt; 10.3.3.0/24 0.0.0.0 0 32768¬†? 

PE2#show ip route vrf cust-one 
Routing Table: cust-one 
Codes: C - connected, S - static, R - RIP, M - mobile, B - BGP 
D - EIGRP, EX - EIGRP external, O - OSPF, IA - OSPF inter area 
N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2 
E1 - OSPF external type 1, E2 - OSPF external type 2 
i - IS-IS, su - IS-IS summary, L1 - IS-IS level-1, L2 - IS-IS level-2 
ia - IS-IS inter area, * - candidate default, U - per-user static route 
o - ODR, P - periodic downloaded static route 

Gateway of last resort is not set 
10.0.0.0/24 is subnetted, 1 subnets
B 10.1.1.0 [200/0] via 10.5.5.2, 00:05:33 
10.0.0.0/24 is subnetted, 1 subnets 
C 10.3.3.0 is directly connected, FastEthernet1/0</pre>
</div></div><p style="margin-left: 20.0px;"><br/></p><p>You should be able to ping from CE1 to CE2 and vice versa.</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">[admin@CE1] &gt; /ping 10.3.3.4 
10.3.3.4 64 byte ping: ttl=62 time=18 ms 
10.3.3.4 64 byte ping: ttl=62 time=13 ms 
10.3.3.4 64 byte ping: ttl=62 time=13 ms 
10.3.3.4 64 byte ping: ttl=62 time=14 ms 
4 packets transmitted, 4 packets received, 0% packet loss 
round-trip min/avg/max = 13/14.5/18 ms</pre>
</div></div><p style="margin-left: 20.0px;"><br/></p><h2 id="VirtualRoutingandForwardingVRF-Amorecomplicatedsetup(changesonly)"><span class="mw-headline">A more complicated setup (changes only)</span></h2><p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" draggable="false" src="attachments/328206/40992772.png" data-image-src="attachments/328206/40992772.png" data-unresolved-comment-count="0" data-linked-resource-id="40992772" data-linked-resource-version="2" data-linked-resource-type="attachment" data-linked-resource-default-alias="800px-L3vpn-two-customers.png" data-base-url="https://help.mikrotik.com/docs" data-linked-resource-content-type="image/png" data-linked-resource-container-id="328206" data-linked-resource-container-version="79" tabindex="0" alt=""></span></p><p>As opposed to the simplest setup, in this example, we have two customers: cust-one and cust-two.</p><p>We configure two VPNs for them, cust-one and cust-two respectively, and exchange all routes between them. (This is also called &quot;route leaking&quot;).</p><p>Note that this could be not the most typical setup, because routes are usually not exchanged between different customers. In contrast, by default, it should not be possible to gain access from one VRF site to a different VRF site in another VPN. (This is the &quot;Private&quot; aspect of VPNs.) Separate routing is a way to provide privacy, and it is also required to solve the problem of overlapping IP network prefixes. Route exchange is in direct conflict with these two requirements but may sometimes be needed (e.g. temp. solution when two customers are migrating to a single network infrastructure).</p><h3 id="VirtualRoutingandForwardingVRF-CE1Router,cust-one"><span class="mw-headline">CE1 Router,<span>¬†</span><em>cust-one</em></span></h3><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/ip route add dst-address=10.4.4.0/24 gateway=10.1.1.2</pre>
</div></div><p style="margin-left: 20.0px;"><br/></p><h3 id="VirtualRoutingandForwardingVRF-CE2Router,cust-one"><span class="mw-headline">CE2 Router,<span>¬†</span><em>cust-one</em></span></h3><p style="margin-left: 20.0px;"><span style="font-size: 16.0px;font-weight: bold;letter-spacing: -0.006em;">¬†</span></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/ip route add dst-address=10.4.4.0/24 gateway=10.3.3.3

</pre>
</div></div><p><span style="font-size: 16.0px;font-weight: bold;letter-spacing: -0.006em;">CE1 Router,</span><em style="font-size: 16.0px;font-weight: bold;letter-spacing: -0.006em;">cust-two</em></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/ip address add address=10.4.4.5 interface=ether1 
/ip route add dst-address=10.1.1.0/24 gateway=10.3.3.3 
/ip route add dst-address=10.3.3.0/24 gateway=10.3.3.3</pre>
</div></div><p style="margin-left: 20.0px;"><br/></p><h3 id="VirtualRoutingandForwardingVRF-PE1Router.1"><span class="mw-headline">PE1 Router</span></h3><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false"># replace the old BGP VPN with this:
/routing bgp vpn 
add vrf=cust-one \
  export.redistribute=connected \
  route-distinguisher=1.1.1.1:111 \
  import.route-targets=1.1.1.1:111,2.2.2.2:222  \
  export.route-targets=1.1.1.1:111

</pre>
</div></div><p style="margin-left: 20.0px;"><span style="font-size: 16.0px;font-weight: bold;letter-spacing: -0.006em;">PE2 Router (Cisco)</span></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">ip vrf cust-one 
rd 1.1.1.1:111 
route-target export 1.1.1.1:111 
route-target import 1.1.1.1:111 
route-target import 2.2.2.2:222 
exit 

ip vrf cust-two 
rd 2.2.2.2:222 
route-target export 2.2.2.2:222 
route-target import 1.1.1.1:111 
route-target import 2.2.2.2:222 
exit 

interface FastEthernet2/0 
ip vrf forwarding cust-two 
ip address 10.4.4.3 255.255.255.0 

router bgp 65000 
address-family ipv4 vrf cust-two 
redistribute connected 
exit-address-family</pre>
</div></div><p style="margin-left: 20.0px;"><br/></p><h2 id="VirtualRoutingandForwardingVRF-Variation:replacetheCiscowithanotherMT"><span class="mw-headline">Variation: replace the Cisco with another MT</span></h2><h3 id="VirtualRoutingandForwardingVRF-PE2Mikrotikconfig"><span class="mw-headline">PE2 Mikrotik config</span></h3><p style="margin-left: 20.0px;"><span style="font-size: 16.0px;font-weight: bold;letter-spacing: -0.006em;">¬†</span></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge add name=lobridge
/ip address
add address=10.2.2.3/24 interface=ether1
add address=10.3.3.3/24 interface=ether2
add address=10.4.4.3/24 interface=ether3
add address=10.5.5.3/32 interface=lobridge
/ip vrf
add name=cust-one interfaces=ether2
add name=cust-two interfaces=ether3
/mpls ldp add enabled=yes transport-address=10.5.5.3
/mpls ldp interface add interface=ether1

/routing bgp template set default as=65000 
/routing bgp vpn 
add vrf=cust-one \
  export.redistribute=connected \
  route-distinguisher=1.1.1.1:111 \
  import.route-targets=1.1.1.1:111,2.2.2.2:222 \
  export.route-targets=1.1.1.1:111 \
add vrf=cust-two \
  export.redistribute=connected \
  route-distinguisher=2.2.2.2:222 \
  import.route-targets=1.1.1.1:111,2.2.2.2:222 \
  export.route-targets=2.2.2.2:222 \

/routing bgp connection 
add template=default remote.address=10.5.5.2 address-families=vpnv4 local.address=10.5.5.3

# add route to the remote BGP peer&#39;s loopback address
/ip route add dst-address=10.5.5.2/32 gateway=10.2.2.2
</pre>
</div></div><p style="margin-left: 20.0px;"><span style="font-size: 16.0px;font-weight: bold;letter-spacing: -0.006em;">Results</span></p><p>The output of<span>¬†</span><strong>/ip route print</strong><span>¬†</span>now is interesting enough to deserve detailed observation.</p><p style="margin-left: 20.0px;"><span style="letter-spacing: 0.0px;">¬†</span></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">[admin@PE2] /ip route&gt; print
Flags: X - disabled, A - active, D - dynamic,
C - connect, S - static, r - rip, b - bgp, o - ospf, m - mme,
B - blackhole, U - unreachable, P - prohibit
# DST-ADDRESS PREF-SRC GATEWAY DISTANCE
0 ADb 10.1.1.0/24 10.5.5.2 recurs... 20
1 ADC 10.3.3.0/24 10.3.3.3 ether2 0
2 ADb 10.4.4.0/24 20
3 ADb 10.1.1.0/24 10.5.5.2 recurs... 20
4 ADb 10.3.3.0/24 20
5 ADC 10.4.4.0/24 10.4.4.3 ether3 0
6 ADC 10.2.2.0/24 10.2.2.3 ether1 0
7 A S 10.5.5.2/32 10.2.2.2 reacha... 1
8 ADC 10.5.5.3/32 10.5.5.3 lobridge 0

</pre>
</div></div><p style="margin-left: 20.0px;"><span style="letter-spacing: 0.0px;">The route 10.1.1.0/24 was received from a remote BGP peer and is installed in both VRF routing tables.</span></p><p>The routes 10.3.3.0/24 and 10.4.4.0/24 are also installed in both VRF routing tables. Each is a connected route in one table and a BGP route in another table. This has nothing to do with their being advertised via BGP. They are simply being &quot;advertised&quot; to the local VPNv4 route table and locally reimported after that. Import and export<span>¬†</span><strong>route-targets</strong><span>¬†</span>determine in which tables they will end up.</p><p>This can be deduced from its attributes - they don't have the usual BGP properties. (Route 10.4.4.0/24.)</p><p style="margin-left: 20.0px;"><span style="font-size: 20.0px;letter-spacing: -0.008em;">¬†</span></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">[admin@PE2] /routing/route&gt; print detail where routing-table=cust-one
...
</pre>
</div></div><p><br/></p><h2 id="VirtualRoutingandForwardingVRF-UniqueRDper-sitevsuniqueRDper-customer"><span style="font-size: 24.0px;letter-spacing: -0.01em;">Unique RD per-site vs unique RD per-customer</span></h2><p>Let's consider BGP VPN setup where two CUST_A sites announce the same network (111.12.0.0/24).</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: text; gutter: false">                         +----------+               +----------+ 
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†      |+-vrf-+   |  ¬† ¬† ¬† ¬† ¬† ¬† ¬†|   +-vrf-+|
CUST_A(10.12.0.0/24)-----|+-----+  ¬†|---(BGP VPN)---|   +-----+|-------CUST_A(10.12.0.0/24)
                         +----------+               +----------+ </pre>
</div></div><p>There are two ways to handle setups like this:</p><ul><li data-uuid="8a7efeb9-31bf-424c-b170-16d026cdc882">per-customer (CUST_A VPN on Router 1 have the same route distinguisher (lets assume RD=1:1) as CUST_A VPN on Router 2)</li><li data-uuid="75ea30c2-5d00-4440-9218-5b631873128e">per-site (each CUST_A site ¬†have unique Route Distinguisher)</li></ul><p>In first case CUST_A sites on Router1 ¬†have exported the VPNv4 route and advertise it to remote PE. ¬†</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: routeros; gutter: false"> Ay   afi=vpnv4 contribution=active dst-address=111.12.0.0/24&amp;1:1 routing-table=main label=16 gateway=vrf-dummy@vrfTest 
       immediate-gw=vrf-dummy distance=200 scope=40 target-scope=10 belongs-to=&quot;bgp-mpls-vpn-1-connected-export&quot; 
       bgp.ext-communities=rt:1:1 .origin=incomplete 
       debug.fwp-ptr=0x20302600 </pre>
</div></div><p><br/></p><p>CUST_A site on Router2 also exports VPNv4 route and has received VPNv4 route from another site as well:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: routeros; gutter: false"> Ab + afi=vpnv4 contribution=active dst-address=111.12.0.0/24&amp;1:1 routing-table=main label=16 gateway=111.11.0.2 
       immediate-gw=111.11.0.2%sfp-sfpplus1 distance=200 scope=40 target-scope=30 belongs-to=&quot;bgp-VPNv4-111.11.0.2&quot; 
       bgp.session=to-tested-1 .ext-communities=rt:1:1 .local-pref=100 .origin=igp 
       debug.fwp-ptr=0x203421E0 

 Ay + afi=vpnv4 contribution=active dst-address=111.12.0.0/24&amp;1:1 routing-table=main label=32 gateway=vrf-dummy@vrfTest 
       immediate-gw=vrf-dummy distance=200 scope=40 target-scope=10 belongs-to=&quot;bgp-mpls-vpn-1-connected-export&quot; 
       bgp.ext-communities=rt:1:1 .origin=incomplete 
       debug.fwp-ptr=0x20342540 </pre>
</div></div><p>Currently RouterOS advertises only one best route. In case of ECMP by default it picks the first one from the list which happens to be BGP VPNv4 route received from remote site, and of course remote site will not get the second route. This leads to situation that one site has two redundant routes in the VRF but other site does not. On that site where VRF does not have installed VPN route and local route becomes inactive, BGP needs to send withdraw, recalculate main table, receive update from remote site and import new best route into CUST_A VRF, leading to slower convergence.</p><p>¬†This behavior of course could be changed with route selection filters, but it is outside the scope of this example.</p><p>Similar situation happens if exported to VPNV4 route is also BGP route received from customers CE-PE session, except that now instead of ECMP, BGP best-path selection process is applied to VPNv4 routes and only one best is selected.</p><p><br/></p><p>Now if we assign unique route-distinguisher per site, lets say (1.1.1.1:1 on first site and 1.1.1.2:1 on second site), there is no longer selection on VPNv4 routes because these are now considered unique destinations and both destinations are imported into VRF.</p><p>CUST_A on Router1</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: routeros; gutter: false">[admin@CCR2004_2XS_111] /routing/route&gt; print detail 
...
 Ay   afi=vpnv4 contribution=active dst-address=111.12.0.0/24&amp;1.1.1.1:1 routing-table=main label=17 gateway=vrf-dummy@vrfTest 
       immediate-gw=vrf-dummy distance=200 scope=40 target-scope=10 belongs-to=&quot;bgp-mpls-vpn-1-connected-export&quot; 
       bgp.ext-communities=rt:1:1 .origin=incomplete 
       debug.fwp-ptr=0x20302240 

 Ab   afi=vpnv4 contribution=active dst-address=111.12.0.0/24&amp;1.1.1.2:1 routing-table=main label=33 gateway=111.11.0.1 
       immediate-gw=111.11.0.1%sfp-sfpplus1 distance=200 scope=40 target-scope=30 belongs-to=&quot;bgp-VPNv4-111.11.0.1&quot; 
       bgp.session=to-tester-1 .ext-communities=rt:1:1 .local-pref=100 .origin=igp 
       debug.fwp-ptr=0x20302480 


[admin@CCR2004_2XS_111] /ip/route&gt; print 
...
  DAc  111.12.0.0/24       vrf-dummy@vrfTest  vrfTest               0
  D y  111.12.0.0/24       111.11.0.1         vrfTest             200</pre>
</div></div><p><br/></p><p><br/></p><p>CUST_A on Router2</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: routeros; gutter: false">[admin@CCR2004_2XS_111] /routing/route&gt; print detail 
...
 Ab   afi=vpnv4 contribution=active dst-address=111.12.0.0/24&amp;1.1.1.1:1 routing-table=main label=17 gateway=111.11.0.2 
       immediate-gw=111.11.0.2%sfp-sfpplus1 distance=200 scope=40 target-scope=30 belongs-to=&quot;bgp-VPNv4-111.11.0.2&quot; 
       bgp.session=to-tested-1 .ext-communities=rt:1:1 .local-pref=100 .origin=igp 
       debug.fwp-ptr=0x203421E0 

 Ay   afi=vpnv4 contribution=active dst-address=111.12.0.0/24&amp;1.1.1.2:1 routing-table=main label=33 gateway=vrf-dummy@vrfTest 
       immediate-gw=vrf-dummy distance=200 scope=40 target-scope=10 belongs-to=&quot;bgp-mpls-vpn-1-connected-export&quot; 
       bgp.ext-communities=rt:1:1 .origin=incomplete 
       debug.fwp-ptr=0x20342240 


[admin@CCR2004_2XS_111] /ip/route&gt; print 
...
 DAc 111.12.0.0/24       vrf-dummy@vrfTest  vrfTest               0
 D y 111.12.0.0/24       111.11.0.2         vrfTest             200</pre>
</div></div><p>In this case compared to previous setup, when local route from any of sites becomes inactive, switch to alternative route happens momentarily.</p><p><br/></p><h1 id="VirtualRoutingandForwardingVRF-References"><span style="font-size: 24.0px;letter-spacing: -0.01em;">References</span></h1><p><a class="external-link" href="http://www.ietf.org/rfc/rfc4364.txt" rel="nofollow" style="text-decoration: none;">RFC 4364: BGP/MPLS IP Virtual Private Networks (VPNs)</a></p><p>MPLS Fundamentals, chapter 7,<span>¬†</span><em>Luc De Ghein</em>, Cisco Press 2006</p><p><br/></p>
                    </div>

                                                            <div class="pageSection group">
                        <div class="pageSectionHeader">
                            <h2 id="attachments" class="pageSectionTitle">Attachments:</h2>
                        </div>

                        <div class="greybox" align="left">
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/328206/67272713.png">L3vpn-simple.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/328206/67272714.png">800px-L3vpn-two-customers.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/328206/40992769.png">L3vpn-simple.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/328206/40992772.png">800px-L3vpn-two-customers.png</a> (image/png)
                                <br/>
                                                    </div>
                    </div>
                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on May 20, 2025 14:53</p>
                    <div id="footer-logo"><a href="https://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
