<!DOCTYPE html>
<html>
    <head>
        <title>RouterOS : L3 Hardware Offloading</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">RouterOS</a></span>
                            </li>
                                                    <li>
                                <span><a href="RouterOS_328059.html">RouterOS</a></span>
                            </li>
                                                    <li>
                                <span><a href="Bridging-and-Switching_328068.html">Bridging and Switching</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            RouterOS : L3 Hardware Offloading
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
    
        
    
        
        
            Created by <span class='author'> Māris B.</span>, last updated by <span class='editor'> Edgars P.</span> on Apr 08, 2025
    
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <p><style type='text/css'>/*<![CDATA[*/
div.rbtoc1747742024127 {padding: 0px;}
div.rbtoc1747742024127 ul {margin-left: 0px;}
div.rbtoc1747742024127 li {margin-left: 0px;padding-left: 0px;}

/*]]>*/</style><div class='toc-macro rbtoc1747742024127'>
<ul class='toc-indentation'>
<li><a href='#L3HardwareOffloading-Introduction'>Introduction</a></li>
<li><a href='#L3HardwareOffloading-SwitchConfiguration'>Switch Configuration</a>
<ul class='toc-indentation'>
<li><a href='#L3HardwareOffloading-SwitchPortConfiguration'>Switch Port Configuration</a></li>
<li><a href='#L3HardwareOffloading-L3HWSettings'>L3HW Settings</a>
<ul class='toc-indentation'>
<li><a href='#L3HardwareOffloading-BasicSettings'>Basic Settings</a></li>
<li><a href='#L3HardwareOffloading-AdvancedSettings'>Advanced Settings</a></li>
<li><a href='#L3HardwareOffloading-Monitor'>Monitor</a></li>
<li><a href='#L3HardwareOffloading-AdvancedMonitor'>Advanced Monitor</a></li>
</ul>
</li>
<li><a href='#L3HardwareOffloading-InterfaceLists'>Interface Lists</a></li>
<li><a href='#L3HardwareOffloading-MTU'>MTU</a></li>
<li><a href='#L3HardwareOffloading-Layer2Dependency'>Layer 2 Dependency</a></li>
<li><a href='#L3HardwareOffloading-MACtelnet'>MAC telnet</a></li>
<li><a href='#L3HardwareOffloading-Inter-VLANRouting'>Inter-VLAN Routing</a></li>
<li><a href='#L3HardwareOffloading-L3HWMACAddressRangeLimitation(DX2000/DX3000seriesonly)'>L3HW MAC Address Range Limitation (DX2000/DX3000 series only)</a></li>
</ul>
</li>
<li><a href='#L3HardwareOffloading-RouteConfiguration'>Route Configuration</a>
<ul class='toc-indentation'>
<li><a href='#L3HardwareOffloading-SuppressingHWOffload'>Suppressing HW Offload</a></li>
<li><a href='#L3HardwareOffloading-RoutingFilters'>Routing Filters</a></li>
<li><a href='#L3HardwareOffloading-OffloadingFasttrackConnections'>Offloading Fasttrack Connections</a></li>
<li><a href='#L3HardwareOffloading-StatelessHardwareFirewall'>Stateless Hardware Firewall</a></li>
<li><a href='#L3HardwareOffloading-SwitchRules(ACL)vs.FasttrackHWOffloading'>Switch Rules (ACL) vs. Fasttrack HW Offloading</a></li>
</ul>
</li>
<li><a href='#L3HardwareOffloading-ConfigurationExamples'>Configuration Examples</a>
<ul class='toc-indentation'>
<li><a href='#L3HardwareOffloading-Inter-VLANRoutingwithUpstreamPortBehindFirewall/NAT'>Inter-VLAN Routing with Upstream Port Behind Firewall/NAT</a></li>
</ul>
</li>
<li><a href='#L3HardwareOffloading-TypicalMisconfiguration'>Typical Misconfiguration</a>
<ul class='toc-indentation'>
<li><a href='#L3HardwareOffloading-VLANinterfaceonaswitchportorbond'>VLAN interface on a switch port or bond</a></li>
<li><a href='#L3HardwareOffloading-Notaddingthebridgeinterfaceto/interface/bridge/vlan/'>Not adding the bridge interface to /interface/bridge/vlan/</a></li>
<li><a href='#L3HardwareOffloading-Creatingmultiplebridges'>Creating multiple bridges</a></li>
<li><a href='#L3HardwareOffloading-Usingportsthatdonotbelongtotheswitch'>Using ports that do not belong to the switch</a></li>
<li><a href='#L3HardwareOffloading-RelyingonFasttrackHWOffloadingtoomuch'>Relying on Fasttrack HW Offloading too much</a></li>
<li><a href='#L3HardwareOffloading-Tryingtooffloadslow-pathconnections'>Trying to offload slow-path connections</a></li>
</ul>
</li>
<li><a href='#L3HardwareOffloading-L3HWFeatureSupport'>L3HW Feature Support</a></li>
<li><a href='#L3HardwareOffloading-L3HWDeviceSupport'>L3HW Device Support</a>
<ul class='toc-indentation'>
<li><a href='#L3HardwareOffloading-CRS3xx:SwitchDX3000andDX2000Series'>CRS3xx: Switch DX3000 and DX2000 Series</a>
<ul class='toc-indentation'>
<li><a href='#L3HardwareOffloading-Partialoffloading'>Partial offloading</a></li>
</ul>
</li>
<li><a href='#L3HardwareOffloading-CCR2xxx,CRS3xx,CRS5xx:SwitchDX8000andDX4000Series'>CCR2xxx, CRS3xx, CRS5xx: Switch DX8000 and DX4000 Series</a>
<ul class='toc-indentation'>
<li><a href='#L3HardwareOffloading-Partialoffloading.1'>Partial offloading</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div></p><h1 id="L3HardwareOffloading-Introduction">Introduction</h1><p><span style="color:var(--ds-text,#172b4d);"><strong>Layer 3 Hardware Offloading</strong> (<strong>L3HW</strong>, otherwise known as IP switching or HW routing) allows to offload some router features onto the switch chip. This allows reaching wire speeds when routing packets, which would simply not be possible with the CPU. </span></p><h1 id="L3HardwareOffloading-SwitchConfiguration">Switch Configuration</h1><p>To enable Layer 3 Hardware Offloading, set <code><span style="color:var(--ds-text-accent-green-bolder,#164b35);">l3-hw-offloading=yes</span></code> for the switch:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface/ethernet/switch set 0 l3-hw-offloading=yes</pre>
</div></div><h2 id="L3HardwareOffloading-SwitchPortConfiguration">Switch Port Configuration</h2><p>Layer 3 Hardware Offloading can be configured for each physical switch port. For example:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface/ethernet/switch/port set sfp-sfpplus1 l3-hw-offloading=yes</pre>
</div></div><p>Note that l3hw settings for switch and ports are different:</p><ul><li>Setting <span style="color:var(--ds-icon-success,#22a06b);"><code>l3-hw-offloading</code><code>=no</code></span> for the switch completely disables offloading - all packets will be routed by CPU.</li><li>However, setting <span style="color:var(--ds-icon-success,#22a06b);"><code>l3-hw-offloading</code><code>=no</code></span> for a switch port only disables hardware routing from/to this particular port. Moreover, the port can still participate in Fastrack connection offloading. </li></ul><p>To enable full hardware routing, enable l3hw on all switch ports:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface/ethernet/switch set 0 l3-hw-offloading=yes
/interface/ethernet/switch/port set [find] l3-hw-offloading=yes</pre>
</div></div><p>To make all packets go through the CPU first, and offload only the Fasttrack connections, disable l3hw on all ports but keep it enabled on the switch chip itself:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface/ethernet/switch set 0 l3-hw-offloading=yes
/interface/ethernet/switch/port set [find] l3-hw-offloading=no</pre>
</div></div><div role="region" aria-label="Info" class="confluence-information-macro  confluence-information-macro-information" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-info-filled confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p><strong>Packets are routed by hardware when both the ingress and egress ports have <code><span style="color:var(--ds-background-accent-green-bolder,#1f845a);">l3-hw-offloading=yes</span></code>.</strong></p><p>If both ingress and egress ports have <code><span style="color:var(--ds-background-accent-green-bolder,#1f845a);">l3-hw-offloading=no</span></code>, packets will go through the CPU/Firewall while offloading only the Fasttrack connections.</p><p>It is possible to direct packets to go through the CPU/Firewall by setting <code><span style="color:var(--ds-background-accent-green-bolder,#1f845a);">l3-hw-offloading=no</span></code> on just the egress port. However, setting <code><span style="color:var(--ds-background-accent-green-bolder,#1f845a);">l3-hw-offloading=no</span></code> only the ingress port may cause unpredictable behavior, for example, packets might still be routed by hardware and completely bypass the CPU/firewall. </p></div></div><p class="auto-cursor-target">The next example enables hardware routing on all ports but the upstream port (sfp-sfpplus16). Packets going to/from sfp-sfpplus16 will enter the CPU and, therefore, subject to Firewall/NAT processing.</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface/ethernet/switch set 0 l3-hw-offloading=yes
/interface/ethernet/switch/port set [find] l3-hw-offloading=yes
/interface/ethernet/switch/port set sfp-sfpplus16 l3-hw-offloading=no</pre>
</div></div><div role="region" aria-label="Warning" class="confluence-information-macro  confluence-information-macro-warning" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-error confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p>The existing connections may be unaffected by the <span style="color:var(--ds-icon-success,#22a06b);"><code>l3-hw-offloading</code></span> setting change.</p></div></div><h2 class="auto-cursor-target" id="L3HardwareOffloading-L3HWSettings">L3HW Settings</h2><h3 id="L3HardwareOffloading-BasicSettings">Basic Settings</h3><p>The L3HW Settings menu has been introduced in RouterOS version 7.6.</p><p><strong>Sub-menu:</strong><span> </span><code>/interface ethernet switch l3hw-settings</code></p><div class="table-wrap"><table class="wrapped confluenceTable"><colgroup><col/><col/></colgroup><thead><tr><th style="text-align: left;" class="confluenceTh"><p>Property</p></th><th style="text-align: left;" class="confluenceTh"><p>Description</p></th></tr></thead><tbody><tr><td style="text-align: left;" class="confluenceTd"><strong>autorestart</strong> <span style="color:var(--ds-text,#172b4d);">(</span><em style="text-align: left;">yes | no</em><span style="color:var(--ds-text,#172b4d);">; Default:</span><span style="color:var(--ds-text,#172b4d);"> </span><strong>no</strong><span style="color:var(--ds-text,#172b4d);">)</span></td><td style="text-align: left;" class="confluenceTd"><span style="color:var(--ds-text,#172b4d);">Automatically restarts the l3hw driver in case of an error. Otherwise, if an error occurs,<span> </span><code>l3-hw-offloading</code><span> </span>gets disabled, and the error code is displayed in the switch settings and<span> </span><a href="https://help.mikrotik.com/docs/display/ROS/L3+Hardware+Offloading#L3HardwareOffloading-Monitor" rel="nofollow">#monitor</a>. Autorestart does not work for system failures, such as OOM (Out Of Memory).</span></td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>fasttrack-hw</strong><span> </span><span style="color:var(--ds-text,#172b4d);">(</span><em style="text-align: left;">yes | no</em><span style="color:var(--ds-text,#172b4d);">; Default:</span><span style="color:var(--ds-text,#172b4d);"> </span><strong style="text-align: left;">yes<span> </span></strong>(if supported)<span style="color:var(--ds-text,#172b4d);">)</span></td><td style="text-align: left;" class="confluenceTd"><span style="color:var(--ds-text,#172b4d);">Enables or disables FastTrack HW Offloading. Keep it enabled unless HW TCAM memory reservation is required, e.g., for dynamic switch ACL rules creation. Not all switch chips support FastTrack HW Offloading (see<span> </span><strong>hw-supports-fasttrack</strong>).</span></td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>ipv6-hw</strong><span> </span><span style="color:var(--ds-text,#172b4d);">(</span><em style="text-align: left;">yes | no</em><span style="color:var(--ds-text,#172b4d);">; Default:</span><span style="color:var(--ds-text,#172b4d);"> </span><strong style="text-align: left;">no</strong><span style="color:var(--ds-text,#172b4d);">)</span></td><td style="text-align: left;" class="confluenceTd">Enables or disables IPv6 Hardware Offloading. Since IPv6 routes occupy a lot of HW memory, enable it only if IPv6 traffic speed is significant enough to benefit from hardware routing.</td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>icmp-reply-on-error</strong><span> </span><span style="color:var(--ds-text,#172b4d);">(</span><em style="text-align: left;">yes | no</em><span style="color:var(--ds-text,#172b4d);">; Default:</span><span style="color:var(--ds-text,#172b4d);"> </span><strong style="text-align: left;">yes</strong><span style="color:var(--ds-text,#172b4d);">)</span></td><td style="text-align: left;" class="confluenceTd">Since the hardware cannot send ICMP messages, the packet must be redirected to the CPU to send an ICMP reply in case of an error (e.g., &quot;Time Exceeded&quot;, &quot;Fragmentation required&quot;, etc.). Enabling icmp-reply-on-error<strong> </strong>helps with network diagnostics but may open potential vulnerabilities for DDoS attacks. Disabling icmp-reply-on-error silently drops the packets on the hardware level in case of an error.</td></tr></tbody></table></div><p class="auto-cursor-target"><strong>Read-Only Properties</strong></p><div class="table-wrap"><table class="wrapped confluenceTable"><colgroup><col/><col/></colgroup><thead><tr><th style="text-align: left;" class="confluenceTh"><p>Property</p></th><th style="text-align: left;" class="confluenceTh"><p>Description</p></th></tr></thead><tbody><tr><td style="text-align: left;" class="confluenceTd"><strong>hw-supports-fasttrack</strong><span> </span>(<em><em style="text-align: left;">yes | no</em></em><span style="color:var(--ds-text,#172b4d);">)</span></td><td style="text-align: left;" class="confluenceTd">Indicates if the hardware (switch chip) supports FastTrack HW Offloading.</td></tr></tbody></table></div><h3 class="auto-cursor-target" id="L3HardwareOffloading-AdvancedSettings">Advanced Settings</h3><p>This menu allows tweaking l3hw settings for specific use cases.</p><div role="region" aria-label="Warning" class="confluence-information-macro  confluence-information-macro-warning" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-error confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p>It is NOT recommended to change the advanced L3HW settings unless instructed by MikroTik Support or MikroTik Certified Routing Engineer. Applying incorrect settings may break the L3HW operation.</p></div></div><p><strong>Sub-menu:</strong><span> </span><code>/interface ethernet switch l3hw-settings</code> advanced</p><div class="table-wrap"><table class="wrapped confluenceTable"><colgroup class=""><col class=""/><col class=""/></colgroup><thead class=""><tr class=""><th style="text-align: left;" class="confluenceTh"><p>Property</p></th><th style="text-align: left;" class="confluenceTh"><p>Description</p></th></tr></thead><tbody class=""><tr class=""><td style="text-align: left;" class="confluenceTd"><strong>route-queue-limit-high</strong><span> </span><span style="color:var(--ds-text,#172b4d);">(</span><em style="text-align: left;">number</em><span style="color:var(--ds-text,#172b4d);">; Default:</span><span style="color:var(--ds-text,#172b4d);"> </span><strong style="text-align: left;">256</strong><span style="color:var(--ds-text,#172b4d);">)</span></td><td style="text-align: left;" class="confluenceTd"><p>The switch driver stops route indexing when<span> </span><span style="color:var(--ds-icon-success,#22a06b);"><strong>route-queue-size</strong></span><span> </span>(see<span> </span><a href="https://help.mikrotik.com/docs/display/ROS/L3+Hardware+Offloading#L3HardwareOffloading-Monitor" rel="nofollow">#monitor</a>) exceeds this value. Lowering this value leads to faster route processing but increases the lag between a route's appearance in RouterOS and hardware memory.</p><p>Setting<span> </span><strong><span style="color:var(--ds-icon-success,#22a06b);">route-queue-limit-high=0</span><span> </span></strong>disables route indexing when there are any routes in the processing queue -  the most efficient CPU usage but the longest delay before hardware offloading. Useful when there are static routes only. Not recommended together with routing protocols (such as BGP or OSPF) when there are frequent routing table changes.</p></td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>route-queue-limit-low</strong><span> </span><span style="color:var(--ds-text,#172b4d);">(</span><em style="text-align: left;">number</em><span style="color:var(--ds-text,#172b4d);">; Default:</span><span style="color:var(--ds-text,#172b4d);"> </span><strong style="text-align: left;">0</strong><span style="color:var(--ds-text,#172b4d);">)</span></td><td style="text-align: left;" class="confluenceTd"><p>Re-enable route indexing when<span> </span><span style="color:var(--ds-icon-success,#22a06b);"><strong>route-queue-size</strong></span><span> </span>drops down to this value. Must not exceed the high limit.</p><p>Setting<span> </span><span style="color:var(--ds-icon-success,#22a06b);"><strong>route-queue-limit-low=0 </strong></span>tells the switch driver to process all pending routes before the next hw-offloading attempt. While this is the desired behavior, it may completely block the hw-offloading under a constant BGP feed.</p></td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>shwp-reset-counter </strong><span> </span><span style="color:var(--ds-text,#172b4d);">(</span><em>number</em><span style="color:var(--ds-text,#172b4d);">; Default:</span><span style="color:var(--ds-text,#172b4d);"> </span><strong>128</strong><span style="color:var(--ds-text,#172b4d);">)</span></td><td style="text-align: left;" class="confluenceTd"><p>Reset the Shortest HW Prefix (see<span> </span><span style="color:var(--ds-icon-success,#22a06b);"><strong>ipv4-shortest-hw-prefix</strong></span><span> </span>/<span> </span><strong>i<span style="color:var(--ds-icon-success,#22a06b);">pv6-shortest-hw-prefix</span></strong><span> </span>in<span> </span><a href="https://help.mikrotik.com/docs/display/ROS/L3+Hardware+Offloading#L3HardwareOffloading-Monitor" rel="nofollow">#monitor</a>) and try the full route table offloading after this amount of changes in the routing table. At a partial offload, when the entire routing table does not fit into the hardware memory and shorter prefixes are redirected to the CPU, there is no need to try offloading route prefixes shorter than SHWP since those will get redirected to the CPU anyway, theoretically. However, significant changes to the routing table may lead to a different index layout and, therefore, a different amount of routes that can be hw-offloaded. That's why it is recommended to do the full table re-indexing occasionally.</p><p>Lowering this value may allow more routes to be hw-offloaded but increases CPU usage and vice-versa. Setting<span> </span><span style="color:var(--ds-icon-success,#22a06b);"><strong>shwp-reset-counter=0</strong></span><span> </span>always does full re-indexing after each routing table change.</p><p>This setting is used only during Partial Offloading and has no effect when<span> </span><span style="color:var(--ds-icon-success,#22a06b);"><strong>ipv4-shortest-hw-prefix=0</strong> </span>(and ipv6, respectively).</p></td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>partial-offload-chunk </strong><span style="color:var(--ds-text,#172b4d);">(</span><em>number</em><span style="color:var(--ds-text,#172b4d);">; Default:</span><span style="color:var(--ds-text,#172b4d);"> </span><strong>1024</strong>, min: 16<span style="color:var(--ds-text,#172b4d);">)</span></td><td style="text-align: left;" class="confluenceTd"><p>The minimum number of routes for incremental adding in Partial Offloading. Depending on the switch chip model, routes are offloaded either as-is (each routing entry in RouterOS corresponds to an entry in the hardware memory) or getting indexed, and the index entries are the ones that are written into the hardware memory. This setting is used only for the latter during Partial Offloading.</p><p>Depending on index fragmentation, a single IPv4 route addition can occupy from -3 to +6 LPM blocks of HW memory (some route addition may lower the amount of required HW memory thanks to index defragmentation). Hence, it is impossible to predict the exact number of routes that may fit in the hardware memory. The switch driver uses a binary split algorithm to find the maximum number of routes that fit in the hardware.</p><p>Let's imagine 128k routes, all of them not fitting into the hardware memory. The algorithm halves the number and tries offloading 64k routes. Let's say offloading succeeded. In the next iteration, the algorithm picks 96k, let's say it fails; then 80k - fails again, 72k - succeeds, 76k, etc. until the difference between succeeded and failed numbers drops below the<span> </span><strong><span style="color:var(--ds-icon-success,#22a06b);">partial-offload-chunk</span><span> </span></strong>value.</p><p>Lowering the<span> </span><strong><span style="color:var(--ds-icon-success,#22a06b);">partial-offload-chunk</span><span> </span></strong>value increases the number of hw-offloaded routes but also raises CPU usage and vice-versa.</p></td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>route-index-delay-min</strong><span> </span><span style="color:var(--ds-text,#172b4d);">(</span><em>time</em><span style="color:var(--ds-text,#172b4d);">; Default:</span><span style="color:var(--ds-text,#172b4d);"> </span><strong>1s</strong><span style="color:var(--ds-text,#172b4d);">)</span></td><td style="text-align: left;" class="confluenceTd"><p>The minimum delay between route processing and its offloading. The delay allows processing more routes together and offloading them at once, saving CPU usage. It also makes offloading the entire routing table faster by reducing the per-route processing work. On the other hand, it slows down the offloading of an individual route.</p><p>If an additional route is received during the delay, the latter resets to the<span> </span><span style="color:var(--ds-icon-success,#22a06b);"><strong>route-index-delay-min</strong></span><span> </span>value<strong>.</strong><span> </span>Adding more and more routes within the delay keeps resetting the timer until the<span> </span><strong><span style="color:var(--ds-icon-success,#22a06b);">route-index-delay-max</span><span> </span></strong>is reached.</p></td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>route-index-delay-max</strong> <span style="color:var(--ds-text,#172b4d);">(</span><em>time</em><span style="color:var(--ds-text,#172b4d);">; Default:</span><span style="color:var(--ds-text,#172b4d);"> </span><strong>10s</strong><span style="color:var(--ds-text,#172b4d);">)</span></td><td style="text-align: left;" class="confluenceTd"><p>The maximum delay between route processing and its offloading. When the maximum delay is reached, the processed routes get offloaded despite more routes pending. However,<span> </span><strong><span style="color:var(--ds-icon-success,#22a06b);">route-queue-limit-high</span> </strong>has higher priority than this, meaning that the indexing/offloading gets paused anyway when a certain queue size is reached.</p></td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>neigh-keepalive-interval</strong><span> </span><span style="color:var(--ds-text,#172b4d);">(</span><em>time</em><span style="color:var(--ds-text,#172b4d);">; Default:</span><span style="color:var(--ds-text,#172b4d);"> <strong>1</strong></span><strong>5s</strong>, min: 5s<span style="color:var(--ds-text,#172b4d);">)</span></td><td style="text-align: left;" class="confluenceTd"><p>Neighbor (host) keepalive interval. When a host (IP neighbor) gets hw-offloaded, all traffic from/to it is routed by the switch chip, and RouterOS may think the neighbor is inactive and delete it. To prevent that, the switch driver must keep the offloaded neighbors alive by sending periodical refreshes to RouterOS.</p></td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>neigh-discovery-interval</strong><span> </span><span style="color:var(--ds-text,#172b4d);">(</span><em>time</em><span style="color:var(--ds-text,#172b4d);">; Default:</span><span style="color:var(--ds-text,#172b4d);"><span> </span><strong>1m37s</strong></span>, min: 30s<span style="color:var(--ds-text,#172b4d);">)</span></td><td style="text-align: left;" class="confluenceTd"><p>Unfortunately, switch chips do not provide per-neighbor stats. Hence, the only way to check if the offloaded host is still active is by sending occasional ARP (IPv4) / Neighbor Discovery (IPv6) requests to the connected network. Increasing the value lowers the broadcast traffic but may leave inactive hosts in hardware memory for longer.</p><p>Neighbor discovery is triggered within the neighbor keepalive work. Hence, the discovery time is rounded up to the next keepalive session. Choose a value for<span> </span><span style="color:var(--ds-icon-success,#22a06b);"><strong>neigh-discovery-interval</strong></span><span> </span>not dividable by<span> </span><span style="color:var(--ds-icon-success,#22a06b);"><strong>neigh-keepalive-interval</strong></span><span> </span>to send ARP/ND requests in various sessions, preventing broadcast bursts.</p></td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>neigh-discovery-burst-limit</strong><strong> </strong><span style="color:var(--ds-text,#172b4d);">(</span><em>number</em><span style="color:var(--ds-text,#172b4d);">; Default:</span><span style="color:var(--ds-text,#172b4d);"> </span><strong>64</strong><span style="color:var(--ds-text,#172b4d);">)</span></td><td style="text-align: left;" class="confluenceTd"><p>The maximum number of ARP/ND requests that can be sent at once.</p></td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>neigh-discovery-burst-delay</strong><span> </span><span style="color:var(--ds-text,#172b4d);">(</span><em>time</em><span style="color:var(--ds-text,#172b4d);">; Default:</span><span style="color:var(--ds-text,#172b4d);"><span> </span><strong>300ms</strong></span>, min: 10ms<span style="color:var(--ds-text,#172b4d);">)</span></td><td style="text-align: left;" class="confluenceTd"><p>The delay between ARP/ND subsequent bursts if the number of requests exceeds<span> </span><span style="color:var(--ds-icon-success,#22a06b);"><strong>neigh-discovery-burst-limit</strong></span><strong>.</strong></p></td></tr></tbody></table></div><p><br/></p><div role="region" aria-label="Info" class="confluence-information-macro  confluence-information-macro-information" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-info-filled confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p>Some settings only apply to certain switch models.</p></div></div><h3 class="auto-cursor-target" id="L3HardwareOffloading-Monitor">Monitor</h3><p>The L3HW Monitor feature has been introduced in RouterOS version 7.10. It allows monitoring of switch chip and driver stats related to L3HW. </p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface/ethernet/switch/l3hw-settings/monitor
        ipv4-routes-total: 99363
           ipv4-routes-hw: 61250
          ipv4-routes-cpu: 38112
  ipv4-shortest-hw-prefix: 24
               ipv4-hosts: 87
        ipv6-routes-total: 15
           ipv6-routes-hw: 11
          ipv6-routes-cpu: 4
  ipv6-shortest-hw-prefix: 0
               ipv6-hosts: 7
         route-queue-size: 118
     fasttrack-ipv4-conns: 2031
   fasttrack-hw-min-speed: 0
              nexthop-cap: 8192
            nexthop-usage: 93
    vxlan-mtu-packet-drop: 0</pre>
</div></div><p class="auto-cursor-target"><strong>Stats</strong></p><div class="table-wrap"><table class="wrapped confluenceTable"><colgroup class=""><col class=""/><col class=""/></colgroup><thead class=""><tr class=""><th style="text-align: left;" class="confluenceTh"><p>Property</p></th><th style="text-align: left;" class="confluenceTh"><p>Description</p></th></tr></thead><tbody class=""><tr class=""><td style="text-align: left;" class="confluenceTd"><strong>ipv4-routes-total</strong></td><td style="text-align: left;" class="confluenceTd">The total number of IPv4 routes handled by the switch driver.</td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>ipv4-routes-hw</strong></td><td style="text-align: left;" class="confluenceTd">The number of hardware-offloaded IPv4 routes (a.k.a. hardware routes)</td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>ipv4-routes-cpu</strong></td><td style="text-align: left;" class="confluenceTd">The number of IPv4 routes redirected to the CPU (a.k.a. software routes)</td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>ipv4-shortest-hw-prefix</strong></td><td style="text-align: left;" class="confluenceTd"><em>Shortest Hardware Prefix (SHWP)<span> </span></em>for IPv4. If the entire IPv4 routing table does not fit into the hardware memory,<span> </span><em>partial offloading</em><span> </span>is applied, where the longest prefixes are hw-offloaded while the shorter ones are redirected to the CPU. This field shows the shortest route prefix (/x) that is offloaded to the hardware memory. All prefixes shorter than this are processed by the CPU. &quot;<span style="color:var(--ds-icon-success,#22a06b);"><code>ipv4-shortest-hw-prefix=0</code></span>&quot; means the entire IPv4 routing table is offloaded to the hardware memory.</td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>ipv4-hosts</strong></td><td style="text-align: left;" class="confluenceTd">The number of hardware-offloaded IPv4 hosts (/32 routes)</td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>ipv6-routes-total<span> </span></strong><em><sup>1</sup></em></td><td style="text-align: left;" class="confluenceTd">The total number of IPv6 routes handled by the switch driver.</td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>ipv6-routes-hw</strong><span> </span><em><sup>1</sup></em></td><td style="text-align: left;" class="confluenceTd">The number of hardware-offloaded IPv6 routes (a.k.a. hardware routes)</td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>ipv6-routes-cpu</strong><span> </span><em><sup>1</sup></em></td><td style="text-align: left;" class="confluenceTd">The number of IPv6 routes redirected to the CPU (a.k.a. software routes)</td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>ipv6-shortest-hw-prefix</strong><strong><span> </span></strong><em><sup>1</sup></em></td><td style="text-align: left;" class="confluenceTd"><em>Shortest Hardware Prefix (SHWP)<span> </span></em>for IPv6. If the entire IPv6 routing table does not fit into the hardware memory,<span> </span><em>partial offloading</em><span> </span>is applied, where the longest prefixes are hw-offloaded while the shorter ones are redirected to the CPU. This field shows the shortest route prefix (/x) that is offloaded to the hardware memory. All prefixes shorter than this are processed by the CPU. &quot;<span style="color:var(--ds-icon-success,#22a06b);"><code>ipv6-shortest-hw-prefix=0</code></span>&quot; means the entire IPv6 routing table is offloaded to the hardware memory.</td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>ipv6-hosts<span> </span></strong><em><sup>1</sup></em></td><td style="text-align: left;" class="confluenceTd">The number of hardware-offloaded IPv6 hosts (/128 routes)</td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>route-queue-size</strong></td><td style="text-align: left;" class="confluenceTd">The number of routes in the queue for processing by the switch chip driver. Under normal working conditions, this field is 0, meaning that all routes are processed by the driver.</td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>nexthop-cap</strong></td><td style="text-align: left;" class="confluenceTd">The nexthop capacity.</td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>nexthop-usage</strong></td><td style="text-align: left;" class="confluenceTd">The number of currently used nexthops.</td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>vxlan-mtu-packet-drop</strong></td><td style="text-align: left;" class="confluenceTd">The number of dropped VXLAN packets due to exceeded interface MTU settings.</td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>fasttrack-ipv4-conns</strong><span> </span><em><sup>2</sup></em></td><td style="text-align: left;" class="confluenceTd">The number of hardware-offloaded FastTrack connections.</td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>fasttrack-hw-min-speed</strong><span> </span><em><sup>2</sup></em></td><td style="text-align: left;" class="confluenceTd">When the hardware memory for storing FastTrack is full, this field shows the minimum speed (in bytes per second) of a hw-offloaded FastTrack connection. Slower connections are routed by the CPU.</td></tr></tbody></table></div><p class="auto-cursor-target"><em><sup>1</sup><span> </span>IPv6 stats appear only when IPv6 hardware routing is enabled (<span style="color:var(--ds-icon-success,#22a06b);"><code>ipv6-hw=yes</code></span>)</em></p><p class="auto-cursor-target"><em><sup>2</sup><span> </span>FastTrack stats appear only when hardware offloading of FastTrack connections is enabled (<span style="color:var(--ds-icon-success,#22a06b);">fasttrack-hw<code>=yes</code></span>)</em></p><h3 class="auto-cursor-target" id="L3HardwareOffloading-AdvancedMonitor">Advanced Monitor</h3><p>An enhanced version of Monitor with extra telemetry data for advanced users. Advanced Monitor contains all data from the basic monitor<span> </span>plus the fields listed below.</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface/ethernet/switch/l3hw-settings/advanced&gt; monitor once
        ipv4-routes-total: 29968
           ipv4-routes-hw: 29957
          ipv4-routes-cpu: 11
  ipv4-shortest-hw-prefix: 0
               ipv4-hosts: 3
        ipv6-routes-total: 4
           ipv6-routes-hw: 0
          ipv6-routes-cpu: 4
  ipv6-shortest-hw-prefix: 0
               ipv6-hosts: 0
         route-queue-size: 0
         route-queue-rate: 0
       route-process-rate: 0
     fasttrack-ipv4-conns: 0
     fasttrack-queue-size: 0
     fasttrack-queue-rate: 0
   fasttrack-process-rate: 0
   fasttrack-hw-min-speed: 0
   fasttrack-hw-offloaded: 0
    fasttrack-hw-unloaded: 0
                  lpm-cap: 54560
                lpm-usage: 31931
             lpm-bank-cap: 2728
           lpm-bank-usage: 46,0,0,0,2589,2591,1983,0,2728,2728,2728,2728,2728,2728,2728,2728,2728,170,0,0
                  pbr-cap: 8192
                pbr-usage: 0
             pbr-lpm-bank: 3
                nat-usage: 0
              nexthop-cap: 8192
            nexthop-usage: 85</pre>
</div></div><p class="auto-cursor-target"><strong>Stats</strong></p><div class="table-wrap"><table class="wrapped confluenceTable"><colgroup class=""><col class=""/><col class=""/></colgroup><thead class=""><tr class=""><th style="text-align: left;" class="confluenceTh"><p>Property</p></th><th style="text-align: left;" class="confluenceTh"><p>Description</p></th></tr></thead><tbody class=""><tr class=""><td style="text-align: left;" class="confluenceTd"><strong>route-queue-rate</strong></td><td style="text-align: left;" class="confluenceTd">The rate at which routes are added to the queue for the switch driver processing. In other words, the growth rate of<span> </span><span style="color:var(--ds-icon-success,#22a06b);"><strong>route-queue-size</strong> </span>(routes per second)</td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>route-process-rate</strong></td><td style="text-align: left;" class="confluenceTd">The rate at which previously queued routes are processed by the switch driver. In other words, the shrink rate of<span> </span><span style="color:var(--ds-icon-success,#22a06b);"><strong>route-queue-size</strong></span><span> </span>(routes per second)</td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>fasttrack-queue-size</strong></td><td style="text-align: left;" class="confluenceTd">The number of FastTrack connections in the queue for processing by the switch chip driver.</td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>fasttrack-queue-rate</strong></td><td style="text-align: left;" class="confluenceTd">The rate at which FastTrack connections are added to the queue for the switch driver processing. In other words, the growth rate of<span> </span><span style="color:var(--ds-icon-success,#22a06b);"><strong>fasttrack-queue-size</strong></span><span> </span>(connections per second)</td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>fasttrack-process-rate</strong></td><td style="text-align: left;" class="confluenceTd">The rate at which previously queued FastTrack connections are processed by the switch driver. In other words, the shrink rate of<span> </span><span style="color:var(--ds-icon-success,#22a06b);"><strong>fasttrack-queue-size</strong></span><span> </span>(connections per second)</td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>fasttrack-hw-offloaded</strong></td><td style="text-align: left;" class="confluenceTd">The number of FastTrack connections offloaded to the hardware. The counter resets every second (or every monitor interval).</td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>fasttrack-hw-unloaded</strong></td><td style="text-align: left;" class="confluenceTd">The number of FastTrack connections unloaded from the hardware (redirected to software routing). The counter resets every second (or every monitor interval).</td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>lpm-cap</strong></td><td style="text-align: left;" class="confluenceTd">The size of the LPM hardware table (LPM = Longest Prefix Match). LPM stores route indexes for hardware routing. Not every switch chip model uses LPM. Others use TCAM.</td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>lpm-usage</strong></td><td style="text-align: left;" class="confluenceTd">The number of used LPM blocks.<span> </span><strong><span style="color:var(--ds-icon-success,#22a06b);">lpm-usage</span><span> </span></strong>/<span> </span><span style="color:var(--ds-icon-success,#22a06b);"><strong>lpm-cap</strong></span><span> </span>= usage percentage.</td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>lpm-bank-cap</strong></td><td style="text-align: left;" class="confluenceTd">LPM memory is organized in banks - special memory units. The bank size depends on the switch chip model. This value shows the size of a single bank (in LPM blocks).<span> </span><span style="color:var(--ds-icon-success,#22a06b);"><strong>lpm-cap</strong></span><span> </span>/<span> </span><span style="color:var(--ds-icon-success,#22a06b);"><strong>lpm-bank-cap</strong> </span>= the number of banks (usually, 20).</td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>lpm-bank-usage</strong></td><td style="text-align: left;" class="confluenceTd">Per-bank LPM usage (in LPM blocks)</td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>pbr-cap</strong></td><td style="text-align: left;" class="confluenceTd">The size of the Policy-Based Routing (PBR) hardware table. PBR is used for NAT offloading of FastTrack connections.</td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>pbr-usage</strong></td><td style="text-align: left;" class="confluenceTd">The number of used PBR entries.<span> </span><strong><span style="color:var(--ds-icon-success,#22a06b);">pbr-usage</span><span> </span></strong>/<span> </span><span style="color:var(--ds-icon-success,#22a06b);"><strong>pbr-cap</strong></span><span> </span>= usage percentage.</td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>pbr-lpm-bank</strong></td><td style="text-align: left;" class="confluenceTd">PBR shares LPM memory banks with routing tables. This value shows the LPM bank index shared with PBR (0 = the first bank).</td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>nat-usage</strong></td><td style="text-align: left;" class="confluenceTd">The number of used NAT hardware entries (for FastTrack connections).</td></tr></tbody></table></div><h2 id="L3HardwareOffloading-InterfaceLists"><span style="font-size: 20.0px;letter-spacing: -0.008em;">Interface Lists</span></h2><p>It is impossible to use interface lists directly to control <span style="color:var(--ds-icon-success,#22a06b);"><code>l3-hw-offloading</code> </span>because an interface list may contain virtual interfaces (such as VLAN) while the <code><span style="color:var(--ds-icon-success,#22a06b);">l3-hw-offloading</span></code> setting must be applied to physical switch ports only. For example, if there are two VLAN interfaces (vlan20 and vlan30) running on the same switch port (trunk port), it is impossible to enable hardware routing on vlan20 but keep it disabled on vlan30.</p><p><span>However, an interface list may be used as a port selector. The following example demonstrates how to enable hardware routing on LAN ports (ports that belong to the &quot;LAN&quot; interface list) and disable it on WAN ports:</span></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">:foreach i in=[/interface/list/member/find where list=LAN] do={
    /interface/ethernet/switch/port set [/interface/list/member/get $i interface] l3-hw-offloading=yes
}

:foreach i in=[/interface/list/member/find where list=WAN] do={
    /interface/ethernet/switch/port set [/interface/list/member/get $i interface] l3-hw-offloading=no
}</pre>
</div></div><p><span>Please take into account that since interface lists are not directly used in hardware routing control., <strong>modifying the interface list also does not automatically reflect in l3hw changes</strong>. For instance, adding a switch port to the &quot;LAN&quot; interface list does not automatically enable <span style="color:var(--ds-icon-success,#22a06b);"><code>l3-hw-offloading</code></span> on it. The user has to rerun the above script to apply the changes.</span></p><h2 id="L3HardwareOffloading-MTU">MTU</h2><p>The hardware supports up to 8 MTU profiles, meaning that the user can set up to 8 different MTU values for interfaces: the default 1500 + seven custom ones.</p><div role="region" aria-label="Info" class="confluence-information-macro  confluence-information-macro-information" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-info-filled confluence-information-macro-icon" ></span><div class="confluence-information-macro-body">It is recommended to disable <span style="color:var(--ds-icon-success,#22a06b);"><code>l3-hw-offloading</code> </span>while changing the MTU/L2MTU values on the interfaces.</div></div><div class="code panel pdl" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b> MTU Change Example</b></div><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface/ethernet/switch set 0 l3-hw-offloading=no
/interface set sfp-sfpplus1 mtu=9000 l2mtu=9022
/interface set sfp-sfpplus2 mtu=9000 l2mtu=9022
/interface set sfp-sfpplus3 mtu=10000 l2mtu=10022
/interface/ethernet/switch set 0 l3-hw-offloading=yes</pre>
</div></div><h2 id="L3HardwareOffloading-Layer2Dependency">Layer 2 Dependency</h2><p>Layer 3 hardware processing lies on top of Layer 2 hardware processing. Therefore, L3HW offloading requires L2HW offloading on the underlying interfaces. The latter is enabled by default, but there are some exceptions. For example, CRS3xx devices support only one hardware bridge. If there are multiple bridges, others are processed by the CPU and are not subject to L3HW. </p><p>Another example is ACL rules. If a rule redirects traffic to the CPU for software processing, then hardware routing (L3HW) is not triggered:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>ACL rule to disable hardware processing on a specific port</b></div><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface/ethernet/switch/rule/add switch=switch1 ports=ether1 redirect-to-cpu=yes</pre>
</div></div><div role="region" aria-label="Info" class="confluence-information-macro  confluence-information-macro-information" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-info-filled confluence-information-macro-icon" ></span><div class="confluence-information-macro-body">It is recommended to turn off L3HW offloading during L2 configuration.</div></div><p>To make sure that Layer 3 is in sync with Layer 2 on both the software and hardware sides, we recommend disabling L3HW while configuring Layer 2 features. The recommendation applies to the following configuration:</p><ul><li>adding/removing/enabling/disabling bridge;</li><li>adding/removing switch ports to/from the bridge;</li><li><span class="v1diff-html-added">bonding switch ports / removing bond;</span></li><li>changing VLAN settings;</li><li>changing MTU/L2MTU on switch ports;</li><li>changing ethernet (MAC) addresses.</li></ul><p>In short, disable <span style="color:var(--ds-icon-success,#22a06b);"><code>l3-hw-offloading</code></span> while making changes under <span style="color:var(--ds-icon-success,#22a06b);"><code>/interface/bridge/</code></span> and <span style="color:var(--ds-icon-success,#22a06b);"><code>/interface/vlan/</code></span>:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>Layer 2 Configuration Template</b></div><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface/ethernet/switch set 0 l3-hw-offloading=no

/interface/bridge
# put bridge configuration changes here

/interface/vlan
# define/change VLAN interfaces

/interface/ethernet/switch set 0 l3-hw-offloading=yes</pre>
</div></div><h2 id="L3HardwareOffloading-MACtelnet"><span style="color:var(--ds-text,#333333);">MAC telnet</span></h2><p><span style="color:var(--ds-text,#333333);">There is a limitation for MAC telnet when L3HW offloading is enabled on <strong>98DX8xxx</strong>, <strong>98DX4xxx,</strong> or <strong>98DX325x</strong> switch chips. Packets from MAC Telnet are dropped and do not reach the CPU, thus access to the device will fail.</span></p><p><span style="color:var(--ds-text,#333333);">If MAC telnet is desired in combination with L3HW, certain ACL rule can be created to force these packets to the CPU.</span></p><p><span style="color:var(--ds-text,#333333);">For example, if MAC telnet access on sfp-sfpplus1 and sfp-sfpplus2 is needed, you will need to add this ACL rule. It is possible to select even more interfaces with the <code><span style="color:var(--ds-icon-success,#22a06b);">ports</span></code> setting.</span></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface ethernet switch rule
add dst-port=20561 ports=sfp-sfpplus1,sfp-sfpplus2 protocol=udp redirect-to-cpu=yes switch=switch1</pre>
</div></div><h2 id="L3HardwareOffloading-Inter-VLANRouting">Inter-VLAN Routing</h2><p>Since L3HW depends on L2HW, and L2HW is the one that does VLAN processing, Inter-VLAN <em>hardware</em> routing requires a hardware bridge underneath. Even if a particular VLAN has only one tagged port member, the latter must be a bridge member. Do not assign a VLAN interface directly on a switch port! Otherwise, L3HW offloading fails and the traffic will get processed by the CPU:</p><p><code><span style="color:var(--ds-background-accent-red-bolder,#c9372c);"><s>/interface/vlan add interface=ether2 name=vlan20 vlan-id=20</s></span></code></p><p>Assign the VLAN interface to the bridge instead. This way, VLAN configuration gets offloaded to the hardware, and, with L3HW enabled, the traffic is subject to inter-VLAN hardware routing.</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>VLAN Configuration Example</b></div><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface/ethernet/switch set 0 l3-hw-offloading=no
/interface/bridge/port add bridge=bridge interface=ether2
/interface/bridge/vlan add bridge=bridge tagged=bridge,ether2 vlan-ids=20
/interface/vlan add interface=bridge name=vlan20 vlan-id=20
/ip/address add address=192.0.2.1/24 interface=vlan20
/interface/bridge set bridge vlan-filtering=yes
/interface/ethernet/switch set 0 l3-hw-offloading=yes</pre>
</div></div><div role="region" aria-label="Info" class="confluence-information-macro  confluence-information-macro-information" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-info-filled confluence-information-macro-icon" ></span><div class="confluence-information-macro-body">For Inter-VLAN routing, the bridge interface must be a tagged member of every routable <span style="color:var(--ds-icon-success,#22a06b);"><code>/interface/bridge/vlan/</code></span> entry.</div></div><h2 id="L3HardwareOffloading-L3HWMACAddressRangeLimitation(DX2000/DX3000seriesonly)">L3HW MAC Address Range Limitation (DX2000/DX3000 series only)</h2><p>Marvell Prestera DX2000 and DX3000 switch chips have a hardware limitation that allows configuring only the last (least significant) octet of the MAC address for each interface. The other five (most significant) octets are configured globally and, therefore, must be equal for all interfaces (switch ports, bridge, VLANs). In other words, the MAC addresses must be in the format &quot;<strong>XX:XX:XX:XX:XX:??</strong>&quot;, where:</p><ul><li>&quot;<strong>XX:XX:XX:XX:XX</strong>&quot; part is common for all interfaces.</li><li>&quot;<strong>??</strong>&quot; is a variable part.</li></ul><p><strong>This requirement applies only to Layer 3 (routing).</strong> Layer 2 (bridging) does not use the switch's ethernet addresses. Moreover, it does not apply to bridge ports because they use the bridge's MAC address.</p><p>The requirement for common five octets applies to:</p><ul><li>Standalone switch ports (not bridge members) with hardware routing enabled (<code>l3-hw-offloading=yes</code>).</li><li>Bridge itself.</li><li>VLAN interfaces (those that use the bridge's MAC address by default).</li></ul><h1 id="L3HardwareOffloading-RouteConfiguration">Route Configuration</h1><h2 id="L3HardwareOffloading-SuppressingHWOffload">Suppressing HW Offload</h2><p><span style="color:var(--ds-text,#172b4d);">By default, all the routes are participating to be hardware candidate routes. To further fine-tune which traffic to offload, there is an option for each route to disable/enable<span> </span></span><strong><span style="color:var(--ds-text-accent-green-bolder,#164b35);"><code>suppress-hw-offload</code></span></strong><span style="color:var(--ds-text,#172b4d);">. </span></p><p><span style="color:var(--ds-text,#172b4d);">For example, if we know that the majority of traffic flows to the network where servers are located, we can enable offloading only to that specific destination:</span></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/ip/route set [find where static &amp;&amp; dst-address!=&quot;192.168.3.0/24&quot;] suppress-hw-offload=yes</pre>
</div></div><p><span style="color:var(--ds-text,#172b4d);">Now only the route to 192.168.3.0/24 has H-flag, indicating that it will be the only one eligible to be selected for HW offloading:</span></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">[admin@MikroTik] &gt; /ip/route print where static
Flags: A - ACTIVE; s - STATIC, y - COPY; H - HW-OFFLOADED
Columns: DST-ADDRESS, GATEWAY, DISTANCE
#     DST-ADDRESS       GATEWAY         D
0 As  0.0.0.0/0         172.16.2.1      1
1 As  10.0.0.0/8        10.155.121.254  1
2 AsH 192.168.3.0/24    172.16.2.1      1</pre>
</div></div><div role="region" aria-label="Warning" class="confluence-information-macro  confluence-information-macro-warning" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-error confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p><span style="color:var(--ds-text,#333333);">H-flag does not indicate that the route is actually HW offloaded, it indicates only that the route can be selected to be HW offloaded.</span></p></div></div><h2 id="L3HardwareOffloading-RoutingFilters">Routing Filters</h2><p>For dynamic routing protocols like OSFP and BGP, it is possible to suppress HW offloading using <a href="https://help.mikrotik.com/docs/pages/viewpage.action?pageId=74678285" rel="nofollow">routing filters</a>. For example, to suppress HW offloading on all OSFP instance routes, use &quot;<strong><span style="color:var(--ds-text-accent-green-bolder,#164b35);"><code>suppress-hw-offload yes</code></span></strong><span style="color:var(--ds-text,#333333);">&quot; property:</span></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/routing/ospf/instance
set [find name=instance1] in-filter-chain=ospf-input
/routing/filter/rule
add chain=&quot;ospf-input&quot; rule=&quot;set suppress-hw-offload yes; accept&quot;</pre>
</div></div><h2 id="L3HardwareOffloading-OffloadingFasttrackConnections">Offloading Fasttrack Connections</h2><p>Firewall filter rules have <span style="color:var(--ds-text-accent-green-bolder,#164b35);"><strong><code>hw-offload</code></strong> </span>option for Fasttrack, allowing fine-tuning connection offloading. Since the hardware memory for Fasttrack connections is very limited, we can choose what type of connections to offload and, therefore, benefit from near-the-wire-speed traffic. The next example offloads only TCP connections while UDP packets are routed via the CPU and do not occupy HW memory:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/ip/firewall/filter
add action=fasttrack-connection chain=forward connection-state=established,related hw-offload=yes protocol=tcp
add action=fasttrack-connection chain=forward connection-state=established,related hw-offload=no
add action=accept chain=forward connection-state=established,related</pre>
</div></div><h2 id="L3HardwareOffloading-StatelessHardwareFirewall">Stateless Hardware Firewall</h2><p>While connection tracking and stateful firewalling can be performed only by the CPU, the hardware can perform stateless firewalling via<span> </span><a class="external-link" href="https://help.mikrotik.com/docs/display/ROS/CRS3xx%2C+CRS5xx%2C+CCR2116%2C+CCR2216+switch+chip+features#CRS3xx,CRS5xx,CCR2116,CCR2216switchchipfeatures-SwitchRules(ACL)" rel="nofollow">switch rules (ACL)</a>. The next example prevents (on a hardware level) accessing a MySQL server from the ether1, and redirects to the CPU/Firewall packets from ether2 and ether3:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface ethernet switch rule
add switch=switch1 dst-address=10.0.1.2/32 dst-port=3306 ports=ether1 new-dst-ports=&quot;&quot;
add switch=switch1 dst-address=10.0.1.2/32 dst-port=3306 ports=ether2,ether3 redirect-to-cpu=yes</pre>
</div></div><h2 id="L3HardwareOffloading-SwitchRules(ACL)vs.FasttrackHWOffloading">Switch Rules (ACL) vs. Fasttrack HW Offloading</h2><p>Some firewall rules may be implemented both via<span> </span><a class="external-link" href="https://help.mikrotik.com/docs/display/ROS/CRS3xx%2C+CRS5xx%2C+CCR2116%2C+CCR2216+switch+chip+features#CRS3xx,CRS5xx,CCR2116,CCR2216switchchipfeatures-SwitchRules(ACL)" rel="nofollow">switch rules (ACL)</a> and CPU<span> </span><a class="external-link" href="https://help.mikrotik.com/docs/display/ROS/Filter" rel="nofollow">Firewall Filter</a><span> </span>+ Fasttrack HW Offloading. Both options grant near-the-wire-speed performance. So the question is which one to use?</p><p>First,<span> </span><a class="external-link" href="https://help.mikrotik.com/docs/display/ROS/L3+Hardware+Offloading#L3HardwareOffloading-L3HWDeviceSupport" rel="nofollow">not all devices support Fasttrack HW Offloading</a>, and without HW offloading, Firewall Filter uses only software routing, which is dramatically slower than its hardware counterpart. Second, even if Fasttrack HW Offloading is an option, a rule of thumb is:</p><div role="region" aria-label="Info" class="confluence-information-macro  confluence-information-macro-information" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-info-filled confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p>Always use Switch Rules (ACL), if possible.</p></div></div><p>Switch rules share the hardware memory with Fastrack connections. However, hardware resources are allocated for each Fasttrack connection while a single ACL rule can match multiple connections. For example, if you have a guest WiFi network connected to sfp-sfpplus1 VLAN 10 and you don't want it to access your internal network, simply create an ACL rule:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface/ethernet/switch/rule
add switch=switch1 ports=sfp-sfpplus1 vlan-id=10 dst-address=10.0.0.0/8 new-dst-ports=&quot;&quot;</pre>
</div></div><p>The matched packets will be dropped on the hardware level. It is much better than letting<span> </span><em>all</em><span> </span>guest packets to the CPU for Firewall filtering.</p><p>Of course, ACL rules cannot match everything. For instance, ACL rules cannot filter connection states: accept established, drop others. That is where Fasttrack HW Offloading gets into action - redirect the packets to the CPU by default for firewall filtering, then offload the established Fasttrack connections. However, disabling<span> </span><span style="color:var(--ds-icon-success,#22a06b);"><code>l3-hw-offloading</code></span><span> </span>for the entire switch, port is not the only option.</p><div role="region" aria-label="Info" class="confluence-information-macro  confluence-information-macro-information" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-info-filled confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p>Define ACL rules with<span> </span><span style="color:var(--ds-icon-success,#22a06b);"><code><strong>redirect-to-cpu=yes</strong></code></span><span> </span>instead of setting<span> </span><span style="color:var(--ds-icon-success,#22a06b);"><code>l3-hw-offloading=no</code></span><span> </span>of the switch port for narrowing down the traffic that goes to the CPU.</p></div></div><h1 id="L3HardwareOffloading-ConfigurationExamples">Configuration Examples</h1><h2 id="L3HardwareOffloading-Inter-VLANRoutingwithUpstreamPortBehindFirewall/NAT">Inter-VLAN Routing with Upstream Port Behind Firewall/NAT</h2><p>This example demonstrates how to benefit from near-to-wire-speed inter-VLAN routing while keeping Firewall and NAT running on the upstream port. Moreover, Fasttrack connections to the upstream port get offloaded to hardware as well, boosting the traffic speed close to wire-level. Inter-VLAN traffic is fully routed by the hardware, not entering the CPU/Firewall, and, therefore, not occupying the hardware memory of Fasttrack connections.</p><p>We use the <strong>CRS317-1G-16S+</strong> model with the following setup:</p><ul><li>sfp1-sfp4 - bridged ports, VLAN ID 20, untagged</li><li>sfp5-sfp8 - bridged ports, VLAN ID 30, untagged</li><li>sfp16 - the upstream port</li><li>ether1 - management port</li></ul><p><br/></p><p>Setup interface lists for easy access:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>Interface Lists</b></div><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface list
add name=LAN
add name=WAN
add name=MGMT 

/interface list member
add interface=sfp-sfpplus1 list=LAN
add interface=sfp-sfpplus2 list=LAN
add interface=sfp-sfpplus3 list=LAN
add interface=sfp-sfpplus4 list=LAN
add interface=sfp-sfpplus5 list=LAN
add interface=sfp-sfpplus6 list=LAN
add interface=sfp-sfpplus7 list=LAN
add interface=sfp-sfpplus8 list=LAN
add interface=sfp-sfpplus16 list=WAN
add interface=ether1 list=MGMT </pre>
</div></div><div class="code panel pdl" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>Bridge Setup</b></div><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge
add name=bridge vlan-filtering=yes

/interface bridge port
add bridge=bridge interface=sfp-sfpplus1 pvid=20
add bridge=bridge interface=sfp-sfpplus2 pvid=20
add bridge=bridge interface=sfp-sfpplus3 pvid=20
add bridge=bridge interface=sfp-sfpplus4 pvid=20
add bridge=bridge interface=sfp-sfpplus5 pvid=30
add bridge=bridge interface=sfp-sfpplus6 pvid=30
add bridge=bridge interface=sfp-sfpplus7 pvid=30
add bridge=bridge interface=sfp-sfpplus8 pvid=30

/interface bridge vlan
add bridge=bridge tagged=bridge untagged=sfp-sfpplus1,sfp-sfpplus2,sfp-sfpplus3,sfp-sfpplus4 vlan-ids=20
add bridge=bridge tagged=bridge untagged=sfp-sfpplus5,sfp-sfpplus6,sfp-sfpplus7,sfp-sfpplus8 vlan-ids=30</pre>
</div></div><p>Routing requires dedicated VLAN interfaces. For standard L2 VLAN bridging (without inter-VLAN routing), the next step can be omitted.</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>VLAN Interface Setup for Routing</b></div><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface vlan
add interface=bridge name=vlan20 vlan-id=20
add interface=bridge name=vlan30 vlan-id=30

/ip address
add address=192.168.20.17/24 interface=vlan20 network=192.168.20.0
add address=192.168.30.17/24 interface=vlan30 network=192.168.30.0</pre>
</div></div><p class="auto-cursor-target">Configure management and upstream ports, a basic firewall, NAT, and enable hardware offloading of Fasttrack connections:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>Firewall Setup</b></div><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/ip address
add address=192.168.88.1/24 interface=ether1
add address=10.0.0.17/24 interface=sfp-sfpplus16

/ip route
add gateway=10.0.0.1

/ip firewall filter
add action=fasttrack-connection chain=forward connection-state=established,related hw-offload=yes
add action=accept chain=forward connection-state=established,related

/ip firewall nat
add action=masquerade chain=srcnat out-interface-list=WAN</pre>
</div></div><p class="auto-cursor-target">At this moment, all routing still is performed by the CPU. Enable hardware routing on the switch chip:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>Enable Layer 3 Hardware Offloading</b></div><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false"># Enable full hardware routing on LAN ports
:foreach i in=[/interface/list/member/find where list=LAN] do={ 
    /interface/ethernet/switch/port set [/interface/list/member/get $i interface] l3-hw-offloading=yes 
} 

# Disable full hardware routing on WAN or Management ports
:foreach i in=[/interface/list/member/find where list=WAN or list=MGMT] do={ 
    /interface/ethernet/switch/port set [/interface/list/member/get $i interface] l3-hw-offloading=no 
}

# Activate Layer 3 Hardware Offloading on the switch chip
/interface/ethernet/switch/set 0 l3-hw-offloading=yes</pre>
</div></div><p class="auto-cursor-target">Results:</p><ul><li class="auto-cursor-target">Within the same VLAN (e.g., sfp1-sfp4), traffic is forwarded by the hardware on Layer 2 <em>(L2HW)</em>.</li><li class="auto-cursor-target">Inter-VLAN traffic (e.g. sfp1-sfp5) is routed by the hardware on Layer 3 <em>(L3HW).</em></li><li class="auto-cursor-target">Traffic from/to the WAN port gets processed by the CPU/Firewall first. Then Fasttrack connections get offloaded to the hardware <em>(Hardware-Accelerated L4 Stateful Firewall). </em>NAT applies both on CPU- and HW-processed packets.</li><li class="auto-cursor-target">Traffic to the management port is protected by the Firewall.</li></ul><h1 id="L3HardwareOffloading-TypicalMisconfiguration">Typical Misconfiguration</h1><p>Below are typical user errors in configuring Layer 3 Hardware Offloading.</p><h2 id="L3HardwareOffloading-VLANinterfaceonaswitchportorbond">VLAN interface on a switch port or bond</h2><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface/vlan
add name=vlan10 vlan-id=10 interface=sfp-sfpplus1
add name=vlan20 vlan-id=20 interface=bond1</pre>
</div></div><p><span style="letter-spacing: 0.0px;">VLAN interface must be set on the bridge due to Layer 2 Dependency. Otherwise, L3HW will not work. The correct configuration is:</span></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface/bridge/port
add bridge=bridge1 interface=sfp-sfpplus1 frame-types=admit-only-vlan-tagged
add bridge=bridge1 interface=bond1 frame-types=admit-only-vlan-tagged
 
/interface/bridge/vlan
add bridge=bridge1 tagged=bridge1,sfp-sfpplus1 vlan-ids=10
add bridge=bridge1 tagged=bridge1,bond1 vlan-ids=20
 
/interface/vlan
add name=vlan10 vlan-id=10 interface=bridge1
add name=vlan20 vlan-id=20 interface=bridge1</pre>
</div></div><h2 id="L3HardwareOffloading-Notaddingthebridgeinterfaceto/interface/bridge/vlan/"><span style="font-size: 20.0px;letter-spacing: -0.008em;">Not adding the bridge interface to /interface/bridge/vlan/</span></h2><p>For Inter-VLAN routing, the bridge interface itself needs to be added to the tagged members of the given VLANs. In the next example, Inter-VLAN routing works between VLAN 10 and 11, but packets are NOT routed to VLAN 20. </p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface bridge vlan
add bridge=bridge1 vlan-ids=10 tagged=bridge1,sfp-sfpplus1
add bridge=bridge1 vlan-ids=11 tagged=bridge1 untagged=sfp-sfpplus2,sfp-sfpplus3 
add bridge=bridge1 vlan-ids=20 tagged=sfp-sfpplus1 untagged=sfp-sfpplus4,sfp-sfpplus5</pre>
</div></div><p><span style="letter-spacing: 0.0px;">The above example does not always mean an error. Sometimes, you may want the device to act as a simple L2 switch in some/all VLANs. Just make sure you set such behavior on purpose, not due to a mistake.</span></p><h2 id="L3HardwareOffloading-Creatingmultiplebridges">Creating multiple bridges</h2><p>The devices support only one hardware bridge. If there are multiple bridges created, only one gets hardware offloading. While for L2 that means software forwarding for other bridges, in the case of L3HW, multiple bridges may lead to undefined behavior.</p><div role="region" aria-label="Info" class="confluence-information-macro  confluence-information-macro-information" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-info-filled confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p>Instead of creating multiple bridges, create one and segregate L2 networks with VLAN filtering.</p></div></div><h2 id="L3HardwareOffloading-Usingportsthatdonotbelongtotheswitch">Using ports that do not belong to the switch</h2><p>Some devices have two switch chips or the management port directly connected to the CPU. For example,<span> </span><strong style="text-align: left;">CRS312-4C+8XG </strong>has<span> an </span><strong>ether9</strong><span> </span>port connected to a separate switch chip. Trying to add this port to a bridge or involve it in the L3HW setup leads to unexpected results. Leave the management port for management!</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">[admin@crs312] /interface/ethernet/switch&gt; print
Columns: NAME, TYPE, L3-HW-OFFLOADING
# NAME     TYPE              L3-HW-OFFLOADING
0 switch1  Marvell-98DX8212  yes            
1 switch2  Atheros-8227      no   
           
[admin@crs312] /interface/ethernet/switch&gt; port print
Columns: NAME, SWITCH, L3-HW-OFFLOADING, STORM-RATE
 # NAME         SWITCH   L3-HW-OFFLOADING  STORM-RATE
 0 ether9       switch2                             
 1 ether1       switch1  yes                      100
 2 ether2       switch1  yes                      100
 3 ether3       switch1  yes                      100
 4 ether4       switch1  yes                      100
 5 ether5       switch1  yes                      100
 6 ether6       switch1  yes                      100
 7 ether7       switch1  yes                      100
 8 ether8       switch1  yes                      100
 9 combo1       switch1  yes                      100
10 combo2       switch1  yes                      100
11 combo3       switch1  yes                      100
12 combo4       switch1  yes                      100
13 switch1-cpu  switch1                           100
14 switch2-cpu  switch2</pre>
</div></div><h2 id="L3HardwareOffloading-RelyingonFasttrackHWOffloadingtoomuch"><span style="font-size: 20.0px;letter-spacing: -0.008em;">Relying on Fasttrack HW Offloading too much</span></h2><p>Since Fasttrack HW Offloading offers near-the-wire-speed performance at zero configuration overhead, the users are tempted to use it as the default solution. However, the number of HW Fasttrack connections is very limited, leaving the other traffic for the CPU. Try using the hardware routing as much as possible, reduce the CPU traffic to the minimum via switch ACL rules, and then fine-tune which Fasttrack connections to offload with firewall filter rules.</p><h2 id="L3HardwareOffloading-Tryingtooffloadslow-pathconnections">Trying to offload slow-path connections</h2><p><span style="color:var(--ds-text,#333333);">Using certain configurations (e.g. enabling bridge &quot;<span style="color:var(--ds-icon-success,#22a06b);"><strong>use-ip-firewall</strong></span>&quot; setting, creating bridge nat/filter rules) or running specific features like sniffer or torch can disable RouterOS <a href="https://help.mikrotik.com/docs/display/ROS/Packet+Flow+in+RouterOS#PacketFlowinRouterOS-FastPath" rel="nofollow">FastPath</a>, which will affect the ability to properly FastTrack and HW offload connections. If HW offloaded Fasttrack is required, make sure that there are no settings that disable the FastPath and verify that connections are getting the &quot;H&quot; flag or use the L3HW <a href="https://help.mikrotik.com/docs/display/ROS/L3+Hardware+Offloading#L3HardwareOffloading-Monitor" rel="nofollow">monitor</a> command to see the amount of HW offloaded connections.</span></p><h1 class="auto-cursor-target" id="L3HardwareOffloading-L3HWFeatureSupport">L3HW Feature Support</h1><ul><li><span style="color:var(--ds-icon-success,#22a06b);"><strong>HW</strong></span><span> </span>- the feature is supported and offloaded to the hardware.</li><li><span style="color:var(--ds-background-warning-bold-pressed,#cf9f02);"><strong>CPU</strong></span><span> </span>- the feature is supported but performed by software (CPU)</li><li><span style="color:var(--ds-background-accent-red-bolder,#c9372c);"><strong>N/A</strong></span><span> </span>- the feature is not available together with L3HW. Layer 3 hardware offloading must be completely disabled (<strong>switch</strong> <span style="color:var(--ds-background-accent-red-bolder,#c9372c);"><code>l3-hw-offloading=no</code></span>) to make this feature work.</li><li><span style="color:var(--ds-icon-accent-blue,#1d7afc);"><strong>FW</strong></span><span> </span>- the feature requires<span> <span style="color:var(--ds-background-accent-red-bolder,#c9372c);"><code>l3-hw-offloading</code></span></span><span style="color:var(--ds-background-accent-red-bolder,#c9372c);"><code>=no</code></span> for a given <strong>switch port</strong>. On the <strong>switch </strong>level, <span><code><span style="color:var(--ds-text-accent-green-bolder,#164b35);">l3-hw-offloading=yes</span></code>.</span></li></ul><p><br/></p><div class="table-wrap"><table class="relative-table wrapped confluenceTable" style="width: 91.9452%;"><colgroup><col style="width: 12.6417%;"/><col style="width: 7.21533%;"/><col style="width: 66.3691%;"/><col style="width: 13.7747%;"/></colgroup><tbody><tr><th style="text-align: center;" class="confluenceTh">Feature</th><th style="text-align: center;" class="confluenceTh">Support</th><th style="text-align: center;" class="confluenceTh">Comments</th><th class="confluenceTh">Release</th></tr><tr><td class="confluenceTd">IPv4 Unicast Routing</td><td class="confluenceTd"><span style="color:var(--ds-icon-success,#22a06b);"><strong title="">HW</strong></span></td><td class="confluenceTd"><br/></td><td class="confluenceTd"><span style="color:var(--ds-text,#172b4d);">7.1</span></td></tr><tr><td class="confluenceTd">IPv6 Unicast Routing</td><td class="confluenceTd"><span style="color:var(--ds-icon-success,#22a06b);"><strong>HW</strong></span></td><td class="confluenceTd"><pre class="code-java">/interface/ethernet/switch/l3hw-settings/set ipv6-hw=yes</pre></td><td class="confluenceTd">7.6</td></tr><tr><td class="confluenceTd">IPv4 Multicast Routing</td><td class="confluenceTd"><span style="color:var(--ds-background-warning-bold-pressed,#cf9f02);"><strong>CPU</strong></span></td><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">IPv6 Multicast Routing</td><td class="confluenceTd"><span style="color:var(--ds-background-warning-bold-pressed,#cf9f02);"><strong>CPU</strong></span></td><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">ECMP</td><td class="confluenceTd"><span style="color:var(--ds-icon-success,#22a06b);"><strong>HW</strong></span></td><td class="confluenceTd">Multipath routing</td><td class="confluenceTd"><span style="color:var(--ds-text,#172b4d);">7.1</span></td></tr><tr><td class="confluenceTd">Blackholes</td><td class="confluenceTd"><span style="color:var(--ds-icon-success,#22a06b);"><strong>HW</strong></span></td><td class="confluenceTd"><pre class="code-java">/ip/route add dst-address=10.0.99.0/24 blackhole</pre></td><td class="confluenceTd"><span style="color:var(--ds-text,#172b4d);">7.1</span></td></tr><tr><td class="confluenceTd">gateway=&lt;interface_name&gt;</td><td class="confluenceTd"><span style="color:var(--ds-icon-success,#22a06b);"><strong>CPU/HW</strong></span></td><td class="confluenceTd"><pre class="code-java">/ip/route add dst-address=10.0.0.0/24 gateway=ether1 </pre><p>This works only for directly connected networks. Since HW does not know how to send ARP requests,<br/>CPU sends an ARP request and waits for a reply to find out the DST MAC address on the first received packet of the connection that matches a DST IP address.<br/>After DST MAC is determined, HW entry is added and all further packets will be processed by the switch chip.</p></td><td class="confluenceTd">7.1</td></tr><tr><td class="confluenceTd">Bridge</td><td class="confluenceTd"><span style="color:var(--ds-icon-success,#22a06b);"><strong>HW</strong></span></td><td class="confluenceTd">Routing from/to <a href="https://help.mikrotik.com/docs/display/ROS/Bridging+and+Switching#BridgingandSwitching-BridgeHardwareOffloading" rel="nofollow">hardware-offloaded bridge</a> interface.</td><td class="confluenceTd"><span style="color:var(--ds-text,#172b4d);">7.1</span></td></tr><tr><td class="confluenceTd">VLAN</td><td class="confluenceTd"><span style="color:var(--ds-icon-success,#22a06b);"><strong>HW</strong></span></td><td class="confluenceTd"><p>Routing between VLAN interfaces that are created on hardware-offloaded bridge interface with <a href="https://help.mikrotik.com/docs/display/ROS/Bridging+and+Switching#BridgingandSwitching-BridgeVLANFiltering" rel="nofollow">vlan-filtering</a>.</p><pre>/interface/vlan</pre></td><td class="confluenceTd"><span style="color:var(--ds-text,#172b4d);">7.1</span></td></tr><tr><td class="confluenceTd">Bonding</td><td class="confluenceTd"><span style="color:var(--ds-icon-success,#22a06b);"><strong>HW</strong></span></td><td class="confluenceTd"><p class="code-java">Routing between bonding interfaces.</p><pre class="code-java">/interface/bonding</pre><p> <span style="color:var(--ds-text,#172b4d);">Only</span><span style="color:var(--ds-text,#172b4d);"> </span><span style="color:var(--ds-background-accent-green-bolder,#1f845a);"><code style="text-align: left;">802.3ad</code></span><span style="color:var(--ds-text,#172b4d);"> </span><span style="color:var(--ds-text,#172b4d);">and</span><span style="color:var(--ds-text,#172b4d);"> </span><span style="color:var(--ds-background-accent-green-bolder,#1f845a);"><code>balance-xor</code></span> <span style="color:var(--ds-text,#172b4d);">bonding modes are hardware offloaded.</span></p></td><td class="confluenceTd"><span style="color:var(--ds-text,#172b4d);">7.1</span></td></tr><tr><td class="confluenceTd">IPv4 Firewall</td><td class="confluenceTd"><span style="color:var(--ds-icon-accent-blue,#1d7afc);"><strong>FW</strong></span></td><td class="confluenceTd">Users must choose either HW-accelerated routing or firewall.<br/>Firewall rules get processed by the CPU. <em><strong>Fasttrack</strong></em><span> </span>connections get offloaded to HW.</td><td class="confluenceTd"><span style="color:var(--ds-text,#172b4d);">7.1</span></td></tr><tr><td class="confluenceTd">IPv4 NAT</td><td class="confluenceTd"><span style="color:var(--ds-icon-accent-blue,#1d7afc);"><strong>FW</strong></span></td><td class="confluenceTd">NAT rules applied to the offloaded<span> </span><em><strong>Fasttrack</strong></em><span> </span>connections get processed by HW too.</td><td class="confluenceTd"><span style="color:var(--ds-text,#172b4d);">7.1</span></td></tr><tr><td class="confluenceTd">MLAG</td><td class="confluenceTd"><span style="color:var(--ds-icon-accent-blue,#1d7afc);"><strong><span style="color:var(--ds-background-accent-red-bolder,#c9372c);">N/A</span></strong></span></td><td class="confluenceTd"><br/></td><td class="confluenceTd"><span style="color:var(--ds-text,#172b4d);"> </span></td></tr><tr><td class="confluenceTd">VRF</td><td class="confluenceTd"><span style="color:var(--ds-background-accent-red-bolder,#c9372c);"><strong>N/A</strong></span></td><td class="confluenceTd">Only the <strong>main</strong> routing table gets offloaded. If VRF is used together with L3HW and packets arrive on a switch port with <span style="color:var(--ds-icon-success,#22a06b);"><code>l3-hw-offloadin</code></span><span style="color:var(--ds-icon-success,#22a06b);"><code>g=yes</code></span>, packets can be incorrectly routed through the main routing table. To avoid this, disable L3HW on needed switch ports or use ACL rules to redirect specific traffic to the CPU.</td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">VRRP</td><td class="confluenceTd"><span style="color:var(--ds-background-accent-red-bolder,#c9372c);"><strong>N/A</strong></span></td><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">Controller Bridge and Port Extender</td><td class="confluenceTd"><span style="color:var(--ds-background-accent-red-bolder,#c9372c);"><strong><span style="color:var(--ds-background-accent-red-bolder,#c9372c);">N/A</span></strong></span></td><td class="confluenceTd"><br/></td><td class="confluenceTd"><br/></td></tr><tr><td class="confluenceTd">VXLAN</td><td class="confluenceTd"><span style="color:var(--ds-icon-success,#22a06b);"><strong>HW</strong></span></td><td class="confluenceTd"><p>Support for hardware-offloaded <a href="https://help.mikrotik.com/docs/spaces/ROS/pages/100007937/VXLAN" rel="nofollow">VXLAN</a> data plane, VXLAN encapsulation and decapsulation. This allows for static one-to-one VLAN-to-VXLAN mappings within a vlan-filtering bridge.<br/><br/>At this point, some known features are not yet implemented.</p><p><strong>Underlay (routing encapsulated VXLAN packets):</strong></p><p>1. VTEPs are not supported over ECMP</p><p>2. VTEPs are not supported over bond, VLAN interface</p><p style="text-align: left;">3. VTEPs are not supported over multicast</p><p>4. VTEPs cannot operate within VRFs</p><p>5. VTEPs are not supported with IPv6</p><p><strong>Overlay (forwarding between Ethernet and VXLAN):</strong></p><p>1. VLAN tagging over VXLAN is not supported</p><p>2. Routing between different VXLAN VNIs is not supported</p><p>3. VTEPs are isolated, and there is no mechanism to control &quot;horizon&quot; between them.</p><p style="text-align: left;">4. Bridged VXLAN interfaces do not support IGMP snooping. When snooping is enabled, MDB entries on VXLAN are not offloaded, and multicast traffic gets restricted between Ethernet and VXLAN.</p><p style="text-align: left;">5. Bridged VXLAN interfaces are not supported by MLAG.  </p><pre>/interface/vxlan</pre></td><td class="confluenceTd">7.18</td></tr><tr><td class="confluenceTd">MTU</td><td class="confluenceTd"><span style="color:var(--ds-icon-success,#22a06b);"><strong>HW</strong></span></td><td class="confluenceTd">The hardware supports up to 8 MTU profiles.</td><td class="confluenceTd"><span style="color:var(--ds-text,#172b4d);">7.1</span></td></tr><tr><td class="confluenceTd">QinQ Routing</td><td class="confluenceTd"><span style="color:var(--ds-background-warning-bold-pressed,#cf9f02);"><strong>CPU</strong></span></td><td class="confluenceTd">Stacked routable VLAN interfaces will lose L3HW offloading, while routable VLAN interfaces created directly on the bridge interface can still use HW offloading.</td><td class="confluenceTd"><span style="color:var(--ds-text,#172b4d);"> </span></td></tr></tbody></table></div><p>Only the devices listed in the table below support L3 HW Offloading.</p><h1 id="L3HardwareOffloading-L3HWDeviceSupport">L3HW Device Support</h1><p>Only the devices listed in the table below support L3 HW Offloading.</p><h2 id="L3HardwareOffloading-CRS3xx:SwitchDX3000andDX2000Series">CRS3xx: Switch DX3000 and DX2000 Series</h2><p>The devices below are based on <strong>Marvell <strong style="text-align: left;">98DX224S, 98DX226S</strong></strong>, or <strong><strong style="text-align: left;">98DX3236</strong></strong> switch chip models.</p><p>Below are some important features that these devices are missing when compared to other switch models:</p><ul><li>Fasttrack and NAT connection offloading;</li><li>per-VLAN packet and byte counters.</li></ul><div role="region" aria-label="Info" class="confluence-information-macro  confluence-information-macro-information" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-info-filled confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p><span>The <strong>98DX3255 </strong>and </span><strong>98DX3257<span> </span></strong><span>models are exceptions, which have a feature set of the DX8000 rather than the DX3000 series.</span></p></div></div><div class="table-wrap"><table class="wrapped confluenceTable"><colgroup><col/><col/><col/><col/><col/><col/><col/></colgroup><tbody><tr><th style="text-align: center;" class="confluenceTh">Model</th><th style="text-align: center;" class="confluenceTh">Switch Chip</th><th style="text-align: center;" class="confluenceTh">Release</th><th style="text-align: center;" class="confluenceTh">IPv4 Route Prefixes<sup>1</sup></th><th style="text-align: center;" class="confluenceTh">IPv6 Route Prefixes<sup>2</sup></th><th style="text-align: center;" class="confluenceTh">Nexthops</th><th class="confluenceTh">ECMP paths per prefix<sup>3</sup></th></tr><tr><td class="confluenceTd"><strong><span style="color:var(--ds-text,#172b4d);">CRS305-1G-4S+</span></strong></td><td class="confluenceTd"><strong><span style="color:var(--ds-text,#172b4d);"><strong style="text-align: left;">98DX3236</strong></span></strong></td><td class="highlight-#abf5d1 confluenceTd" data-highlight-colour="#abf5d1">7.1</td><td class="confluenceTd">13312</td><td class="confluenceTd"><span style="color:var(--ds-text,#172b4d);">3328</span></td><td class="confluenceTd">4K</td><td class="confluenceTd">8</td></tr><tr><td class="confluenceTd"><strong><span style="color:var(--ds-text,#172b4d);">CRS310-1G-5S-4S+</span></strong></td><td class="confluenceTd"><strong><span style="color:var(--ds-text,#172b4d);"><strong style="text-align: left;">98DX226S</strong></span></strong></td><td class="highlight-#abf5d1 confluenceTd" data-highlight-colour="#abf5d1">7.1</td><td class="confluenceTd">13312</td><td class="confluenceTd"><span style="color:var(--ds-text,#172b4d);">3328</span></td><td class="confluenceTd">4K</td><td class="confluenceTd">8</td></tr><tr><td style="text-align: left;vertical-align: top;" class="confluenceTd"><strong>CRS310-8G+2S+</strong></td><td class="confluenceTd"><strong><span style="color:var(--ds-text,#172b4d);"><strong style="text-align: left;"><span style="color:var(--ds-text,#172b4d);">98DX226S</span></strong></span></strong></td><td class="highlight-#abf5d1 confluenceTd" data-highlight-colour="#abf5d1">7.1</td><td class="confluenceTd">13312</td><td class="confluenceTd"><span style="color:var(--ds-text,#172b4d);"><span style="color:var(--ds-text,#172b4d);">3328</span></span></td><td class="confluenceTd">4K</td><td class="confluenceTd">8</td></tr><tr><td class="confluenceTd"><strong><span style="color:var(--ds-text,#172b4d);">CRS318-1Fi-15Fr-2S</span></strong></td><td class="confluenceTd"><strong><span style="color:var(--ds-text,#172b4d);"><strong style="text-align: left;">98DX224S</strong></span></strong></td><td class="highlight-#abf5d1 confluenceTd" data-highlight-colour="#abf5d1">7.1</td><td class="confluenceTd">13312</td><td class="confluenceTd"><span style="color:var(--ds-text,#172b4d);">3328</span></td><td class="confluenceTd">4K</td><td class="confluenceTd">8</td></tr><tr><td class="confluenceTd"><strong><span style="color:var(--ds-text,#172b4d);">CRS318-16P-2S+</span></strong></td><td class="confluenceTd"><strong><span style="color:var(--ds-text,#172b4d);"><strong style="text-align: left;">98DX226S</strong></span></strong></td><td class="highlight-#abf5d1 confluenceTd" data-highlight-colour="#abf5d1">7.1</td><td class="confluenceTd">13312</td><td class="confluenceTd"><span style="color:var(--ds-text,#172b4d);">3328</span></td><td class="confluenceTd">4K</td><td class="confluenceTd">8</td></tr><tr><td class="confluenceTd"><strong><span style="color:var(--ds-text,#172b4d);">CRS320-8P-8B-4S+RM</span></strong></td><td class="confluenceTd"><strong><span style="color:var(--ds-text,#172b4d);"><strong style="text-align: left;"><span style="color:var(--ds-text,#172b4d);">98DX226S</span></strong></span></strong></td><td class="highlight-#abf5d1 confluenceTd" data-highlight-colour="#abf5d1">7.1</td><td class="confluenceTd">13312</td><td class="confluenceTd"><span style="color:var(--ds-text,#172b4d);"><span style="color:var(--ds-text,#172b4d);">3328</span></span></td><td class="confluenceTd">4K</td><td class="confluenceTd">8</td></tr><tr><td class="confluenceTd"><strong><span style="color:var(--ds-text,#333333);">CRS326-24G-2S+</span></strong></td><td class="confluenceTd"><strong><span style="color:var(--ds-text,#333333);"><span style="color:var(--ds-text,#172b4d);"><strong style="text-align: left;">98DX3236</strong></span></span></strong></td><td class="highlight-#abf5d1 confluenceTd" data-highlight-colour="#abf5d1">7.1</td><td class="confluenceTd">13312</td><td class="confluenceTd"><span style="color:var(--ds-text,#172b4d);">3328</span></td><td class="confluenceTd">4K</td><td class="confluenceTd">8</td></tr><tr><td class="confluenceTd"><strong><span style="color:var(--ds-text,#333333);">CRS304-4XG-IN</span></strong></td><td class="confluenceTd"><strong><span style="color:var(--ds-text,#333333);"><span style="color:var(--ds-text,#172b4d);"><strong style="text-align: left;">98DX2528</strong></span></span></strong></td><td class="highlight-#abf5d1 confluenceTd" data-highlight-colour="#abf5d1">7.1</td><td class="confluenceTd">13312</td><td class="confluenceTd"><span style="color:var(--ds-text,#172b4d);">3328</span></td><td class="confluenceTd">4K</td><td class="confluenceTd">8</td></tr><tr><td class="confluenceTd"><strong><span style="color:var(--ds-text,#333333);">CRS328-24P-4S+</span></strong></td><td class="confluenceTd"><strong><span style="color:var(--ds-text,#333333);"><span style="color:var(--ds-text,#172b4d);"><strong style="text-align: left;">98DX3236</strong></span></span></strong></td><td class="highlight-#abf5d1 confluenceTd" data-highlight-colour="#abf5d1">7.1</td><td class="confluenceTd">13312</td><td class="confluenceTd"><span style="color:var(--ds-text,#172b4d);">3328</span></td><td class="confluenceTd">4K</td><td class="confluenceTd">8</td></tr><tr><td class="confluenceTd"><strong><span style="color:var(--ds-text,#333333);">CRS328-4C-20S-4S+</span></strong></td><td class="confluenceTd"><strong><span style="color:var(--ds-text,#333333);"><span style="color:var(--ds-text,#172b4d);"><strong style="text-align: left;">98DX3236</strong></span></span></strong></td><td class="highlight-#abf5d1 confluenceTd" data-highlight-colour="#abf5d1">7.1</td><td class="confluenceTd">13312</td><td class="confluenceTd"><span style="color:var(--ds-text,#172b4d);">3328</span></td><td class="confluenceTd">4K</td><td class="confluenceTd">8</td></tr></tbody></table></div><p><em><sup>1</sup> Since the total amount of routes that can be offloaded is limited, prefixes with higher netmask are preferred to be forwarded by hardware (e.g., /32, /30, /29, etc.), any other prefixes that do not fit in the HW table will be processed by the CPU. Directly connected hosts are offloaded as /32 (IPv4) or /128 (IPv6) route prefixes. The number of hosts is also limited by max-neighbor-entries in <a href="https://help.mikrotik.com/docs/display/ROS/IP+Settings#IPSettings-IPv4Settings" rel="nofollow">IP Settings</a> / <a href="https://help.mikrotik.com/docs/display/ROS/IP+Settings#IPSettings-IPv6Settings" rel="nofollow">IPv6 Settings</a>.</em></p><p><em><sup>2</sup><span> </span>IPv4 and IPv6 routing tables share the same hardware memory.</em></p><p><em><sup>3</sup> If a route has more paths than the hardware ECMP limit (X), only the first X paths get offloaded.</em></p><h3 id="L3HardwareOffloading-Partialoffloading">Partial offloading</h3><p><span style="color:var(--ds-text,#333333);">In the case of<span> </span></span><strong>DX3000/DX2000</strong><span style="color:var(--ds-text,#333333);"><span> </span>switch chip serries, it is quite simple: one RouterOS route entry (/ip/route/) reflects into one HW IPv4 route prefix entry. Connected hosts (/32 routes) also occupy the same table. As long as the total number of routes (&quot;ip/route print count-only&quot;) + connected host count (&quot;/ip/arp print count-only where status=reachable or status=stale&quot;) ,<span> </span></span><strong>13312 (13k)</strong><span style="color:var(--ds-text,#333333);">, everything gets offloaded. Exceeding the number, routes with<span> </span></span><em>shorter</em><span style="color:var(--ds-text,#333333);"><span> </span>prefixes stay on the CPU.</span></p><h2 id="L3HardwareOffloading-CCR2xxx,CRS3xx,CRS5xx:SwitchDX8000andDX4000Series">CCR2xxx, CRS3xx, CRS5xx: Switch DX8000 and DX4000 Series</h2><p>The devices below are based on <strong>Marvell 98DX8xxx</strong>, <strong>98DX4xxx</strong> switch chips, or <strong style="text-align: left;"><span class="v1diff-html-added">98DX325x</span></strong> model.</p><div class="table-wrap"><table class="wrapped confluenceTable"><colgroup><col/><col/><col/><col/><col/><col/><col/><col/><col/><col/><col/></colgroup><tbody><tr><th style="text-align: center;" class="confluenceTh">Model</th><th style="text-align: center;" class="confluenceTh">Switch Chip</th><th style="text-align: center;" class="confluenceTh">Release</th><th style="text-align: center;" class="confluenceTh">IPv4 Routes<span> </span><sup>1</sup></th><th style="text-align: center;" class="confluenceTh">IPv4 Hosts <sup>7</sup></th><th style="text-align: center;" class="confluenceTh">IPv6 Routes<sup>8</sup></th><th style="text-align: center;" class="confluenceTh">IPv6 Hosts<sup>7</sup></th><th style="text-align: center;" class="confluenceTh">Nexthops</th><th style="text-align: center;" class="confluenceTh"><strong>Fasttrack</strong> <strong>connections <sup>2,3,4</sup></strong></th><th style="text-align: center;" class="confluenceTh">NAT entries <sup>2,5</sup> </th><th style="text-align: center;" class="confluenceTh">VXLAN</th></tr><tr><td class="confluenceTd"><strong>CRS309-1G-8S+</strong></td><td class="confluenceTd"><strong><strong style="text-align: left;">98DX8208</strong></strong></td><td class="highlight-#abf5d1 confluenceTd" data-highlight-colour="#abf5d1">7.1</td><td class="confluenceTd">16K - 36K</td><td class="confluenceTd">16K</td><td style="text-align: left;" class="confluenceTd">4K - 6K</td><td class="confluenceTd"><span style="color:var(--ds-text,#172b4d);">8K</span></td><td class="confluenceTd">8K</td><td class="confluenceTd">4.5K</td><td class="confluenceTd">3.9K</td><td style="text-align: center;" class="confluenceTd">+</td></tr><tr><td class="confluenceTd"><strong>CRS312-4C+8XG</strong></td><td class="confluenceTd"><strong><strong style="text-align: left;">98DX8212</strong></strong></td><td class="highlight-#abf5d1 confluenceTd" data-highlight-colour="#abf5d1">7.1</td><td class="confluenceTd">16K - 36K</td><td class="confluenceTd">16K</td><td style="text-align: left;" class="confluenceTd">4K - 6K</td><td class="confluenceTd"><span style="color:var(--ds-text,#172b4d);">8K</span></td><td class="confluenceTd">8K</td><td class="confluenceTd">2.25K</td><td class="confluenceTd">2.25K</td><td style="text-align: center;" class="confluenceTd">+</td></tr><tr><td class="confluenceTd"><strong>CRS317-1G-16S+</strong></td><td class="confluenceTd"><strong><strong style="text-align: left;">98DX8216</strong></strong></td><td class="highlight-#abf5d1 confluenceTd" data-highlight-colour="#abf5d1">7.1</td><td class="confluenceTd">120K - 240K</td><td class="confluenceTd">64K</td><td style="text-align: left;" class="confluenceTd"><span style="color:var(--ds-text,#172b4d);">30K - 40K</span></td><td class="confluenceTd"><span style="color:var(--ds-text,#172b4d);">32K</span></td><td class="confluenceTd">8K</td><td class="confluenceTd">4.5K</td><td class="confluenceTd">4K</td><td style="text-align: center;" class="confluenceTd">+</td></tr><tr><td class="confluenceTd"><strong>CRS326-24S+2Q+</strong></td><td class="confluenceTd"><strong><strong style="text-align: left;">98DX8332</strong></strong></td><td class="highlight-#abf5d1 confluenceTd" data-highlight-colour="#abf5d1">7.1</td><td class="confluenceTd">16K - 36K</td><td class="confluenceTd">16K</td><td style="text-align: left;" class="confluenceTd">4K - 6K</td><td class="confluenceTd"><span style="color:var(--ds-text,#172b4d);">8K</span></td><td class="confluenceTd">8K</td><td class="confluenceTd">2.25K</td><td class="confluenceTd">2.25K</td><td style="text-align: center;" class="confluenceTd">+</td></tr><tr><td class="confluenceTd"><strong>CRS326-4C+20G+2Q+</strong></td><td class="confluenceTd"><strong><strong style="text-align: left;">98DX8332</strong></strong></td><td class="highlight-#abf5d1 confluenceTd" data-highlight-colour="#abf5d1">7.1</td><td class="confluenceTd">16K - 36K</td><td class="confluenceTd">16K</td><td style="text-align: left;" class="confluenceTd">4K - 6K</td><td class="confluenceTd"><span style="color:var(--ds-text,#172b4d);">8K</span></td><td class="confluenceTd">8K</td><td class="confluenceTd">2.25K</td><td class="confluenceTd">2.25K</td><td style="text-align: center;" class="confluenceTd">+</td></tr><tr><td class="confluenceTd"><strong>CRS354-48G-4S+2Q+, CRS354-48P-4S+2Q+</strong></td><td class="confluenceTd"><strong><strong style="text-align: left;">98DX3257 <sup>6</sup></strong></strong></td><td class="highlight-#abf5d1 confluenceTd" data-highlight-colour="#abf5d1">7.1</td><td class="confluenceTd">16K - 36K</td><td class="confluenceTd">16K</td><td style="text-align: left;" class="confluenceTd">4K - 6K</td><td class="confluenceTd"><span style="color:var(--ds-text,#172b4d);">8K</span></td><td class="confluenceTd">8K</td><td class="confluenceTd">2.25K</td><td class="confluenceTd">2.25K</td><td style="text-align: center;" class="confluenceTd">+</td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>CRS504-4XQ</strong></td><td style="text-align: left;" class="confluenceTd"><strong><strong style="text-align: left;">98DX4310</strong></strong></td><td class="highlight-#abf5d1 confluenceTd" style="text-align: left;" data-highlight-colour="#abf5d1">7.1</td><td style="text-align: left;" class="confluenceTd">60K - 120K</td><td style="text-align: left;" class="confluenceTd">64K</td><td style="text-align: left;" class="confluenceTd"><span style="color:var(--ds-text,#172b4d);">15K - 20K</span></td><td style="text-align: left;" class="confluenceTd"><span style="color:var(--ds-text,#172b4d);">32K</span></td><td style="text-align: left;" class="confluenceTd">8K</td><td style="text-align: left;" class="confluenceTd">4.5K</td><td style="text-align: left;" class="confluenceTd">4K</td><td style="text-align: center;" class="confluenceTd">+</td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>CRS510-8XS-2XQ</strong></td><td style="text-align: left;" class="confluenceTd"><strong><span style="color:var(--ds-text,#172b4d);">98DX4310</span></strong></td><td class="highlight-#abf5d1 confluenceTd" style="text-align: left;" title="Background color : Light green 100%" data-highlight-colour="#abf5d1">7.3</td><td style="text-align: left;" class="confluenceTd">60K - 120K</td><td style="text-align: left;" class="confluenceTd">64K</td><td style="text-align: left;" class="confluenceTd">15K - 20K</td><td style="text-align: left;" class="confluenceTd">32K</td><td style="text-align: left;" class="confluenceTd">8K</td><td style="text-align: left;" class="confluenceTd">4.5K</td><td style="text-align: left;" class="confluenceTd">4K</td><td style="text-align: center;" class="confluenceTd">+</td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>CRS518-16XS-2XQ</strong></td><td style="text-align: left;" class="confluenceTd"><strong><span style="color:var(--ds-text,#172b4d);">98DX8525</span></strong></td><td class="highlight-#abf5d1 confluenceTd" style="text-align: left;" data-highlight-colour="#abf5d1">7.3</td><td style="text-align: left;" class="confluenceTd">60K - 120K</td><td style="text-align: left;" class="confluenceTd">64K</td><td style="text-align: left;" class="confluenceTd"><span style="color:var(--ds-text,#172b4d);">15K - 20K</span></td><td style="text-align: left;" class="confluenceTd"><span style="color:var(--ds-text,#172b4d);">32K</span></td><td style="text-align: left;" class="confluenceTd">8K</td><td style="text-align: left;" class="confluenceTd">4.5K</td><td style="text-align: left;" class="confluenceTd">4K</td><td style="text-align: center;" class="confluenceTd">+</td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>CRS520-4XS-16XQ-RM</strong></td><td style="text-align: left;" class="confluenceTd"><strong><span style="color:var(--ds-text,#172b4d);">98CX8410</span></strong></td><td class="highlight-#abf5d1 confluenceTd" style="text-align: left;" data-highlight-colour="#abf5d1">7.3</td><td style="text-align: left;" class="confluenceTd">120K - 240K</td><td style="text-align: left;" class="confluenceTd">64K</td><td style="text-align: left;" class="confluenceTd"><span style="color:var(--ds-text,#172b4d);"><span style="color:var(--ds-text,#172b4d);">30K - 40K</span></span></td><td style="text-align: left;" class="confluenceTd"><span style="color:var(--ds-text,#172b4d);">32K</span></td><td style="text-align: left;" class="confluenceTd">8K</td><td style="text-align: left;" class="confluenceTd">4.5K</td><td style="text-align: left;" class="confluenceTd">4K</td><td style="text-align: center;" class="confluenceTd">+</td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>CCR2116-12G-4S+</strong></td><td style="text-align: left;" class="confluenceTd"><strong><span style="color:var(--ds-text,#172b4d);"><span>98DX3255<strong style="text-align: left;"><sup>6</sup></strong></span></span></strong></td><td class="highlight-#abf5d1 confluenceTd" style="text-align: left;" data-highlight-colour="#abf5d1">7.1</td><td style="text-align: left;" class="confluenceTd">16K - 36K</td><td style="text-align: left;" class="confluenceTd">16K</td><td style="text-align: left;" class="confluenceTd"><span style="color:var(--ds-text,#172b4d);"><span style="color:var(--ds-text,#172b4d);">4K - 6K</span></span></td><td style="text-align: left;" class="confluenceTd"><span style="color:var(--ds-text,#172b4d);">8K</span></td><td style="text-align: left;" class="confluenceTd">8K</td><td style="text-align: left;" class="confluenceTd">2.25K</td><td style="text-align: left;" class="confluenceTd">2.25K</td><td style="text-align: center;" class="confluenceTd">+</td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>CCR2216-1G-12XS-2XQ</strong></td><td style="text-align: left;" class="confluenceTd"><strong><span style="color:var(--ds-text,#172b4d);">98DX8525</span></strong></td><td class="highlight-#abf5d1 confluenceTd" style="text-align: left;" data-highlight-colour="#abf5d1">7.1</td><td style="text-align: left;" class="confluenceTd">60K - 120K</td><td style="text-align: left;" class="confluenceTd">64K</td><td style="text-align: left;" class="confluenceTd">15K - 20K</td><td style="text-align: left;" class="confluenceTd"><span style="color:var(--ds-text,#172b4d);">32K</span></td><td style="text-align: left;" class="confluenceTd">8k</td><td style="text-align: left;" class="confluenceTd">4.5K</td><td style="text-align: left;" class="confluenceTd">4K</td><td style="text-align: center;" class="confluenceTd">+</td></tr><tr><td style="text-align: left;" class="confluenceTd"><strong>RDS2216-2XG-4S+4XS-2XQ</strong></td><td style="text-align: left;" class="confluenceTd"><strong>98DX4310</strong></td><td class="highlight-#abf5d1 confluenceTd" style="text-align: left;" data-highlight-colour="#abf5d1">7.17</td><td style="text-align: left;" class="confluenceTd">60K - 120K</td><td style="text-align: left;" class="confluenceTd">64K</td><td style="text-align: left;" class="confluenceTd"><span style="color:var(--ds-text,#172b4d);">15K - 20K</span></td><td style="text-align: left;" class="confluenceTd"><span style="color:var(--ds-text,#172b4d);">32K</span></td><td style="text-align: left;" class="confluenceTd">8K</td><td style="text-align: left;" class="confluenceTd">4.5K</td><td style="text-align: left;" class="confluenceTd">4K</td><td style="text-align: center;" class="confluenceTd">+</td></tr></tbody></table></div><p><em><sup>1</sup><span> </span>Depends on the complexity of the routing table. Whole-byte IP prefixes (/8, /16, /24, etc.) occupy less HW space than others (e.g., /22). Starting with<span> </span><strong>RouterOS v7.3</strong>, when the Routing HW table gets full, only routes with longer subnet prefixes are offloaded (/30, /29, /28, etc.) while the CPU processes the shorter prefixes. In RouterOS v7.2 and before, Routing HW memory overflow led to undefined behavior. Users can fine-tune what routes to offload via routing filters (for dynamic routes) or suppressing hardware offload of static routes. IPv4 and IPv6 routing tables share the same hardware memory.</em></p><p><em><sup>2</sup><span> </span>When the HW limit of Fasttrack or NAT entries is reached, other connections will fall back to the CPU. MikroTik's smart connection offload algorithm ensures that the connections with the most traffic are offloaded to the hardware.</em></p><p><em><sup>3</sup><span> </span>Fasttrack connections share the same HW memory with ACL rules. Depending on the complexity, one ACL rule may occupy the memory of 3-6 Fasttrack connections.</em></p><p><em><sup>4</sup><span> </span></em><em>MPLS shares the HW memory with Fasttrack connections. Moreover, enabling MPLS requires the allocation of the entire memory region, which could otherwise store up to 768 (0.75K) Fasttrack connections. The same applies to the Bridge Port Extender. However, MPLS and BPE may use the same memory region, so enabling them both doesn't double the limitation of Fasttrack connections.</em></p><p><em><sup>5</sup><span> </span>If a Fasttrack connection requires Network Address Translation, a hardware NAT entry is created. The hardware supports both SRCNAT and DSTNAT.</em></p><p><em><sup>6</sup> The switch chip has a feature set of the DX8000 series.</em></p><p><em><sup>7</sup><span> </span>DX4000/DX8000 switch chips store directly connected hosts, IPv4 /32, and IPv6 /128 route entries in the FDB table rather than the routing table. The HW memory is shared between regular FDB L2 entries (MAC), IPv4, and IPv6 addresses. The number of hosts is also limited by max-neighbor-entries in <a href="https://help.mikrotik.com/docs/display/ROS/IP+Settings#IPSettings-IPv4Settings" rel="nofollow">IP Settings</a> / <a href="https://help.mikrotik.com/docs/display/ROS/IP+Settings#IPSettings-IPv6Settings" rel="nofollow">IPv6 Settings</a>.</em></p><p><em><sup>8</sup> IPv4 and IPv6 routing tables share the same hardware memory.</em></p><h3 class="auto-cursor-target" id="L3HardwareOffloading-Partialoffloading.1">Partial offloading</h3><p><span style="color:var(--ds-text,#333333);">The<span> </span></span><strong>DX8000/DX4000</strong><span style="color:var(--ds-text,#333333);"><span> </span>have entirely different routing tables. Instead of prefixes, we have to offload route indexes. The entire IPv4 address range (same for IPv6) must be indexed, i.e., 0.0.0.0 - 255.255.255.255. Adding new route entries causes index rebuild, increasing hardware memory by 0-5 entries depending on the complexity of the routing table. That's why no exact numbers are given. For example, some routing tables containing 240K entries can be fully offloaded to CRS317 HW, while others with 160K entries barely fit. And you will never know until you try.</span></p><p><span style="color:var(--ds-text,#333333);">When indexing the entire IP address range (0.0.0.0 - 255.255.255.255), you can offload as many routes as needed, as long as you also have a default route (0.0.0.0/0) using the same next-hop.<br/></span></p><p><span style="color:var(--ds-text,#333333);">For example, on a CCR2216 router around 950k routes with a /30 prefix are created, all using the same next-hop along with a default route. As a result, all routes were offloaded, while the lmp-usage remained minimal.<br/></span></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: routeros; gutter: false">[admin@MikroTik] &gt; interface/ethernet/switch/l3hw-settings/advanced/monitor 
        ipv4-routes-total: 942338
           ipv4-routes-hw: 942326
          ipv4-routes-cpu:     11
  ipv4-shortest-hw-prefix:      0
               ipv4-hosts:      1
         route-queue-size:      0
         route-queue-rate:      0
       route-process-rate:      0
              nexthop-cap:   8192
            nexthop-usage:     85
    vxlan-mtu-packet-drop:      0
     fasttrack-ipv4-conns:      0
     fasttrack-queue-size:      0
     fasttrack-queue-rate:      0
   fasttrack-process-rate:      0
   fasttrack-hw-min-speed:      0
   fasttrack-hw-offloaded:      0
    fasttrack-hw-unloaded:      0
                  lpm-cap:  27200
                lpm-usage:     11
             lpm-bank-cap:   1360
           lpm-bank-usage:      1
                                0
                                0
                                0
                                1
                                0
                                0
                                0
                                4
                                0
                                0
                                0
                                5
                                0
                                0
                                0
                                0
                                0
                                0
                                0
                  pbr-cap:   8192
                pbr-usage:      0
             pbr-lpm-bank:      2
                nat-usage:      0</pre>
</div></div><p><span style="color:var(--ds-text,#333333);"><span style="color:var(--ds-text,#333333);">However, if there are &quot;gaps&quot; in the address range, such as not using a default route or having multiple next-hops, this consumes HW table.<span> </span></span>When the routing HW table gets full, only routes with longer subnet prefixes are offloaded (/30, /29, /28, etc.) while the CPU processes the shorter prefixes. Here is what happens when the default route gets disabled or different next-hops are used: only 37k routes with a /30 prefix fit in the HW table. This is the worst-case scenario for the CCR2216.<br/></span></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: routeros; gutter: false">[admin@MikroTik] &gt; interface/ethernet/switch/l3hw-settings/advanced/monitor 
        ipv4-routes-total: 942337
           ipv4-routes-hw:  37729
          ipv4-routes-cpu: 904608
  ipv4-shortest-hw-prefix:     30
               ipv4-hosts:      1
         route-queue-size:      0
         route-queue-rate:      0
       route-process-rate:      0
              nexthop-cap:   8192
            nexthop-usage:     85
    vxlan-mtu-packet-drop:      0
     fasttrack-ipv4-conns:      0
     fasttrack-queue-size:      0
     fasttrack-queue-rate:      0
   fasttrack-process-rate:      0
   fasttrack-hw-min-speed:      0
   fasttrack-hw-offloaded:      0
    fasttrack-hw-unloaded:      0
                  lpm-cap:  27200
                lpm-usage:  22392
             lpm-bank-cap:   1360
           lpm-bank-usage:   1022
                             1033
                             1027
                             1028
                             1221
                             1033
                             1040
                              678
                             1358
                             1245
                             1254
                             1242
                             1246
                             1249
                             1273
                             1260
                             1101
                             1024
                             1031
                             1027
                  pbr-cap:   8192
                pbr-usage:      0
             pbr-lpm-bank:      2
                nat-usage:      0</pre>
</div></div><p><span style="color:var(--ds-text,#333333);">In many cases, the default behavior &quot;offloading only routes with longer subnet prefixes&quot; is not optimal, especially if the ratio of CPU-handled routes to HW-offloaded routes is too high. When this happens, the chances of a packet being hardware-forwarded drop significantly.</span></p><p><span style="color:var(--ds-text,#333333);">If HW memory is insufficient and partial offloading occurs, a better approach for you as a network administrator would be to offload only the routes that carry the most traffic while keeping less demanding routes on the CPU, and not letting the partial offloading to happen.</span></p><p><span style="color:var(--ds-text,#333333);"><span style="color:var(--ds-text,#333333);">Fortunately, there are several ways to manage this. There is per-switch-port and static route suppression, and<span> </span></span><a class="postlink" href="https://help.mikrotik.com/docs/spaces/ROS/pages/74678285/Route+Selection+and+Filters" rel="nofollow" style="text-decoration: none;">filtering dynamic routes using a wide range of attributes</a>. One example is to use as-path to filter most demanding prefixes (Google, Meta), while all other routes gets L3HW suppressed.</span></p>
                    </div>

                                        
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on May 20, 2025 14:53</p>
                    <div id="footer-logo"><a href="https://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
