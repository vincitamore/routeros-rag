<!DOCTYPE html>
<html>
    <head>
        <title>RouterOS : HWMPplus mesh</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">RouterOS</a></span>
                            </li>
                                                    <li>
                                <span><a href="RouterOS_328059.html">RouterOS</a></span>
                            </li>
                                                    <li>
                                <span><a href="Wireless_1409138.html">Wireless</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            RouterOS : HWMPplus mesh
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
    
        
    
        
        
            Created by <span class='author'> Unknown User (reinisjs)</span>, last updated by <span class='editor'> Normunds R.</span> on Oct 03, 2024
    
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <h1 id="HWMPplusmesh-Summary"><span class="mw-headline">Summary</span></h1><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface mesh</pre>
</div></div><p>HWMP+ is a MikroTik specific layer-2 routing protocol for wireless mesh networks. It is based on Hybrid Wireless Mesh Protocol (HWMP) from IEEE 802.11s draft standard. It can be used instead of (Rapid) Spanning Tree protocols in mesh setups to ensure loop-free optimal routing.</p><p>The HWMP+ protocol however is not compatible with HWMP from IEEE 802.11s draft standard.</p><p>Note that the distribution system you use for your network need not be a Wireless Distribution System (WDS). HWMP+ mesh routing supports not only WDS interfaces but also Ethernet interfaces inside the mesh. So you can use a simple Ethernet-based distribution system, or you can combine both WDS and Ethernet links!</p><div role="region" aria-label="Note" class="confluence-information-macro  confluence-information-macro-note" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p>HWMPplus is not supported on <a href="https://help.mikrotik.com/docs/display/ROS/WiFi" rel="nofollow"> Wifi </a>interfaces, but can be used on <a href="https://help.mikrotik.com/docs/display/ROS/Wireless+Interface" rel="nofollow">Wireless</a> interfaces.</p></div></div><h1 id="HWMPplusmesh-Properties">Properties</h1><h2 id="HWMPplusmesh-Mesh">Mesh</h2><div class="table-wrap"><table class="wrapped relative-table confluenceTable" style="width: 100.0%;"><colgroup><col style="width: 36.3733%;"/><col style="width: 63.5687%;"/></colgroup><tbody><tr><th class="confluenceTh">Property</th><th class="confluenceTh">Description</th></tr><tr><td class="confluenceTd"><strong>admin-mac </strong>(<em>MAC address</em>; <strong>Default: 00:00:00:00:00:00)</strong></td><td class="confluenceTd">Administratively assigned MAC address, used when the <strong>auto-mac</strong> setting is disabled</td></tr><tr><td class="confluenceTd"><strong>arp</strong> (<em>disabled | enabled | proxy-arp | reply-only</em>; Default: <strong>enabled</strong>)</td><td class="confluenceTd">Address Resolution Protocol setting</td></tr><tr><td colspan="1" class="confluenceTd"><strong>auto-mac</strong> (<em>boolean</em>; Default: <strong>no</strong>)</td><td colspan="1" class="confluenceTd">If disabled, then the value from <strong>admin-mac</strong> will be used as the MAC address of the mesh interface; else address of some port will be used if ports are present</td></tr><tr><td colspan="1" class="confluenceTd"><strong>hwmp-default-hoplimit</strong> (<em>integer: 1..255</em>; Default: )</td><td colspan="1" class="confluenceTd">Maximum hop count for generated routing protocol packets; after an HWMP+ packet is forwarded &quot;hoplimit&quot; times, it is dropped</td></tr><tr><td colspan="1" class="confluenceTd"><strong>hwmp-prep-lifetime</strong> (<em>time</em>; Default: <strong>5m</strong>)</td><td colspan="1" class="confluenceTd">Lifetime for routes created from received PREP or PREQ messages</td></tr><tr><td colspan="1" class="confluenceTd"><strong>hwmp-preq-destination-only</strong> (<em>boolean</em>; Default: <strong>yes</strong>)</td><td colspan="1" class="confluenceTd">Whether the only destination can respond to HWMP+ PREQ message</td></tr><tr><td colspan="1" class="confluenceTd"><strong>hwmp-preq-reply-and-forward</strong> (<em>boolean</em>; Default: <strong>yes</strong>)</td><td colspan="1" class="confluenceTd">Whether intermediate nodes should forward HWMP+ PREQ message after responding to it. Useful only when <strong>hwmp-preq-destination-only</strong> is disabled</td></tr><tr><td colspan="1" class="confluenceTd"><strong>hwmp-preq-retries</strong> (<em>integer</em>; Default: <strong>2</strong>)</td><td colspan="1" class="confluenceTd">How many times to retry a route discovery to a specific MAC address before the address is considered unreachable</td></tr><tr><td colspan="1" class="confluenceTd"><strong>hwmp-preq-waiting-time</strong> (<em>time</em>; Default: <strong>4s</strong>)</td><td colspan="1" class="confluenceTd">How long to wait for a response to the first PREQ message. Note that for subsequent PREQs the waiting time is increased exponentially</td></tr><tr><td colspan="1" class="confluenceTd"><strong>hwmp-rann-interval</strong> (<em>time</em>; Default: <strong>10s</strong>)</td><td colspan="1" class="confluenceTd">How often to send out HWMP+ RANN messages</td></tr><tr><td colspan="1" class="confluenceTd"><strong>hwmp-rann-lifetime</strong> (<em>time</em>; Default: <strong>1s</strong>)</td><td colspan="1" class="confluenceTd">Lifetime for routes created from received RANN messages</td></tr><tr><td colspan="1" class="confluenceTd"><strong>hwmp-rann-propagation-delay</strong> (<em>number</em>; Default: <strong>0.5</strong>)</td><td colspan="1" class="confluenceTd">How long to wait before propagating a RANN message. Value in seconds</td></tr><tr><td colspan="1" class="confluenceTd"><strong>mesh-portal</strong> (<em>boolean</em>; Default: <strong>no</strong>)</td><td colspan="1" class="confluenceTd">Whether this interface is a portal in the mesh network</td></tr><tr><td colspan="1" class="confluenceTd"><strong>mtu</strong> (<em>number</em>; Default: <strong>1500</strong>)</td><td colspan="1" class="confluenceTd">Maximum transmission unit size</td></tr><tr><td colspan="1" class="confluenceTd"><strong>name</strong> (<em>string</em>; Default: )</td><td colspan="1" class="confluenceTd">Interface name</td></tr><tr><td colspan="1" class="confluenceTd"><strong>reoptimize-paths</strong> (<em>boolean</em>; Default: <strong>no</strong>)</td><td colspan="1" class="confluenceTd">Whether to send out periodic PREQ messages asking for known MAC addresses. Turning on this setting is useful if the network topology is changing often. Note that if no reply is received to a re-optimization PREQ, the existing path is kept anyway (until it timeouts itself)</td></tr></tbody></table></div><h2 id="HWMPplusmesh-Port">Port</h2><div class="table-wrap"><table class="wrapped relative-table confluenceTable" style="width: 100.0%;"><colgroup><col style="width: 36.3733%;"/><col style="width: 63.5687%;"/></colgroup><tbody><tr><th class="confluenceTh">Property</th><th class="confluenceTh">Description</th></tr><tr><td class="confluenceTd"><strong>active-port-type</strong> (<em>read-only: wireless | WDS | ethernet-mesh | ethernet-bridge | ethernet-mixed</em>; Default: )</td><td class="confluenceTd">port type and state actually used</td></tr><tr><td colspan="1" class="confluenceTd"><strong>hello-interval</strong> (<em>time</em>; Default: <strong>10s</strong>)</td><td colspan="1" class="confluenceTd">the maximum interval between sending out HWMP+ Hello messages. Used only for Ethernet type ports</td></tr><tr><td colspan="1" class="confluenceTd"><strong>interface</strong> (<em>interface name</em>; Default: )</td><td colspan="1" class="confluenceTd">interface name, which is to be included in a mesh</td></tr><tr><td colspan="1" class="confluenceTd"><strong>mesh</strong> (<em>interface name</em>; Default: )</td><td colspan="1" class="confluenceTd">mesh interface this port belongs to</td></tr><tr><td colspan="1" class="confluenceTd"><strong>path-cost</strong> (<em>integer: 0..65535</em>; Default: <strong>10</strong>)</td><td colspan="1" class="confluenceTd">path cost to the interface, used by routing protocol to determine the 'best' path</td></tr><tr><td colspan="1" class="confluenceTd"><strong>port-type</strong> (<em>WDS | auto | ethernet | wireless</em>; Default: )</td><td colspan="1" class="confluenceTd">port type to use<ul><li>auto - port type is determined automatically based on the underlying interface's type</li><li>WDS - a Wireless Distribution System interface. Remote MAC address is learned from wireless connection data</li><li>ethernet - Remote MAC addresses are learned either from HWMP+ Hello messages or from source MAC addresses in received or forwarded traffic</li><li>wireless - Remote MAC addresses are learned from wireless connection data</li></ul></td></tr></tbody></table></div><h2 id="HWMPplusmesh-FDBStatus">FDB Status</h2><div class="table-wrap"><table class="wrapped relative-table confluenceTable" style="width: 100.0%;"><colgroup><col style="width: 36.4216%;"/><col style="width: 63.5204%;"/></colgroup><tbody><tr><th class="confluenceTh">Property</th><th class="confluenceTh">Description</th></tr><tr><td class="confluenceTd"><strong>mac-address</strong> (<em>MAC address</em>)</td><td class="confluenceTd">MAC address corresponding for this FDB entry</td></tr><tr><td colspan="1" class="confluenceTd"><strong>seq-number</strong> (<em>integer</em>)</td><td colspan="1" class="confluenceTd">sequence number used in routing protocol to avoid loops</td></tr><tr><td colspan="1" class="confluenceTd"><strong>type</strong> (<em>integer</em>)</td><td colspan="1" class="confluenceTd">sequence number used in routing protocol to avoid loops</td></tr><tr><td colspan="1" class="confluenceTd"><strong>interface</strong> (<em>local | outsider | direct | mesh | neighbor | larval | unknown</em>)</td><td colspan="1" class="confluenceTd">type of this FDB entry<ul><li>local -- MAC address belongs to the local router itself</li><li>outsider -- MAC address belongs to a device external to the mesh network</li><li>direct -- MAC address belongs to a wireless client on an interface that is in the mesh network</li><li>mesh -- MAC address belongs to a device reachable over the mesh network; it can be either internal or external to the mesh network</li><li>neighbor -- MAC address belongs to a mesh router that is a direct neighbor to this router</li><li>larval -- MAC address belongs to an unknown device that is reachable over the mesh network</li><li>unknown -- MAC address belongs to an unknown device</li></ul></td></tr><tr><td colspan="1" class="confluenceTd"><strong>mesh</strong> (<em>interface name</em>)</td><td colspan="1" class="confluenceTd">the mesh interface this FDB entry belongs to</td></tr><tr><td colspan="1" class="confluenceTd"><strong>on-interface</strong> (<em>interface name</em>)</td><td colspan="1" class="confluenceTd">mesh port used for traffic forwarding, kind of a next-hop value</td></tr><tr><td colspan="1" class="confluenceTd"><strong>lifetime</strong> (<em>time</em>)</td><td colspan="1" class="confluenceTd">time remaining to live if this entry is not used for traffic forwarding</td></tr><tr><td colspan="1" class="confluenceTd"><strong>age</strong> (<em>time</em>)</td><td colspan="1" class="confluenceTd">age of this FDB entry</td></tr><tr><td class="confluenceTd"><strong>metric</strong> (<em>integer</em>)</td><td class="confluenceTd">a metric value used by routing protocol to determine the 'best' path</td></tr></tbody></table></div><h1 id="HWMPplusmesh-Example"><span class="mw-headline">Example</span></h1><p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" draggable="false" src="attachments/8978441/16351267.jpg" data-image-src="attachments/8978441/16351267.jpg" data-unresolved-comment-count="0" data-linked-resource-id="16351267" data-linked-resource-version="2" data-linked-resource-type="attachment" data-linked-resource-default-alias="Mesh_ex1.jpg" data-base-url="https://help.mikrotik.com/docs" data-linked-resource-content-type="image/jpeg" data-linked-resource-container-id="8978441" data-linked-resource-container-version="20" tabindex="0" alt=""></span></p><p>This example uses static WDS links that are dynamically added as mesh ports when they become active. Two different frequencies are used: one for AP interconnections, and one for client connections to APs, so the AP must have at least two wireless interfaces. Of course, the same frequency for all connections also could be used, but that might not work as well because of potential interference issues.</p><p>Repeat this configuration on all APs:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">/interface mesh add disabled=no
/interface mesh port add interface=wlan1 mesh=mesh1
/interface mesh port add interface=wlan2 mesh=mesh1

 # interface used for AP interconnections 
/interface wireless set wlan1 disabled=no ssid=mesh frequency=2437 band=2ghz-b/g/n mode=ap-bridge \
 wds-mode=static-mesh wds-default-bridge=mesh1 

# interface used for client connections
 /interface wireless set wlan2 disabled=no ssid=mesh-clients frequency=5180 band=5ghz-a/n/ac mode=ap-bridge 

# a static WDS interface for each AP you want to connect to
/interface wireless wds add disabled=no master-interface=wlan1 name=&lt;descriptive name of remote end&gt; \
 wds-address=&lt;MAC address of remote end&gt; </pre>
</div></div><pre><br/></pre><p>Here WDS interface is added manually because static WDS mode is used. If you are using<span> </span><strong>wds-mode</strong>=<strong>dynamic-mesh</strong>, all WDS interfaces will be created automatically. The<span> </span><strong>frequency</strong><span> </span>and<span> </span><strong>band</strong><span> </span>parameters are specified here only to produce valid example configuration; mesh protocol operations are by no means limited to or optimized for, these particular values.</p><div role="region" aria-label="Note" class="confluence-information-macro  confluence-information-macro-note" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p>You may want to increase<span> the </span><strong>disconnect-timeout</strong><span> </span>wireless interface option to make the protocol more stable.</p></div></div><p>In real-world setups you also should take care of securing the wireless connections, using<span> </span><strong>/interface wireless security-profile</strong>. For simplicity, that configuration is not shown here.</p><p>Results on router A (there is one client connected to wlan2):</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">[admin@A] &gt; /interface mesh print
Flags: X - disabled, R - running
0 R name=&quot;mesh1&quot; mtu=1500 arp=enabled mac-address=00:0C:42:0C:B5:A4 auto-mac=yes
admin-mac=00:00:00:00:00:00 mesh-portal=no hwmp-default-hoplimit=32
hwmp-preq-waiting-time=4s hwmp-preq-retries=2 hwmp-preq-destination-only=yes
hwmp-preq-reply-and-forward=yes hwmp-prep-lifetime=5m hwmp-rann-interval=10s
hwmp-rann-propagation-delay=1s hwmp-rann-lifetime=22s

[admin@A] &gt; /interface mesh port print detail
Flags: X - disabled, I - inactive, D - dynamic
0 interface=wlan1 mesh=mesh1 path-cost=10 hello-interval=10s port-type=auto port-type-used=wireless
1 interface=wlan2 mesh=mesh1 path-cost=10 hello-interval=10s port-type=auto port-type-used=wireless
2 D interface=router_B mesh=mesh1 path-cost=105 hello-interval=10s port-type=auto port-type-used=WDS
3 D interface=router_D mesh=mesh1 path-cost=76 hello-interval=10s port-type=auto port-type-used=WDS</pre>
</div></div><p>The FDB (Forwarding Database) at the moment contains information only about local MAC addresses, non-mesh nodes reachable through a local interface, and direct mesh neighbors:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">[admin@A] /interface mesh fdb print
Flags: A - active, R - root
MESH TYPE MAC-ADDRESS ON-INTERFACE LIFETIME AGE
A mesh1 local 00:0C:42:00:00:AA 3m17s
A mesh1 neighbor 00:0C:42:00:00:BB router_B 1m2s
A mesh1 neighbor 00:0C:42:00:00:DD router_D 3m16s
A mesh1 direct 00:0C:42:0C:7A:2B wlan2 2m56s
A mesh1 local 00:0C:42:0C:B5:A4 2m56s

[admin@A] /interface mesh fdb print detail
Flags: A - active, R - root
A mac-address=00:0C:42:00:00:AA type=local age=3m21s mesh=mesh1 metric=0 seqnum=4294967196
A mac-address=00:0C:42:00:00:BB type=neighbor on-interface=router_B age=1m6s mesh=mesh1 metric=132 seqnum=4294967196
A mac-address=00:0C:42:00:00:DD type=neighbor on-interface=router_D age=3m20s mesh=mesh1 metric=79 seqnum=4294967196
A mac-address=00:0C:42:0C:7A:2B type=direct on-interface=wlan2 age=3m mesh=mesh1 metric=10 seqnum=0
A mac-address=00:0C:42:0C:B5:A4 type=local age=3m mesh=mesh1 metric=0 seqnum=0</pre>
</div></div><p>Test if ping works:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">[admin@A] &gt; /ping 00:0C:42:00:00:CC
00:0C:42:00:00:CC 64 byte ping time=108 ms
00:0C:42:00:00:CC 64 byte ping time=51 ms
00:0C:42:00:00:CC 64 byte ping time=39 ms
00:0C:42:00:00:CC 64 byte ping time=43 ms
4 packets transmitted, 4 packets received, 0% packet loss
round-trip min/avg/max = 39/60.2/108 ms</pre>
</div></div><p>Router A had to discover a path to Router C first, hence the slightly larger time for the first ping. Now the FDB also contains an entry for 00:0C:42:00:00:CC, with type &quot;mesh&quot;.</p><p>Also, test that ARP resolving works and so does IP level ping:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">[admin@A] &gt; /ping 10.4.0.3
10.4.0.3 64 byte ping: ttl=64 time=163 ms
10.4.0.3 64 byte ping: ttl=64 time=46 ms
10.4.0.3 64 byte ping: ttl=64 time=48 ms
3 packets transmitted, 3 packets received, 0% packet loss
round-trip min/avg/max = 46/85.6/163 ms</pre>
</div></div><h3 id="HWMPplusmesh-Meshtraceroute"><span class="mw-headline">Mesh traceroute</span></h3><p>There is also a mesh traceroute command, that can help you to determine which paths are used for routing.</p><p>For example, for this network:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">[admin@1] /interface mesh fdb print
Flags: A - active, R - root
MESH TYPE MAC-ADDRESS ON-INTERFACE LIFETIME AGE
A mesh1 local 00:0C:42:00:00:01 7m1s
A mesh1 mesh 00:0C:42:00:00:02 wds4 17s 4s
A mesh1 mesh 00:0C:42:00:00:12 wds4 4m58s 1s
A mesh1 mesh 00:0C:42:00:00:13 wds4 19s 2s
A mesh1 neighbor 00:0C:42:00:00:16 wds4 7m1s
A mesh1 mesh 00:0C:42:00:00:24 wds4 18s 3s</pre>
</div></div><p>Traceroute to 00:0C:42:00:00:12 shows:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">[admin@1] /interface mesh traceroute mesh1 00:0C:42:00:00:12
ADDRESS TIME STATUS
00:0C:42:00:00:16 1ms ttl-exceeded
00:0C:42:00:00:02 2ms ttl-exceeded
00:0C:42:00:00:24 4ms ttl-exceeded
00:0C:42:00:00:13 6ms ttl-exceeded
00:0C:42:00:00:12 6ms success</pre>
</div></div><h1 id="HWMPplusmesh-Protocoldescription"><span class="mw-headline">Protocol description</span></h1><h2 id="HWMPplusmesh-Reactivemode"><span class="mw-headline">Reactive mode</span></h2><p style="text-align: center;"><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" draggable="false" src="attachments/8978441/54853645.jpg" data-image-src="attachments/8978441/54853645.jpg" data-unresolved-comment-count="0" data-linked-resource-id="54853645" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="520px-Hwmp_reactive_a.jpg" data-base-url="https://help.mikrotik.com/docs" data-linked-resource-content-type="image/jpeg" data-linked-resource-container-id="8978441" data-linked-resource-container-version="20" tabindex="0" alt=""></span><br/>Router A wants to discover a path to C</p><p style="text-align: center;"><br/><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" draggable="false" src="attachments/8978441/54853646.jpg" data-image-src="attachments/8978441/54853646.jpg" data-unresolved-comment-count="0" data-linked-resource-id="54853646" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="520px-Hwmp_reactive_b.jpg" data-base-url="https://help.mikrotik.com/docs" data-linked-resource-content-type="image/jpeg" data-linked-resource-container-id="8978441" data-linked-resource-container-version="20" tabindex="0" alt=""></span></p><p style="text-align: center;">Router C sends a unicast response to A</p><p>In reactive mode, HWMP+ is very much like AODV (Ad-hoc On-demand Distance Vector). All paths are discovered on-demand, by flooding Path Request (PREQ) message in the network. The destination node or some router that has a path to the destination will reply with a Path Response (PREP). Note that if the destination address belongs to a client, the AP this client is connected to will serve as a proxy for him (i.e. reply to PREQs on his behalf).</p><p>This mode is best suited for mobile networks, and/or when most of the communication happens between intra-mesh nodes.</p><h2 id="HWMPplusmesh-Proactivemode"><span class="mw-headline">Proactive mode</span></h2><p style="text-align: center;"><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" draggable="false" src="attachments/8978441/54853647.jpg" data-image-src="attachments/8978441/54853647.jpg" data-unresolved-comment-count="0" data-linked-resource-id="54853647" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="Hwmp_proactive_a.jpg" data-base-url="https://help.mikrotik.com/docs" data-linked-resource-content-type="image/jpeg" data-linked-resource-container-id="8978441" data-linked-resource-container-version="20" tabindex="0" alt=""></span><br/>The root announces itself by flooding RANN</p><p><br/></p><p style="text-align: center;"><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" draggable="false" src="attachments/8978441/54853648.jpg" data-image-src="attachments/8978441/54853648.jpg" data-unresolved-comment-count="0" data-linked-resource-id="54853648" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="Hwmp_proactive_b.jpg" data-base-url="https://help.mikrotik.com/docs" data-linked-resource-content-type="image/jpeg" data-linked-resource-container-id="8978441" data-linked-resource-container-version="20" tabindex="0" alt=""></span><br/>Internal nodes respond with PREGs</p><p>In proactive mode, there are some routers configured as portals. In general, being a portal means that the router has interfaces to some other network, i.e. it is an entry/exit point to the mesh network.</p><p>The portals will announce their presence by flooding the Root Announcement (RANN) message in the network. Internal nodes will reply with a Path Registration (PREG) message. The result of this process will be routing trees with roots in the portal.</p><p>Routes to portals will serve as a kind of default route. If an internal router does not know the path to a particular destination, it will forward all data to its closest portal. The portal will then discover the path on behalf of the router if needed. The data afterward will flow through the portal. This may lead to sub-optimal routing unless the data is addressed to the portal itself or some external network the portals have interfaces to.</p><p>A proactive mode is best suited when most of the traffic goes between internal mesh nodes and a few portal nodes.</p><h2 id="HWMPplusmesh-Topologychangedetection"><span class="mw-headline">Topology change detection</span></h2><p style="text-align: center;"><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" draggable="false" src="attachments/8978441/54853649.jpg" data-image-src="attachments/8978441/54853649.jpg" data-unresolved-comment-count="0" data-linked-resource-id="54853649" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="Hwmp_error_a.jpg" data-base-url="https://help.mikrotik.com/docs" data-linked-resource-content-type="image/jpeg" data-linked-resource-container-id="8978441" data-linked-resource-container-version="20" tabindex="0" alt=""></span><br/>Data flow path</p><p style="text-align: center;"><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" draggable="false" src="attachments/8978441/54853650.jpg" data-image-src="attachments/8978441/54853650.jpg" data-unresolved-comment-count="0" data-linked-resource-id="54853650" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="Hwmp_error_b.jpg" data-base-url="https://help.mikrotik.com/docs" data-linked-resource-content-type="image/jpeg" data-linked-resource-container-id="8978441" data-linked-resource-container-version="20" tabindex="0" alt=""></span><br/>After the link disappears, an error is propagated upstream</p><p>HWMP+ uses Path Error (PERR) message to notify that a link has disappeared. The message is propagated to all upstream nodes up to the data source. The source on PERR reception restarts the path discovery process.</p><h1 id="HWMPplusmesh-FAQ"><span class="mw-headline">FAQ</span></h1><p><strong>Q. How is this better than RSTP?</strong></p><p>A. It gives you optimal routing. RSTP is only for loop prevention.</p><p><strong>Q. How the route selection is done?</strong></p><p>A. The route with the best metric is always selected after the discovery process. There is also a configuration option to periodically reoptimize already known routes.</p><p>Route metric is calculated as the sum of individual link metrics.</p><p>Link metric is calculated in the same way as for (R)STP protocols:</p><ul><li>For Ethernet links the metric is configured statically (same as for OSPF, for example).</li><li>For WDS links the metric is updated dynamically depending on actual link bandwidth, which in turn is influenced by wireless signal strength, and the selected data transfer rate.</li></ul><p>Currently, the protocol does not take into account the amount of bandwidth being used on a link, but that might be also used in the future.</p><p><strong>Q. How is this better than OSPF/RIP/layer-3 routing in general?</strong></p><p>A. WDS networks usually are bridged, not routed. The ability to self-configure is important for mesh networks, and routing generally requires much more configuration than bridging. Of course, you can always run any L3 routing protocol over a bridged network, but for mesh networks that usually makes little sense.<span> </span></p><div role="region" aria-label="Note" class="confluence-information-macro  confluence-information-macro-note" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p> Since optimized layer-2 multicast forwarding is not included in the mesh protocol, it is better to avoid forwarding any multicast traffic (including OSPF) over meshed networks. If you need OSPF, then you have to configure <a class="external-link" href="https://wiki.mikrotik.com/wiki/OSPF-reference#NBMA_Neighbor" rel="nofollow">OSPF NBMA</a> neighbors that use unicast mode instead.</p></div></div><p><strong>Q. What about performance/CPU requirements?</strong></p><p>A. The protocol itself, when properly configured, will take much fewer resources than OSPF (for example) would. Data forwarding performance on an individual router should be close to that of bridging.</p><p><strong>Q. How does it work together with existing mesh setups that are using RSTP?</strong></p><p>A. The internal structure of an RSTP network is transparent to the mesh protocol (because mesh hello packets are forwarded inside the RSTP network). The mesh will see the path between two entry points in the RSTP network as a single segment. On the other hand, a mesh network is not transparent to the RSTP, since RSTP hello packets are not be forwarded inside the mesh network.<span> </span><em>(This is the behavior since v3.26)</em></p><p><br/></p><div role="region" aria-label="Warning" class="confluence-information-macro  confluence-information-macro-warning" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-error confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p>Routing loops are possible if a mesh network is attached to an RSTP network in two or more points!</p></div></div><p><br/></p><p>Note that if you have a WDS link between two access points, then both ends must have the same configuration (either as ports in a mesh on both ends or as ports in a bridge interface on both ends).</p><p>You can also put a bridge interface as a mesh port (to be able to use a bridge firewall, for example).</p><p><strong>Q. Can I have multiple entry/exit points to the network?</strong></p><p>A. If the entry/exit points are configured as portals (i.e. proactive mode is used), each router inside the mesh network will select its closest portal and forward all data to it. The portal will then discover a path on behalf of the router if needed.</p><p><strong>Q. How to control or filter mesh traffic?</strong></p><p>A. At the moment the only way is to use a bridge firewall. Create a bridge interface, put the WDS interfaces and/or Ethernets in that bridge, and put that bridge in a mesh interface. Then configure bridge firewall rules.</p><p>To match MAC protocol used for mesh traffic encapsulation, use MAC protocol number 0x9AAA, and to match mesh routing traffic, use MAC protocol number 0x9AAB. Example:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: ros; gutter: false">interface bridge settings set use-ip-firewall=yes 
interface bridge filter add chain=input action=log mac-protocol=0x9aaa 
interface bridge filter add chain=input action=log mac-protocol=0x9aab</pre>
</div></div><div role="region" aria-label="Note" class="confluence-information-macro  confluence-information-macro-note" ><span role="presentation" class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon" ></span><div class="confluence-information-macro-body"><p>It is perfectly possible to create mixed mesh/bridge setups that will not work (e.g.<span> </span><em>Problematic example 1</em><span> </span>with bridge instead of a switch). The recommended fail-safe way that will always work is to create a separate bridge interface per each of the physical interfaces; then add all these bridge interfaces as mesh ports.</p></div></div><h1 id="HWMPplusmesh-Advancedtopics"><span class="mw-headline">Advanced topics</span></h1><p>We all know that it's easy to make problematic layer-2 bridging or routing setups and it can be hard to debug them. (Compared to layer-3 routing setups.) So here are a few bad configuration examples that could create problems for you. Avoid them!</p><h2 id="HWMPplusmesh-Problematicexample1:Ethernetswitchinsideamesh"><span class="mw-headline">Problematic example 1: Ethernet switch inside a mesh</span></h2><p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" draggable="false" src="attachments/8978441/16351283.jpg" data-image-src="attachments/8978441/16351283.jpg" data-unresolved-comment-count="0" data-linked-resource-id="16351283" data-linked-resource-version="2" data-linked-resource-type="attachment" data-linked-resource-default-alias="Mesh_bad_ex1.jpg" data-base-url="https://help.mikrotik.com/docs" data-linked-resource-content-type="image/jpeg" data-linked-resource-container-id="8978441" data-linked-resource-container-version="20" tabindex="0" alt=""></span></p><p><em>Router A is outside the mesh, all the rest of the routers are inside. For routers B, C, D all interfaces are added as mesh ports.</em></p><p>Router A will not be able to communicate reliably with router C. The problem manifests itself when D is the designated router for Ethernet; if B takes this role, everything is OK. The main cause of the problem is MAC address learning on Ethernet switch.</p><p>Consider what happens when router A wants to send something to C. We suppose router A either knows or floods data to all interfaces. Either way, data arrives at the switch. The switch, not knowing anything about the destination's MAC address, forwards the data to both B and D.</p><p>What happens now:</p><ol><li>B receives the packet on a mesh interface. Since the MAC address is not local for B and B knows that he is not the designated router for the Ethernet network, he simply ignores the packet.</li><li>D receives the packet on a mesh interface. Since the MAC address is not local for B and D is the designated router for the Ethernet network, he initiates the path discovery process to C.</li></ol><p>After path discovery is completed, D has information that C is reachable over B. Now D encapsulates the packet and forwards it back to the Ethernet network. The encapsulated packet is forwarded by the switch, received and forwarded by B, and received by C. So far everything is good.</p><p>Now C is likely to respond to the packet. Since B already knows where A is, he will decapsulate and forward the reply packet. But now the switch will learn that the MAC address of C is reachable through B! That means, next time when something arrives from A addressed to C, the switch will forward data<span> </span><em>only</em><span> </span>to B (and B, of course, will silently ignore the packet)!</p><p>In contrast, if B took up the role of a designated router, everything would be OK, because traffic would not have to go through the Ethernet switch twice.</p><p><em><strong>Troubleshooting</strong></em>: either avoid such setup or disable MAC address learning on the switch. Note that on many switches that is not possible.</p><p>Also note that there will be no problem, if either:</p><ul><li>router A supports and is configured to use HWMP+;</li><li>or Ethernet switch is replaced with a router that supports HWMP+ and has Ethernet interfaces added as mesh ports.</li></ul><h2 id="HWMPplusmesh-Problematicexample2:wirelessmodes"><span class="mw-headline">Problematic example 2: wireless modes</span></h2><p><em>Consider this (invalid) setup example</em>:</p><p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" draggable="false" src="attachments/8978441/16351284.jpg" data-image-src="attachments/8978441/16351284.jpg" data-unresolved-comment-count="0" data-linked-resource-id="16351284" data-linked-resource-version="2" data-linked-resource-type="attachment" data-linked-resource-default-alias="Mesh_bad_ex2.jpg" data-base-url="https://help.mikrotik.com/docs" data-linked-resource-content-type="image/jpeg" data-linked-resource-container-id="8978441" data-linked-resource-container-version="20" tabindex="0" alt=""></span></p><p><em>Routers A and B are inside the mesh, router C: outside. For routers A and B all interfaces are added as mesh ports.</em></p><p>It is not possible to bridge wlan1 and wlan2 on router B now. The reason for this is pretty obvious if you understand how WDS works. For WDS communications four address frames are used. This is because for wireless multihop forwarding you need to know both the addresses of the intermediate hops, as well as the original sender and final receiver. In contrast, non-WDS 802.11 communication includes only three MAC addresses in a frame. That's why it's not possible to do multi-hop forwarding in station mode.</p><p><em><strong>Troubleshooting</strong></em>: depends on what you want to achieve:</p><ol><li>If you want router C to act as a repeater either for wireless or Ethernet traffic, configure the WDS link between router B and router C, and run mesh routing protocol on all nodes.</li><li>In other cases configure wlan2 on router B in AP mode and WLAN on router C in station mode.</li></ol><p><br/></p>
                    </div>

                                                            <div class="pageSection group">
                        <div class="pageSectionHeader">
                            <h2 id="attachments" class="pageSectionTitle">Attachments:</h2>
                        </div>

                        <div class="greybox" align="left">
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/8978441/54853644.jpg">Mesh_ex1.jpg</a> (image/jpeg)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/8978441/16351268.png">520px-Hwmp_reactive_a.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/8978441/16351270.png">520px-Hwmp_reactive_b.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/8978441/16351275.png">Hwmp_proactive_a.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/8978441/16351276.png">Hwmp_proactive_b.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/8978441/16351278.png">Hwmp_error_a.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/8978441/16351279.png">Hwmp_error_b.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/8978441/54853651.jpg">Mesh_bad_ex1.jpg</a> (image/jpeg)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/8978441/54853652.jpg">Mesh_bad_ex2.jpg</a> (image/jpeg)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/8978441/16351267.jpg">Mesh_ex1.jpg</a> (image/jpeg)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/8978441/54853645.jpg">520px-Hwmp_reactive_a.jpg</a> (image/jpeg)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/8978441/54853646.jpg">520px-Hwmp_reactive_b.jpg</a> (image/jpeg)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/8978441/54853647.jpg">Hwmp_proactive_a.jpg</a> (image/jpeg)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/8978441/54853648.jpg">Hwmp_proactive_b.jpg</a> (image/jpeg)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/8978441/54853649.jpg">Hwmp_error_a.jpg</a> (image/jpeg)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/8978441/54853650.jpg">Hwmp_error_b.jpg</a> (image/jpeg)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/8978441/16351283.jpg">Mesh_bad_ex1.jpg</a> (image/jpeg)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/8978441/16351284.jpg">Mesh_bad_ex2.jpg</a> (image/jpeg)
                                <br/>
                                                    </div>
                    </div>
                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on May 20, 2025 14:53</p>
                    <div id="footer-logo"><a href="https://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
